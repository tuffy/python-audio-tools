%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{WavPack}
WavPack is a format for compressing Wave files, typically in lossless mode.
Notably, it also has a lossy mode and even a hybrid mode which allows
the `correction' file to be separated from a lossy core.

Metadata is stored as an APEv2 tag, which is described on page \pageref{apev2}.

Its stream of data is stored little-endian, as described on page
\pageref{bitstreams}.

\section{the WavPack file stream}
\begin{figure}[h]
\includegraphics{figures/wavpack_stream.pdf}
\end{figure}

\clearpage

\section{the WavPack block header}
\begin{figure}[h]
\includegraphics{figures/wavpack_block_header.pdf}
\end{figure}
\begin{wrapfigure}[10]{r}{1.5in}
\begin{tabular}{|c|r|}
\hline
value & sample rate \\
\hline
\texttt{0000} & 6000 \\
\texttt{0001} & 8000 \\
\texttt{0010} & 9600 \\
\texttt{0011} & 11025 \\
\texttt{0100} & 12000 \\
\texttt{0101} & 16000 \\
\texttt{0110} & 22050 \\
\texttt{0111} & 24000 \\
\texttt{1000} & 32000 \\
\texttt{1001} & 44100 \\
\texttt{1010} & 48000 \\
\texttt{1011} & 64000 \\
\texttt{1100} & 88200 \\
\texttt{1101} & 96000 \\
\texttt{1110} & 192000 \\
\texttt{1111} & reserved \\
\hline
\end{tabular}
\end{wrapfigure}

\VAR{Block Size} is the length of everything in the block past
the \VAR{Block Size} field itself -
or everything in the block past the CRC, minus 24 bytes.

\VAR{Bits per Sample} is one of 4 values:

\begin{inparaenum}
\item[\texttt{00} = ] 8 bps,
\item[\texttt{01} = ] 16 bps,
\item[\texttt{10} = ] 24 bps,
\item[\texttt{11} = ] 32 bps
\end{inparaenum}
.

\VAR{Mono Output} bit indicates the channel count.
If 1, this block has 1 channel.
If 0, this block has 2 channels.
For an audio stream with more than 2 channels,
check the \VAR{Initial Block} and \VAR{Final Block} bits to indicate
the start and end of the channels.  As an example:

\begin{tabular}{c|c|c|c}
Initial Block & Final Block & Mono Output & Channels \\
\hline
1 & 0 & 0 & 2 \\
0 & 0 & 1 & 1 \\
0 & 0 & 1 & 1 \\
0 & 1 & 0 & 2 \\
\hline
\multicolumn{3}{r|}{Total} & 6
\end{tabular}

\clearpage

\subsection{WavPack sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_subblock_header.pdf}
\end{figure}
\par
\noindent
If the \VAR{Large Block} field is 0, the \VAR{Block Size} field is 8 bits long.
If it is 1, the \VAR{Block Size} field is 24 bits long.
The \VAR{Block Size} field is the length of \VAR{Block Data}, in 16-bit
words rather than bytes.
If \VAR{Actual Size 1 Less} is set, that means \VAR{Block Data} doesn't contain
an even number of bytes; it is padded with a single null byte at the
end in order to fit.
If \VAR{Nondecoder Data} is set, that means the decoder does not have
to understand the contents of this particular sub-block in
order to decode the audio.

\clearpage

\section{WavPack decoding}
The general principle of WavPack decoding is that we take the
values from several sub-blocks as decoder ``arguments''
and then decode one or two channels of audio per block.
If the file contains more than two channels, we combine the output
of several blocks into a single chunk of output data.

\subsection{the Decorrelation Terms sub-block}
\label{wavpack_decorr_terms}
\begin{figure}[h]
\includegraphics{figures/wavpack_decorr_terms.pdf}
\end{figure}
\par
\noindent
The number of decorrelation terms and deltas
equals the \VAR{Block Size} times 2, and minus 1 if
\VAR{Actual Size 1 Less} is set.
Each term and delta pair is 8 bits and stored in \textit{reverse} order.
In addition, one must subtract 5 from the stored value of each
unsigned term to get its actual value.

For example, given the complete sub-block bytes:
\begin{Verbatim}[frame=single]
42 03 57 57 47 56 48 00
\end{Verbatim}
we have a total of 5 term/delta pairs whose values are as follows:
\begin{table}[h]
\begin{tabular}{r r | r r}
$\text{Decorrelation Term}_5$ & \texttt{0x17} - 5 = 18 & $\text{Decorrlation Delta}_5$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_4$ & \texttt{0x17} - 5 = 18 & $\text{Decorrlation Delta}_4$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_3$ & \texttt{0x07} - 5 = 2 & $\text{Decorrlation Delta}_3$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_2$ & \texttt{0x16} - 5 = 17 & $\text{Decorrlation Delta}_2$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_1$ & \texttt{0x08} - 5 = 3 & $\text{Decorrlation Delta}_1$ & \texttt{0x2} = 2 \\
\end{tabular}
\end{table}
\par
\noindent
Remember that this is a little-endian stream and that the least-significant
bits (the \VAR{Decorrelation Delta} value) are on the left side of each byte.

\clearpage

\subsection{the Decorrelation Weights sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_decorr_weights.pdf}
\end{figure}
\par
\noindent
As with the decorrelations terms sub-block,
the decorrelation weights are stored in reverse order.
The number of weights stored can be determined from the sub-block's
size.
Each is stored in a signed, 8-bit field and interleaved between
channels in the case of 2 channel blocks.
For example, $\text{Decorrelation Weight}_1$ is for channel \VAR{B},
$\text{Decorrelation Weight}_2$ is for channel
\VAR{A}\footnote{Why \VAR{A} and \VAR{B}?
Since a block may be only two channels out of many,
it makes sense not to number them to avoid ambiguity.},
$\text{Decorrelation Weight}_3$ is for channel \VAR{B} and so on
such that the first value will be for the highest
\VAR{Decorrelation Weight A}.
Converting the 8-bit values to the actual decorrelation weights
requires the following formula:
\begin{equation*}
\text{Decorrelation Weight} =
\begin{cases}
\text{value} \times 2 ^ 3 + \left\lfloor\frac{\text{value} \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor & \text{if value} > 0 \\
0 & \text{if value} = 0 \\
\text{value} \times 2 ^ 3 & \text{if value} < 0
\end{cases}
\end{equation*}
\par
\noindent
For example, given a 2 channel block with 5 decorrelation terms and the
sub-block bytes:
\begin{Verbatim}[frame=single]
06 06 06 06 04 04 06 06 02 03
\end{Verbatim}
our \VAR{Decorrelation Weights} are as follows:
\begin{table}[h]
\begin{tabular}{r r | r r}
$\text{Weight A}_5$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_5$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_4$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_4$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_3$ & $4 \times 2 ^ 3 + \left\lfloor\frac{4 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 32 & $\text{Weight B}_3$ & $4 \times 2 ^ 3 + \left\lfloor\frac{4 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 32 \\
$\text{Weight A}_2$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_2$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_1$ & $2 \times 2 ^ 3 + \left\lfloor\frac{2 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 16 & $\text{Weight B}_1$ & $3 \times 2 ^ 3 + \left\lfloor\frac{3 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 24 \\
\end{tabular}
\end{table}
\par
\noindent
Note that decoding a WavPack file requires having the same
number of \VAR{Decorrelation Weight} values, per channel, as
\VAR{Decorrelation Terms} values.
However, this block may contain less.
In that event, those low weight values are set to 0.

\clearpage

\subsection{the Decorrelation Samples sub-block}
\label{wavpack_decorr_samples}
\begin{figure}[h]
\includegraphics{figures/wavpack_decorr_samples.pdf}
\end{figure}
\par
\noindent
The decorrelation samples values are stored as signed, 16-bit values.
Converting them to sample values requires the following formula:
\begin{equation*}
\text{Sample} =
\begin{cases}
\lfloor \text{wv\_exp2}(value \bmod{256}) \div 2 ^ {9 - \lfloor value \div 2 ^ 8 \rfloor} \rfloor & \text{if } 0 \leq value \leq 2304 \\
\text{wv\_exp2}(value \bmod{256}) \times 2 ^ {\lfloor value \div 2 ^ 8 \rfloor - 9} & \text{if } 2304 < value \leq 32767 \\
-\lfloor \text{wv\_exp2}(-value \bmod{256}) \div 2 ^ {9 - \lfloor -value \div 2 ^ 8 \rfloor} \rfloor & \text{if } -2304 \leq value < 0 \\
-(\text{wv\_exp2}(-value \bmod{256}) \times 2 ^ {\lfloor -value \div 2 ^ 8 \rfloor - 9}) & \text{if } -32768 \leq value < -2304
\end{cases}
\end{equation*}
\par
\noindent
where \VAR{wv\_exp2} is defined from the following base-16 table:
\par
\noindent
{\relsize{-3}\ttfamily
\begin{tabular}{| c | c | c | c | c | c | c | c | c | c | c | c | c | c | c | c | c |}
\hline
& 0x?0 & 0x?1 & 0x?2 & 0x?3 & 0x?4 & 0x?5 & 0x?6 & 0x?7 & 0x?8 & 0x?9 & 0x?A & 0x?B & 0x?C & 0x?D & 0x?E & 0x?F \\
\hline
0x0? & 100 & 101 & 101 & 102 & 103 & 103 & 104 & 105 & 106 & 106 & 107 & 108 & 108 & 109 & 10A & 10B \\
0x1? & 10B & 10C & 10D & 10E & 10E & 10F & 110 & 110 & 111 & 112 & 113 & 113 & 114 & 115 & 116 & 116 \\
0x2? & 117 & 118 & 119 & 119 & 11A & 11B & 11C & 11D & 11D & 11E & 11F & 120 & 120 & 121 & 122 & 123 \\
0x3? & 124 & 124 & 125 & 126 & 127 & 128 & 128 & 129 & 12A & 12B & 12C & 12C & 12D & 12E & 12F & 130 \\
0x4? & 130 & 131 & 132 & 133 & 134 & 135 & 135 & 136 & 137 & 138 & 139 & 13A & 13A & 13B & 13C & 13D \\
0x5? & 13E & 13F & 140 & 141 & 141 & 142 & 143 & 144 & 145 & 146 & 147 & 148 & 148 & 149 & 14A & 14B \\
0x6? & 14C & 14D & 14E & 14F & 150 & 151 & 151 & 152 & 153 & 154 & 155 & 156 & 157 & 158 & 159 & 15A \\
0x7? & 15B & 15C & 15D & 15E & 15E & 15F & 160 & 161 & 162 & 163 & 164 & 165 & 166 & 167 & 168 & 169 \\
0x8? & 16A & 16B & 16C & 16D & 16E & 16F & 170 & 171 & 172 & 173 & 174 & 175 & 176 & 177 & 178 & 179 \\
0x9? & 17A & 17B & 17C & 17D & 17E & 17F & 180 & 181 & 182 & 183 & 184 & 185 & 187 & 188 & 189 & 18A \\
0xA? & 18B & 18C & 18D & 18E & 18F & 190 & 191 & 192 & 193 & 195 & 196 & 197 & 198 & 199 & 19A & 19B \\
0xB? & 19C & 19D & 19F & 1A0 & 1A1 & 1A2 & 1A3 & 1A4 & 1A5 & 1A6 & 1A8 & 1A9 & 1AA & 1AB & 1AC & 1AD \\
0xC? & 1AF & 1B0 & 1B1 & 1B2 & 1B3 & 1B4 & 1B6 & 1B7 & 1B8 & 1B9 & 1BA & 1BC & 1BD & 1BE & 1BF & 1C0 \\
0xD? & 1C2 & 1C3 & 1C4 & 1C5 & 1C6 & 1C8 & 1C9 & 1CA & 1CB & 1CD & 1CE & 1CF & 1D0 & 1D2 & 1D3 & 1D4 \\
0xE? & 1D6 & 1D7 & 1D8 & 1D9 & 1DB & 1DC & 1DD & 1DE & 1E0 & 1E1 & 1E2 & 1E4 & 1E5 & 1E6 & 1E8 & 1E9 \\
0xF? & 1EA & 1EC & 1ED & 1EE & 1F0 & 1F1 & 1F2 & 1F4 & 1F5 & 1F6 & 1F8 & 1F9 & 1FA & 1FC & 1FD & 1FF \\
\hline
\end{tabular}
}
\par
\noindent
For example, given the sub-frame bytes:
\begin{Verbatim}[frame=single]
04 04 CF F8 B7 F8 CF 05 B3 05
\end{Verbatim}
our \VAR{Decorrelation Sample} values are:
\begin{align*}
\text{Sample}_1 &= \texttt{0xF8CF} = -1841
 = -\lfloor \text{wv\_exp2}(1841 \bmod{256}) \div 2 ^ {9 - \lfloor 1841 \div 2 ^ 8 \rfloor} \rfloor \\
&= -\lfloor \text{wv\_exp2}(49) \div 2 ^ {9 - 7} \rfloor
 = -\lfloor 292 \div 4 \rfloor = \textbf{-73} \\
\text{Sample}_2 &= \texttt{0xF8B7} = -1865
 = -\lfloor \text{wv\_exp2}(1865 \bmod{256}) \div 2 ^ {9 - \lfloor 1865 \div 2 ^ 8 \rfloor} \rfloor \\
&= -\lfloor \text{wv\_exp2}(73) \div 2 ^ {9 - 7} \rfloor
 =  -\lfloor 312 \div 4 \rfloor = \textbf{-78} \\
\text{Sample}_3 &= \texttt{0x05CF} = 1487
 = \lfloor \text{wv\_exp2}(1487 \bmod{256}) \div 2 ^ {9 - \lfloor 1487 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(207) \div 2 ^ {9 - 5} \rfloor
 = \lfloor 448 \div 16 \rfloor = \textbf{28} \\
\text{Sample}_4 &= \texttt{0x05B3} = 1459
 = \lfloor \text{wv\_exp2}(1459 \bmod{256}) \div 2 ^ {9 - \lfloor 1459 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(179) \div 2 ^ {9 - 5} \rfloor
 = \lfloor 416 \div 16 \rfloor = \textbf{26}
\end{align*}

\clearpage

We're not done yet, however.
The next step is to determine which \VAR{Decorrelation Sample}
values correspond to which \VAR{Decorrelation Term}\footnote{As
extracted on page \pageref{wavpack_decorr_terms}}.

TODO

%% This portion is on-hold until I sort out how the decorrelation samples
%% are used in the decoding process.  Although the unpacker treats them
%% as lists of lists, WavPack's decorrelation passes seem to treat them
%% like Shorten-style wrapped samples.  If so, this will affect how
%% I describe their assignment process.

\clearpage

\subsection{the Entropy Variables sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_entropy_vars.pdf}
\end{figure}
\par
\noindent
If a block is mono, this sub-block contains 3 \VAR{Entropy Variables}.
If a block is stereo, this sub-block contains 6.
Each is stored as a signed, 16-bit value which is packed in
the same fashion as \VAR{Decorrelation Samples}\footnote{As described
on page \pageref{wavpack_decorr_samples}.}.
For example, given a 2 channel block with the sub-block bytes:
\begin{Verbatim}[frame=single]
05 06 e2 07 9b 08 55 09 e2 07 76 08 ba 08
\end{Verbatim}
our \VAR{Entropy Variables} are:
\begin{align*}
\text{Entropy Variable A}_1 &= \texttt{0x07E2} = 2018 = \lfloor \text{wv\_exp2}(2018 \bmod{256}) \div 2 ^ {9 - \lfloor 2018 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(226) \div 2 ^ {9 - 7} \rfloor
 = \lfloor 472 \div 4 \rfloor = \textbf{118} \\
\text{Entropy Variable A}_2 &= \texttt{0x089B} = 2203 = \lfloor \text{wv\_exp2}(2203 \bmod{256}) \div 2 ^ {9 - \lfloor 2203 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(155) \div 2 ^ {9 - 8} \rfloor
 = \lfloor 389 \div 2 \rfloor = \textbf{194} \\
\text{Entropy Variable A}_3 &= \texttt{0x0955} = 2389 = \text{wv\_exp2}(2389 \bmod{256}) \times 2 ^ {\lfloor 2389 \div 2 ^ 8 \rfloor - 9} \\
&= \text{wv\_exp2}(85) \times 2 ^ {9 - 9} = 322 \times 1 = \textbf{322} \\
\text{Entropy Variable B}_1 &= \texttt{0x07E2} = 2018 = \lfloor \text{wv\_exp2}(2018 \bmod{256}) \div 2 ^ {9 - \lfloor 2018 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(226) \div 2 ^ {9 - 7} \rfloor
 = \lfloor 472 \div 4 \rfloor = \textbf{118} \\
\text{Entropy Variable B}_2 &= \texttt{0x0876} = 2166 = \lfloor \text{wv\_exp2}(2166 \bmod{256}) \div 2 ^ {9 - \lfloor 2166 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(118) \div 2 ^ {9 - 8} \rfloor = \lfloor 352 \div 2 \rfloor = \textbf{176} \\
\text{Entropy Variable B}_3 &= \texttt{0x08BA} = 2234 = \lfloor \text{wv\_exp2}(2234 \bmod{256}) \div 2 ^ {9 - \lfloor 2234 \div 2 ^ 8 \rfloor} \rfloor \\
&= \lfloor \text{wv\_exp2}(186) \div 2 ^ {9 - 8} \rfloor
 = \lfloor 424 \div 2 \rfloor = \textbf{212}
\end{align*}

\clearpage
\subsection{the Bitstream sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_bitstream.pdf}
\end{figure}
\par
\noindent

Decoding the \VAR{Bitstream} sub-block requires the \VAR{Entropy Variables}
data which it combines with this sub-block's bitstream to yield a set of signed
values totalling \VAR{Block Samples}, times 2 if the block is stereo.

Decoding each value is a complex process which I'll divide into
three separate phases.

As an example, we'll use a 1-channel block with the entropy variables:
\begin{itemize}
\item $\text{Entropy Variable A}_1$ = 111
\item $\text{Entropy Variable A}_1$ = 159
\item $\text{Entropy Variable A}_1$ = 299
\end{itemize}
and we'll use the partial sub-block bytes:
\begin{Verbatim}[frame=single]
8a 0e 00 00 a1 77 e9
\end{Verbatim}
The first four bytes are the header and block size values.
The remaining three are as follows as a little-endian stream:
\begin{Verbatim}[frame=single]
1 0 0 0 0 1 0 1  1 1 1 0 1 1 1 0  1 0 0 1 0 1 1 1
\end{Verbatim}

\clearpage
\subsubsection{Determining t}
\begin{wrapfigure}[37]{r}{3in}
\includegraphics{figures/wavpack_read_residual1.pdf}
\caption{Step 1: determining t}
\end{wrapfigure}
The first stage is taking two boolean values called
\VAR{Holding One} and \VAR{Holding Zero} and determining \VAR{t}
via the following process:

These can be thought of as registers in a sort of
WavPack bitstream virtual machine whose values will
change over the course of decoding.
Their initial values are both false.

\VAR{limited unary} means reading the number
of \texttt{1} bits until the next \texttt{0} bit, to a maximum
of 33, \texttt{1} bits in a row.

In our example, to decode the first \VAR{t} value:
\begin{description}
\item[$\bullet$ is holding\_zero?] no
\item[$\bullet$ t = limited\_unary] = `\texttt{1 0}' = 1
\item[$\bullet$ is t = 16?] no
\item[$\bullet$ is holding\_one?] no
\item[$\bullet$ is t odd?] yes
\item[$\bullet$ holding\_one = true]
\item[$\bullet$ holding\_zero = false]
\item[$\bullet$ t = t $\div$ 2] = 1 $\div$ 2 = 0
\end{description}
So our \VAR{t} value is 0, our \VAR{Holding One} value is true,
our \VAR{Holding Zero} value is false and we've
consumed 2 bits from the sub-block's bitstream.

\clearpage

\subsubsection{Calculating base/add}
\begin{figure}[h]
\includegraphics{figures/wavpack_read_residual2.pdf}
\caption{Step 2: determining base/add}
\end{figure}
\par
\noindent
So to continue our example:
\begin{description}
\item[$\bullet$ is t = 0?] yes
\item[$\bullet$ base] = 0
\item[$\bullet$ add = $\text{Entropy}_1 \div 16$] = $111 \div 16 = 6$
\item[$\bullet$ $\text{Entropy}_1$ = $\text{Entropy}_1 - ((\text{Entropy}_1 + 126) \div 128) \times 2$] = $111 - 2 = 109$
\end{description}
Note that $\text{Entropy}_2$ remains 159 and $\text{Entropy}_3$ remains 299.

\clearpage

\subsubsection{Determining value}
\begin{wrapfigure}[30]{r}{3in}
\includegraphics{figures/wavpack_read_residual3.pdf}
\caption{Step 3: determining value}
\end{wrapfigure}
Finally, given our \VAR{Base} and \VAR{Add} values, we
determine the final residual value as follows:
\begin{description}
\item[$\bullet$ is $\text{add} < 1$?] no
\item[$\bullet$ p = $\text{log}_2(\text{add})$] = $\text{log}_2(6)$ = 2
\item[$\bullet$ e = $2 ^ {p + 1} - \text{add} - 1$] = $2 ^ 3 - 6 - 1 = 1$
\item[$\bullet$ is $\text{p} > 0$?] yes
\item[$\bullet$ result = read 2] = `\texttt{0 0}' = 0
\item[$\bullet$ is $\text{result} > \text{e}$?] no
\item[$\bullet$ sign = read 1] = `\texttt{0}' = 0
\item[$\bullet$ is $\text{sign} = 1$?] no
\item[$\bullet$ value = $\text{base} + \text{result}$] = 0 + 0 = 0
\end{description}
Thus, this stage consumes an additional 3 bits and our first residual
value is 0.

Determining the second residual value requires going through all
three steps again, with our freshly updated \VAR{Holding One},
\VAR{Holding Zero} and \VAR{Entropy} values.

Note that in a 2 channel (non-mono) block,
the \VAR{Entropy} values alternate between residuals.
For example,
$\text{Residual}_0$ uses $\text{Entropy A}$,
$\text{Residual}_1$ uses $\text{Entropy B}$,
$\text{Residual}_3$ uses $\text{Entropy A}$, and so forth.
However, \VAR{Holding One} and \VAR{Holding Zero} are shared
between channels.

\clearpage

Now, let's run through the next residual on our remaining bits:
\begin{Verbatim}[frame=single]
1 0 1  1 1 1 0 1 1 1 0  1 0 0 1 0 1 1 1
\end{Verbatim}
\begin{description}
\item[$\bullet$ is holding\_zero?] no
\item[$\bullet$ t = limited\_unary] = `\texttt{1 0}' = 1
\item[$\bullet$ is t = 16?] no
\item[$\bullet$ is holding\_one?] yes
\item[$\bullet$ is t odd?] yes
\item[$\bullet$ holding\_one = true]
\item[$\bullet$ holding\_zero = false]
\item[$\bullet$ t = (t $\div$ 2) + 1] = (1 $\div$ 2) + 1 = 1
\item[$\bullet$ is t = 0?] no
\item[$\bullet$ is t = 1?] yes
\item[$\bullet$ base = $(\text{Entropy}_1 \div 16) + 1$] = $(109 \div 16) + 1 = 7$
\item[$\bullet$ add = $\text{Entropy}_2 \div 16$] = $159 \div 16 = 9$
\item[$\bullet$ $\text{Entropy}_1 = \text{Entropy}_1 + ((\text{Entropy}_1 + 128) \div 128) \times 5$] = 114
\item[$\bullet$ $\text{Entropy}_2 = \text{Entropy}_2 - ((\text{Entropy}_2 + 62) \div 64) \times 2$] = 153
\item[$\bullet$ is $\text{add} < 1$?] no
\item[$\bullet$ p = $\text{log}_2(\text{add})$] = $\text{log}_2(9)$ = 3
\item[$\bullet$ e = $2 ^ {p + 1} - \text{add} - 1$] = $2 ^ 4 - 9 - 1 = 6$
\item[$\bullet$ is $\text{p} > 0$?] yes
\item[$\bullet$ result = read 3] = `\texttt{1 1 1}' = 7
\item[$\bullet$ is $\text{result} > \text{e}$?] yes
\item[$\bullet$ result = $(\text{result} \times 2) - \text{e} + 1$] = $(7 \times 2) - 6 + 1 = 9$
\item[$\bullet$ sign = read 1] = 0
\item[$\bullet$ is sign = 1?] no
\item[$\bullet$ value = base + result] = 7 + 9 = 16
\end{description}
Which returns the value 16 and consumes 7 bits in total.
%% \begin{sidewaysfigure}[h]
%% \includegraphics{figures/wavpack_read_residual.pdf}
%% \caption{the WavPack residual reading sequence}
%% \end{sidewaysfigure}
