%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{WavPack}
WavPack is a format for compressing Wave files, typically in lossless mode.
Notably, it also has a lossy mode and even a hybrid mode which allows
the `correction' file to be separated from a lossy core.

Metadata is stored as an APEv2 tag, which is described on page \pageref{apev2}.

Its stream of data is stored little-endian.

\section{the WavPack File Stream}
\begin{figure}[h]
\includegraphics{figures/wavpack/stream.pdf}
\end{figure}

\clearpage

\subsection{Block Header}
\begin{figure}[h]
\includegraphics{figures/wavpack/block_header.pdf}
\end{figure}

\begin{table}[h]
\begin{tabular}{rl}
\textbf{block ID} & always \texttt{"wvpk"} or \texttt{0x6B707677} \\
\textbf{block size} & number of bytes between \VAR{block size} field's end and block's end \\
\textbf{version} & the file version, between \texttt{0x0402} and \texttt{0x0410} \\
\textbf{track number} & always 0 \\
\textbf{index number} & always 0 \\
\textbf{total samples} & length of the entire file in PCM frames \\
\textbf{block index} & block's PCM frame offset in the stream \\
\textbf{block samples} & length of the block in PCM frames \\
\textbf{CRC} & checksum of decoded PCM data \\
\end{tabular}
\end{table}

\clearpage

\begin{table}[h]
{\relsize{-1}
\begin{tabular}{rrl}
flag & value & meaning \\
\hline
\hline
\textbf{bits per sample} & \texttt{0} & 8 bits per sample \\
& \texttt{1} & 16 bits per sample \\
& \texttt{2} & 24 bits per sample \\
& \texttt{3} & 32 bits per sample \\
\hline
\textbf{mono output} & \texttt{0} & block has 2 channels of output \\
& \texttt{1} & block has 1 channel of output \\
\hline
\textbf{hybrid mode} & \texttt{0} & data stored lossless \\
& \texttt{1} & data stored lossy, with external correction file \\
\hline
\textbf{joint stereo} & \texttt{0} & channels stored in true stereo \\
& \texttt{1} & channels stored in joint stereo \\
\hline
\textbf{channel decorrelation} & \texttt{0} & channels stored independently \\
& \texttt{1} & cross-channel decorrelation between channels \\
\hline
\textbf{hybrid noise shaping} & \texttt{0} & hybrid has flat noise spectrum \\
& \texttt{1} & hybrid has noise shaping \\
\hline
\textbf{floating point data} & \texttt{0} & samples stored as integers \\
& \texttt{1} & samples stored as floats \\
\hline
\textbf{extended size integers} & \texttt{1} & $\text{bits per sample} > 24$ or left shifted \\
\hline
\textbf{hybrid controls bitrate} & \texttt{0} & hybrid parameters control noise level \\
& \texttt{1} & hybrid parameters control bitrate \\
\hline
\textbf{hybrid noise balanced} & \texttt{1} & hybrid noise balanced between channels \\
\hline
\textbf{initial block} & \texttt{1} & initial block in multichannel sequence \\
\hline
\textbf{final block} & \texttt{1} & final block in multichannel sequence \\
\hline
\textbf{left shift data} & & amount of bits to left-shift decoded data \\
\hline
\textbf{maximum magnitude} & & bit length of largest integer value, minus 1 \\
\hline
\textbf{sample rate} & \texttt{0} & 6000 Hz \\
& \texttt{1} & 8000 Hz \\
& \texttt{2} & 9600 Hz \\
& \texttt{3} & 11025 Hz \\
& \texttt{4} & 12000 Hz \\
& \texttt{5} & 16000 Hz \\
& \texttt{6} & 22050 Hz \\
& \texttt{7} & 24000 Hz \\
& \texttt{8} & 32000 Hz \\
& \texttt{9} & 44100 Hz \\
& \texttt{10} & 48000 Hz \\
& \texttt{11} & 64000 Hz \\
& \texttt{12} & 88200 Hz \\
& \texttt{13} & 96000 Hz \\
& \texttt{14} & 192000 Hz \\
& \texttt{15} & reserved \\
\hline
\textbf{reserved} & & ignore if set \\
\hline
\textbf{use IIR} & & use IIR for negative hybrid noise shaping \\
\hline
\textbf{false stereo} & & mono block which decodes to 2 identical channels \\
\hline
\textbf{reserved} & & always 0 \\
\end{tabular}
}
\end{table}

\clearpage

\subsection{Sub Block}

\begin{figure}[h]
\includegraphics{figures/wavpack/subblock.pdf}
\end{figure}
\par
\noindent
If \VAR{large sub block} is 0, \VAR{sub block size} is an 8 bit field.
Otherwise, it is 24 bits.
If \VAR{actual size 1 less} is 1, the contents of
\VAR{sub block data} are 1 byte shorter than its length;
the block itself is padded with 1 empty byte.
\vskip .15in
\par
\noindent
\begin{table}[h]
\begin{tabular}{rrl}
metadata function & nondecoder data & contents \\
\hline
\texttt{0} & \texttt{0} & padding \\
\texttt{2} & \texttt{0} & decorrelation terms and deltas \\
\texttt{3} & \texttt{0} & initial decorrelation weights \\
\texttt{4} & \texttt{0} & decorrelation samples \\
\texttt{5} & \texttt{0} & initial entropy variables \\
\texttt{6} & \texttt{0} & hybrid entropy variables \\
\texttt{7} & \texttt{0} & hybrid lossless info \\
\texttt{8} & \texttt{0} & floating point info \\
\texttt{9} & \texttt{0} & large integer info \\
\texttt{10} & \texttt{0} & normal compressed audio bitstream \\
\texttt{11} & \texttt{0} & correction file bitstream \\
\texttt{12} & \texttt{0} & large floating point info \\
\texttt{13} & \texttt{0} & channel count and channel mask \\
\hline
\texttt{1} & \texttt{1} & RIFF header \\
\texttt{2} & \texttt{1} & RIFF trailer \\
\texttt{5} & \texttt{1} & encoding info \\
\texttt{6} & \texttt{1} & audio data MD5 sum \\
\texttt{7} & \texttt{1} & non-standard sample rate \\
\end{tabular}
\end{table}

\clearpage

\section{WavPack Decoding}

\ALGORITHM{a WavPack encoded file}{PCM samples}
\SetKwData{INDEX}{index}
\SetKwData{SAMPLES}{samples}
\SetKwData{TOTALSAMPLES}{total samples}
\SetKwData{FINALBLOCK}{final block}
\SetKwData{OUTPUTCHANNEL}{output channel}
\SetKwData{BLOCKCHANNEL}{block channel}
\SetKwData{BLOCKDATASIZE}{block data size}
\Repeat{block header's $\text{\INDEX} + \text{\SAMPLES} >= \text{\TOTALSAMPLES}$}{
  $c \leftarrow 0$\;
  \Repeat{block header's $\text{\FINALBLOCK} = 1$}{
    \hyperref[wavpack:read_block_header]{read block header}\;
    read \BLOCKDATASIZE bytes of block data\;
    \hyperref[wavpack:decode_block]{decode block header and block data to 1 or 2 channels of PCM data}\;
    \eIf{2 channels}{
      $\text{\OUTPUTCHANNEL}_c \leftarrow \text{\BLOCKCHANNEL}_0$\;
      $\text{\OUTPUTCHANNEL}_{c + 1} \leftarrow \text{\BLOCKCHANNEL}_1$\;
      $c \leftarrow c + 2$\;
    }{
      $\text{\OUTPUTCHANNEL}_c \leftarrow \text{\BLOCKCHANNEL}_0$\;
      $c \leftarrow c + 1$\;
    }
  }
  update stream MD5 sum with \OUTPUTCHANNEL data\;
  \Return \OUTPUTCHANNEL data\;
}
\BlankLine
\hyperref[wavpack:md5_sum]{attempt to read one additional block for MD5 sub block}\;
\If{MD5 sub block found}{
  \ASSERT sub block MD5 sum = stream MD5 sum\;
}
\EALGORITHM
\par
\noindent
For example, four blocks with the following attributes:
\begin{table}[h]
\begin{tabular}{rrr}
channel count & initial block & final block \\
\hline
2 & 1 & 0 \\
1 & 0 & 0 \\
1 & 0 & 0 \\
2 & 0 & 1 \\
\end{tabular}
\end{table}
\par
\noindent
combine into 6 channels of PCM output as follows:
\begin{figure}[h]
\includegraphics{figures/wavpack/block_channels.pdf}
\end{figure}

\clearpage

\subsection{Reading Block Header}
\label{wavpack:read_block_header}
{\relsize{-1}
\ALGORITHM{a WavPack file stream}{block header fields}
\SetKwData{BLOCKID}{block ID}
\SetKwData{BLOCKSIZE}{block data size}
\SetKwData{VERSION}{version}
\SetKwData{TRACKNUMBER}{track number}
\SetKwData{INDEXNUMBER}{index number}
\SetKwData{TOTALSAMPLES}{total samples}
\SetKwData{BLOCKINDEX}{block index}
\SetKwData{BLOCKSAMPLES}{block samples}
\SetKwData{BITSPERSAMPLE}{bits per sample}
\SetKwData{MONOOUTPUT}{mono output}
\SetKwData{HYBRIDMODE}{hybrid mode}
\SetKwData{JOINTSTEREO}{joint stereo}
\SetKwData{CHANNELDECORR}{channel decorrelation}
\SetKwData{HYBRIDNOISESHAPING}{hybrid noise shaping}
\SetKwData{FLOATINGPOINTDATA}{floating point data}
\SetKwData{EXTENDEDSIZEINTEGERS}{extended size integers}
\SetKwData{HYBRIDCONTROLSBITRATE}{hybrid controls bitrate}
\SetKwData{HYBRIDNOISEBALANCED}{hybrid noise balanced}
\SetKwData{INITIALBLOCK}{initial block}
\SetKwData{FINALBLOCK}{final block}
\SetKwData{LEFTSHIFTDATA}{left shift data}
\SetKwData{MAXIMUMMAGNITUDE}{maximum magnitude}
\SetKwData{SAMPLERATE}{sample rate}
\SetKwData{USEIIR}{use IIR}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{RESERVED}{reserved}
\SetKwData{CRC}{CRC}
\begin{tabular}{r>{$}c<{$}l}
\BLOCKID & \leftarrow & \READ 4 bytes\; \\
& & \ASSERT $\text{\BLOCKID} = \texttt{"wvpk"}$\; \\
\BLOCKSIZE & \leftarrow & (\READ 32 unsigned bits) - 24\; \\
\VERSION & \leftarrow & \READ 16 unsigned bits\; \\
\TRACKNUMBER & \leftarrow & \READ 8 unsigned bits\; \\
\INDEXNUMBER & \leftarrow & \READ 8 unsigned bits\; \\
\TOTALSAMPLES & \leftarrow & \READ 32 unsigned bits\; \\
\BLOCKINDEX & \leftarrow & \READ 32 unsigned bits\; \\
\BLOCKSAMPLES & \leftarrow & \READ 32 unsigned bits\; \\
\BITSPERSAMPLE & \leftarrow & $(\text{\READ 2 unsigned bits} + 1) \times 8$\; \\
\MONOOUTPUT & \leftarrow & \READ 1 unsigned bit\; \\
\HYBRIDMODE & \leftarrow & \READ 1 unsigned bit\; \\
\JOINTSTEREO & \leftarrow & \READ 1 unsigned bit\; \\
\CHANNELDECORR & \leftarrow & \READ 1 unsigned bit\; \\
\HYBRIDNOISESHAPING & \leftarrow & \READ 1 unsigned bit\; \\
\FLOATINGPOINTDATA & \leftarrow & \READ 1 unsigned bit\; \\
\EXTENDEDSIZEINTEGERS & \leftarrow & \READ 1 unsigned bit\; \\
\HYBRIDCONTROLSBITRATE & \leftarrow & \READ 1 unsigned bit\; \\
\HYBRIDNOISEBALANCED & \leftarrow & \READ 1 unsigned bit\; \\
\INITIALBLOCK & \leftarrow & \READ 1 unsigned bit\; \\
\FINALBLOCK & \leftarrow & \READ 1 unsigned bit\; \\
\LEFTSHIFTDATA & \leftarrow & \READ 5 unsigned bits\; \\
\MAXIMUMMAGNITUDE & \leftarrow & \READ 5 unsigned bits\; \\
\textit{encoded sample rate} & \leftarrow & \READ 4 unsigned bits\; \\
& & \SKIP 2 bits\; \\
\USEIIR & \leftarrow & \READ 1 unsigned bit\; \\
\FALSESTEREO & \leftarrow & \READ 1 unsigned bit\; \\
\RESERVED & \leftarrow & \READ 1 unsigned bit\; \\
& & \ASSERT $\text{\RESERVED} = 0$\; \\
\CRC & \leftarrow & \READ 32 unsigned bits\; \\
\end{tabular}
\EALGORITHM
}
{\relsize{-1}
\begin{tabular}{rr}
  \textit{encoded sample rate} & sample rate \\
  \hline
  \texttt{0} & 6000 Hz \\
  \texttt{1} & 8000 Hz \\
  \texttt{2} & 9600 Hz \\
  \texttt{3} & 11025 Hz \\
  \texttt{4} & 12000 Hz \\
  \texttt{5} & 16000 Hz \\
  \texttt{6} & 22050 Hz \\
  \texttt{7} & 24000 Hz \\
  \texttt{8} & 32000 Hz \\
  \texttt{9} & 44100 Hz \\
  \texttt{10} & 48000 Hz \\
  \texttt{11} & 64000 Hz \\
  \texttt{12} & 88200 Hz \\
  \texttt{13} & 96000 Hz \\
  \texttt{14} & 192000 Hz \\
  \texttt{15} & reserved \\
\end{tabular}
}

\clearpage

\subsubsection{Reading Block Header Example}
\includegraphics{figures/wavpack/block_header_parse.pdf}

%% \clearpage

%% \begin{table}[h]
%% \begin{tabular}{rrl}
%% field & value & meaning \\
%% \hline
%% \textbf{block ID} & \texttt{0x6B707677} & \texttt{"wvpk"} \\
%% \textbf{block data size} & \texttt{0x000000B2} & $178 - 24 = 154$ bytes \\
%% \textbf{version} & \texttt{0x0407} \\
%% \textbf{track number} & \texttt{0} \\
%% \textbf{index number} & \texttt{0} \\
%% \textbf{total samples} & \texttt{0x00000019} & 25 PCM frames \\
%% \textbf{block index} & \texttt{0x00000000} & 0 PCM frames \\
%% \textbf{block samples} & \texttt{0x00000019} & 25 PCM frames \\
%% \textbf{bits per sample} & \texttt{1} & 16 bits per sample \\
%% \textbf{mono output} & \texttt{0} & 2 channel block \\
%% \textbf{hybrid mode} & \texttt{0} & lossless data \\
%% \textbf{joint stereo} & \texttt{1} & channels stored in joint stereo \\
%% \textbf{channel decorrelation} & \texttt{1} & cross-channel decorrelation used \\
%% \textbf{hybrid noise shaping} & \texttt{0} \\
%% \textbf{floating point data} & \texttt{0} & samples stored as integers \\
%% \textbf{extended size integers} & \texttt{0} \\
%% \textbf{hybrid controls bitrate} & \texttt{0} \\
%% \textbf{hybrid noise balanced} & \texttt{0} \\
%% \textbf{initial block} & \texttt{1} & is initial block in sequence \\
%% \textbf{final block} & \texttt{1} & is final block in sequence \\
%% \textbf{left shift data} & \texttt{0} \\
%% \textbf{maximum magnitude} & \texttt{15} & 16 bits per sample output \\
%% \textbf{sample rate} & \texttt{9} & 44100 Hz \\
%% \textbf{reserved} & \texttt{0} \\
%% \textbf{use IIR} & \texttt{0} \\
%% \textbf{false stereo} & \texttt{0} & both channels are not identical \\
%% \textbf{reserved} & \texttt{0} \\
%% \textbf{CRC} & \texttt{0x22D25AD7} \\
%% \end{tabular}
%% \end{table}

\clearpage

\subsection{Block Decoding}
\label{wavpack:decode_block}
{\relsize{-1}
\ALGORITHM{block header, block data}{1 or 2 channels of PCM sample data}
\SetKwData{METAFUNC}{metadata function}
\SetKwData{NONDECODER}{nondecoder data}
\SetKwData{ONELESS}{actual size 1 less}
\SetKwData{BLOCKDATA}{block data size}
\SetKwData{SUBBLOCKSIZE}{sub block size}
\SetKwData{TERMS}{decorrelation terms}
\SetKwData{DELTAS}{decorrelation deltas}
\SetKwData{WEIGHTS}{decorrelation weights}
\SetKwData{SAMPLES}{decorrelation samples}
\SetKwData{ENTROPIES}{entropies}
\SetKwData{RESIDUALS}{residuals}
\SetKwData{ZEROES}{zero bits}
\SetKwData{ONES}{one bits}
\SetKwData{DUPES}{duplicate bits}
\SetKw{AND}{and}
\tcc{read decoding parameters from sub blocks}
\While{$\text{\BLOCKDATA} > 0$}{
  \tcc{read sub block header and data}
  \METAFUNC $\leftarrow$ \READ 5 unsigned bits\;
  \NONDECODER $\leftarrow$ \READ 1 unsigned bit\;
  \ONELESS $\leftarrow$ \READ 1 unsigned bit\;
  \textit{large sub block} $\leftarrow$ \READ 1 unsigned bit\;
  \eIf{$\text{large sub block} = 0$}{
    \SUBBLOCKSIZE $\leftarrow$ \READ 8 unsigned bits\;
  }{
    \SUBBLOCKSIZE $\leftarrow$ \READ 24 unsigned bits\;
  }
  \eIf{$\ONELESS = 0$}{
    read $(\SUBBLOCKSIZE \times 2)$ bytes of sub block data\;
  }{
    read $(\SUBBLOCKSIZE \times 2) - 1$ bytes of sub block data\;
    \SKIP 1 byte\;
  }
  \BlankLine
  \tcc{decode audio-related sub blocks}
  \If{$\text{\NONDECODER} = 0$}{
    \Switch{\METAFUNC}{
      \uCase{2}{
        $\TERMS, \DELTAS \leftarrow$ \hyperref[wavpack:decode_decorrelation_terms]{decode decorrelation terms sub block}\;
      }
      \uCase{3}{
        \ASSERT \TERMS have been read\;
        $\WEIGHTS \leftarrow$ \hyperref[wavpack:decode_decorrelation_weights]{decode decorrelation weights sub block}\;
      }
      \uCase{4}{
        \ASSERT \TERMS have been read\;
        $\SAMPLES \leftarrow$ \hyperref[wavpack:decode_decorrelation_samples]{decode decorrelation samples sub block}\;
      }
      \uCase{5}{
        $\ENTROPIES \leftarrow$ \hyperref[wavpack:decode_entropy_variables]{decode entropy variables sub block}\;
      }
      \uCase{9}{
        $\ZEROES, \ONES, \DUPES \leftarrow$ \hyperref[wavpack:decode_extended_integers]{decode extended integers sub block}\;
      }
      \Case{10}{
        \ASSERT \ENTROPIES have been read\;
        $\RESIDUALS \leftarrow$ \hyperref[wavpack:decode_bitstream]{decode WavPack bitstream sub block}\;
      }
    }
  }
  \eIf{$\text{large sub block} = 0$}{
    $\BLOCKDATA \leftarrow \BLOCKDATA - (2 + 2 \times \text{\SUBBLOCKSIZE})$
  }{
    $\BLOCKDATA \leftarrow \BLOCKDATA - (4 + 2 \times \text{\SUBBLOCKSIZE})$
  }
}
\If{\TERMS have been read}{
  \ASSERT \WEIGHTS, \SAMPLES have been read\;
}
\ASSERT \RESIDUALS have been read\;
\EALGORITHM
}

\clearpage

{\relsize{-1}
\begin{algorithm}[H]
\SetKwData{TERMS}{decorrelation terms}
\SetKwData{MONOOUTPUT}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{JOINTSTEREO}{joint stereo}
\SetKwData{EXTENDEDINTS}{extended integers}
\SetKwData{RESIDUALS}{residuals}
\SetKwData{DECORRELATED}{decorrelated}
\SetKwData{LEFTRIGHT}{left/right}
\SetKwData{UNSHIFTED}{unshifted}
\SetKwFunction{LEN}{len}
\SetKwFunction{UNDOEXTENDEDINTS}{undo\_extended\_integers}
\SetKw{AND}{and}
\DontPrintSemicolon
\tcc{build PCM data from decoding parameters}
\eIf(\tcc*[f]{2 channels of output}){$\text{\MONOOUTPUT} = 0$ \AND $\text{\FALSESTEREO} = 0$}{
  \eIf{\TERMS have been read \AND $\LEN(\TERMS) > 0$}{
    $\text{\DECORRELATED}_0/\text{\DECORRELATED}_1 \leftarrow$ \hyperref[wavpack:decorrelate_channels]{decorrelate $\text{\RESIDUALS}_0/\text{\RESIDUALS}_1$}\;
  }{
    $\text{\DECORRELATED}_0/\text{\DECORRELATED}_1 \leftarrow \text{\RESIDUALS}_0/\text{\RESIDUALS}_1$\;
  }
  \eIf{$\text{\JOINTSTEREO} = 1$}{
    $\LEFTRIGHT \leftarrow$ \hyperref[wavpack:undo_joint_stereo]{undo $\text{\DECORRELATED}_0/\text{\DECORRELATED}_1$ channels joint stereo}\;
  }{
    $\LEFTRIGHT \leftarrow \text{\DECORRELATED}_0/\text{\DECORRELATED}_1$\;
  }
  \hyperref[wavpack:verify_crc]{verify CRC of $\LEFTRIGHT$ against CRC in block header}\;
  \eIf{extended integers have been read}{
    $\text{\UNSHIFTED}_0/\text{\UNSHIFTED}_1 \leftarrow$ \hyperref[wavpack:undo_extended_integers]{undo \LEFTRIGHT channels extended integers}\;
  }{
    $\text{\UNSHIFTED}_0/\text{\UNSHIFTED}_1 \leftarrow \LEFTRIGHT$
  }
  \Return $\text{\UNSHIFTED}_0$ and $\text{\UNSHIFTED}_1$\;
}(\tcc*[f]{1 or 2 channels of output}){
  \eIf{\TERMS have been read \AND $\LEN(\TERMS) > 0$}{
    $\text{\DECORRELATED}_0 \leftarrow$ \hyperref[wavpack:decorrelate_channels]{decorrelate $\text{\RESIDUALS}_0$}\;
  }{
    $\text{\DECORRELATED}_0 \leftarrow \text{\RESIDUALS}_0$\;
  }
  \hyperref[wavpack:verify_crc]{  verify CRC of $\text{\DECORRELATED}_0$ against CRC in block header}\;
  \eIf{extended integers have been read}{
    $\text{\UNSHIFTED}_0 \leftarrow$ \hyperref[wavpack:undo_extended_integers]{undo $\text{\DECORRELATED}_0$ channel extended integers}\;
  }{
    $\text{\UNSHIFTED}_0 \leftarrow \text{\DECORRELATED}_0$\;
  }
  \eIf{$\text{\FALSESTEREO} = 0$}{
    \Return $\text{\UNSHIFTED}_0$\;
  }{
    \Return $\text{\UNSHIFTED}_0$ and $\text{\UNSHIFTED}_0$\tcc*[r]{duplicate channel}
  }
}
\end{algorithm}
}
\begin{figure}[h]
  \includegraphics{figures/wavpack/typical_block.pdf}
\end{figure}

%% \clearpage

%% \subsection{Reading Sub Block Header}
%% \ALGORITHM{block data}{metadata function integer, nondecoder data flag, \VAR{actual size 1 less} flag, sub block size}
%% \SetKwData{METAFUNC}{metadata function}
%% \SetKwData{NONDECODER}{nondecoder data}
%% \SetKwData{SUBBLOCKSIZE}{sub block size}
%% \SetKwData{ACTUALSIZEONELESS}{actual size 1 less}
%% \METAFUNC $\leftarrow$ \READ 5 unsigned bits\;
%% \NONDECODER $\leftarrow$ \READ 1 unsigned bit\;
%% \ACTUALSIZEONELESS $\leftarrow$ \READ 1 unsigned bit\;
%% \textit{large sub block} $\leftarrow$ \READ 1 unsigned bit\;
%% \eIf{$\text{large sub block} = 0$}{
%%   \SUBBLOCKSIZE $\leftarrow$ (\READ 8 unsigned bits) $\times 2$\;
%% }{
%%   \SUBBLOCKSIZE $\leftarrow$ (\READ 24 unsigned bits) $\times 2$\;
%% }
%% \Return (\METAFUNC , \NONDECODER , \ACTUALSIZEONELESS , \SUBBLOCKSIZE)\;
%% \EALGORITHM

%% \subsubsection{Reading Sub Block Header Example}
%% \begin{figure}[h]
%% \includegraphics{figures/wavpack/subblock_parse.pdf}
%% \end{figure}
%% \begin{table}[h]
%% \begin{tabular}{r>{$}c<{$}l}
%% metadata function & \leftarrow & 2 \\
%% nondecoder data & \leftarrow & 0 \\
%% actual size 1 less & \leftarrow & 1 \\
%% large sub block & \leftarrow & 0 \\
%% sub block size & \leftarrow & $3 \times 2 = 6$ bytes\;
%% \end{tabular}
%% \end{table}
%% \par
%% \noindent
%% Note that although the total length of the sub block is
%% 8 bytes (2 bytes for the header plus the 6 bytes indicated by
%% \VAR{sub block size}),
%% \VAR{actual size 1 less} indicates that only the first 5 bytes
%% contain actual data and the final byte is padding.

%% \clearpage

%% \subsection{Reading Decoding Parameters}

%% {\relsize{-1}
%% \ALGORITHM{\VAR{metadata function}, \VAR{nondecoder data}, \VAR{actual size 1 less}, \VAR{sub block size} from sub block header; block header}{parameters required for block decoding}
%% \SetKwData{METAFUNC}{metadata function}
%% \SetKwData{NONDECODER}{nondecoder data}
%% \eIf{$\text{\NONDECODER} = 0$}{
%%   \Switch{\METAFUNC}{
%%     \uCase{2}{
%%       read decorrelation terms and deltas from decorrelation terms sub block\;
%%       \Return list of signed decorrelation terms and list of unsigned deltas\;
%%     }
%%     \uCase{3}{
%%       read decorrelation weights from decorrelation weights sub block\;
%%       \Return signed decorrelation weight per channel per decorrelation term\;
%%     }
%%     \uCase{4}{
%%       read decorrelation samples from decorrelation samples sub block\;
%%       \Return list of signed decorrelation samples per channel per decorrelation term\;
%%     }
%%     \uCase{5}{
%%       read 2 lists of 3 signed entropy variables\;
%%       \Return 2 lists of signed entropy variables\;
%%     }
%%     \uCase{9}{
%%       read zero bits, one bits and duplicate bits from extended integers sub block\;
%%       \Return zero bits, one bits, duplicate bits values\;
%%     }
%%     \uCase{10}{
%%       read WavPack bitstream\;
%%       \Return list of signed residual values per channel\;
%%     }
%%     \Other{
%%       skip sub block\;
%%     }
%%   }
%% }{
%%   skip sub block\;
%% }
%% \EALGORITHM
%% }

%% \subsubsection{The Decoding Parameters}
%% These parameters will be populated by sub blocks during decoding.
%% Once all the sub blocks have been read,
%% they will be used to transform residual data
%% into 1 or 2 channels of PCM data.
%% \begin{description}
%% \item[decorrelation terms] one signed integer from -3 to 18 per decorrelation pass
%% \item[decorrelation deltas] one unsigned integer per decorrelation pass
%% \item[decorrelation weights] one signed integer per decorrelation pass per channel
%% \item[decorrelation samples] one list of signed integers per decorrelation pass per channel
%% \item[entropy variables] two lists of three signed integers
%% \item[zero bits/one bits/duplicate bits] three unsigned integers indicating extended integers
%% \item[residuals] one list of signed integers per channel
%% \end{description}

%% \clearpage

%% \subsubsection{Decorrelation Pass Parameters}
%% The number of terms in the \VAR{decorrelation terms} sub block
%% determines how many decorrelation passes will run over the
%% block's residual data.
%% Decorrelation weight and decorrelation samples parameters
%% for those passes will be delivered in subsequent sub blocks.
%% \par
%% For example, given a 1 channel block
%% containing a sub block with 5 decorrelation terms,
%% decorrelation pass parameters may be laid out as follows:
%% \begin{figure}[h]
%% \includegraphics{figures/wavpack/decoding_params.pdf}
%% \end{figure}
%% \par
%% \noindent
%% Note that although the parameters are delivered in decrementing order
%% ($\text{term}_4$ to $\text{term}_0$),
%% the decorrelation passes are applied in incrementing order
%% ($\text{term}_0$ to $\text{term}_4$).

\clearpage

\subsection{Decode Decorrelation Terms}
\label{wavpack:decode_decorrelation_terms}
\ALGORITHM{\VAR{actual size 1 less} and \VAR{sub block size} values from sub block header, sub block data}{a list of signed decorrelation term integers, a list of unsigned decorrelation delta integers\footnote{$\text{term}_p$ and $\text{delta}_p$ indicate the term and delta values for decorrelation pass $p$}}
\SetKwData{PASSES}{passes}
\SetKwData{SUBBLOCKSIZE}{sub block size}
\SetKwData{ACTUALSIZEONELESS}{actual size 1 less}
\SetKwData{TERM}{term}
\SetKwData{DELTA}{delta}
\SetKw{OR}{or}
\SetKw{KwDownTo}{downto}
\eIf{$\text{\ACTUALSIZEONELESS} = 0$}{
  \PASSES $\leftarrow \text{\SUBBLOCKSIZE} \times 2$\;
}{
  \PASSES $\leftarrow \text{\SUBBLOCKSIZE} \times 2 - 1$\;
}
\ASSERT $\text{\PASSES} \leq 16$\;
\BlankLine
\For(\tcc*[f]{populate in reverse order}){$p \leftarrow \PASSES$ \emph{\KwDownTo}0}{
  $\text{\TERM}_p \leftarrow$ (\READ 5 unsigned bits) - 5\;
  \ASSERT $\text{\TERM}_p$ \IN \texttt{[-3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 17, 18]}
  \BlankLine
  $\text{\DELTA}_p \leftarrow$ \READ 3 unsigned bits\;
}
\Return decorrelation \TERM and decorrelation \DELTA lists\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_terms.pdf}
\end{figure}

\clearpage

\subsubsection{Reading Decorrelation Terms Example}

\begin{figure}[h]
\includegraphics{figures/wavpack/terms_parse.pdf}
\end{figure}
\begin{center}
{\renewcommand{\arraystretch}{1.25}
\begin{tabular}{>{$}r<{$}>{$}c<{$}>{$}r<{$}|>{$}r<{$}>{$}r<{$}>{$}r<{$}}
\text{decorrelation term}_4 & \leftarrow & 23 - 5 = 18 &
\text{decorrelation delta}_4 & \leftarrow & 2 \\
\text{decorrelation term}_3 & \leftarrow & 23 - 5 = 18 &
\text{decorrelation delta}_3 & \leftarrow & 2 \\
\text{decorrelation term}_2 & \leftarrow & 7 - 5 = 2 &
\text{decorrelation delta}_2 & \leftarrow & 2 \\
\text{decorrelation term}_1 & \leftarrow & 22 - 5 = 17 &
\text{decorrelation delta}_1 & \leftarrow & 2 \\
\text{decorrelation term}_0 & \leftarrow & 8 - 5 = 3 &
\text{decorrelation delta}_0 & \leftarrow & 2 \\
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{center}

\clearpage

\subsection{Decode Decorrelation Weights}
\label{wavpack:decode_decorrelation_weights}
{\relsize{-1}
\ALGORITHM{\VAR{mono output} and \VAR{false stereo} from block header, decorrelation terms count\footnote{from the decorrelation terms sub block, which must be read prior to this sub block}, \VAR{actual size 1 less} and \VAR{sub block size} values from sub block header, sub block data}{a list of signed weight integers per channel\footnote{$\text{weight}_{p~c}$ indicates weight value decorrelation pass $p$, channel $c$}}
\SetKwData{MONO}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{SUBBLOCKSIZE}{sub block size}
\SetKwData{ACTUALSIZEONELESS}{actual size 1 less}
\SetKwData{WEIGHTCOUNT}{weight count}
\SetKwData{TERMCOUNT}{term count}
\SetKwData{WEIGHTVAL}{weight value}
\SetKwData{WEIGHT}{weight}
\SetKw{AND}{and}
\tcc{read as many 8 bit weight values as possible}
\eIf{$\text{\ACTUALSIZEONELESS} = 0$}{
  \WEIGHTCOUNT $\leftarrow \text{\SUBBLOCKSIZE} \times 2$\;
}{
 \WEIGHTCOUNT $\leftarrow \text{\SUBBLOCKSIZE} \times 2 - 1$\;
}
\For{$i \leftarrow 0$ \emph{\KwTo}\WEIGHTCOUNT}{
  $\text{value}_i \leftarrow$ \READ 8 signed bits\;
  $\text{\WEIGHTVAL}_i \leftarrow\begin{cases}
\text{value}_i \times 2 ^ 3 + \left\lfloor\frac{\text{value}_i \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor & \text{if }\text{value}_i > 0 \\
0 & \text{if }\text{value}_i = 0 \\
\text{value}_i \times 2 ^ 3 & \text{if }\text{value}_i < 0
\end{cases}$\;
}
\BlankLine
\tcc{populate weight values by channel, in reverse order}
\eIf(\tcc*[f]{two channels}){$\text{\MONO} = 0$ \AND $\text{\FALSESTEREO} = 0$}{
  \ASSERT $\lfloor\WEIGHTCOUNT \div 2\rfloor \leq \TERMCOUNT$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}$\lfloor\WEIGHTCOUNT \div 2\rfloor$}{
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~0} \leftarrow \text{\WEIGHTVAL}_{i \times 2}$\;
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~1} \leftarrow \text{\WEIGHTVAL}_{i \times 2 + 1}$\;
  }
  \For{$i \leftarrow \lfloor\WEIGHTCOUNT \div 2\rfloor$ \emph{\KwTo}\TERMCOUNT}{
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~0} \leftarrow 0$\;
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~1} \leftarrow 0$\;
  }
  \Return a \WEIGHT value per pass, per channel\;
}(\tcc*[f]{one channel}){
  \ASSERT $\WEIGHTCOUNT \leq \TERMCOUNT$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}\WEIGHTCOUNT}{
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~0} \leftarrow \text{\WEIGHTVAL}_{i}$\;
  }
  \For{$i \leftarrow \WEIGHTCOUNT$ \emph{\KwTo}\TERMCOUNT}{
    $\text{\WEIGHT}_{(\TERMCOUNT - i - 1)~0} \leftarrow 0$\;
  }
  \Return a \WEIGHT value per pass\;
}
\EALGORITHM
}
\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_weights.pdf}
\end{figure}

\clearpage

\subsubsection{Reading Decorrelation Weights Example}
Given a 2 channel block containing 5 decorrelation terms:
\begin{figure}[h]
\includegraphics{figures/wavpack/decorr_weights_parse.pdf}
\end{figure}
\begin{center}
{\renewcommand{\arraystretch}{1.25}
\begin{tabular}{r|r|>{$}r<{$}}
$i$ & $\text{value}_i$ & \text{weight value}_i \\
\hline
0 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
1 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
2 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
3 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
4 & 4 & 4 \times 2 ^ 3 + \lfloor(4 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 32 \\
5 & 4 & 4 \times 2 ^ 3 + \lfloor(4 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 32 \\
6 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
7 & 6 & 6 \times 2 ^ 3 + \lfloor(6 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 48 \\
8 & 2 & 2 \times 2 ^ 3 + \lfloor(2 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 16 \\
9 & 3 & 3 \times 2 ^ 3 + \lfloor(3 \times 2 ^ 3 + 2 ^ 6) \div 2 ^ 7\rfloor = 24 \\
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{center}
\begin{center}
\begin{tabular}{>{$}r<{$}||>{$}r<{$}}
\text{weight}_{4~0} = \text{weight value}_0 = 48 &
\text{weight}_{4~1} = \text{weight value}_1 = 48 \\
\text{weight}_{3~0} = \text{weight value}_2 = 48 &
\text{weight}_{3~1} = \text{weight value}_3 = 48 \\
\text{weight}_{2~0} = \text{weight value}_4 = 32 &
\text{weight}_{2~1} = \text{weight value}_5 = 32 \\
\text{weight}_{1~0} = \text{weight value}_6 = 48 &
\text{weight}_{1~1} = \text{weight value}_7 = 48 \\
\text{weight}_{0~0} = \text{weight value}_8 = 16 &
\text{weight}_{0~1} = \text{weight value}_9 = 24 \\
\end{tabular}
\end{center}

\clearpage

\subsection{Decoding Decorrelation Samples}
\label{wavpack:decode_decorrelation_samples}
{\relsize{-2}
\ALGORITHM{\VAR{mono output} and \VAR{false stereo} from block header, decorrelation terms, sub block size and data}{a list of signed decorrelation sample lists per channel per decorrelation term\footnote{\relsize{-1}$\text{sample}_{p~c~s}$ indicates the $s$th sample of decorrelation pass $p$ for channel $c$}}
\SetKwData{MONO}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{CHANNELS}{channel count}
\SetKwData{SAMPLE}{sample}
\SetKwData{TOTALSAMPLES}{sample count}
\SetKwData{TERMCOUNT}{term count}
\SetKwData{TERM}{term}
\SetKwFunction{EXP}{wv\_exp2}
\SetKw{KwDownTo}{downto}
\SetKw{AND}{and}
\eIf{$(\MONO = 0)$ \AND $(\FALSESTEREO = 0)$}{
  $\CHANNELS \leftarrow 2$\;
}{
  $\CHANNELS \leftarrow 1$\;
}
\For{$p \leftarrow \TERMCOUNT$ \emph{\KwDownTo}0}{
  \uIf(\tcc*[f]{2 samples per channel}){$17 \leq \text{\TERM}_p \leq 18$}{
    \eIf{$\text{sub block bytes remaining} \geq (\CHANNELS \times 4)$}{
      \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
        $\text{\SAMPLE}_{p~c~0} \leftarrow \text{read \EXP value}$\;
        $\text{\SAMPLE}_{p~c~1} \leftarrow \text{read \EXP value}$\;
      }
    }{
      \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
        $\text{\SAMPLE}_{p~c} \leftarrow \texttt{[0, 0]}$\;
      }
    }
  }
  \uElseIf(\tcc*[f]{"term" samples per channel}){$1 \leq \text{\TERM}_p \leq 8$}{
    \eIf{$\text{sub block bytes remaining} \geq (\CHANNELS \times \text{\TERM}_p \times 2)$}{
      \For{$s \leftarrow 0$ \emph{\KwTo}$\text{\TERM}_p$}{
        \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
          $\text{\SAMPLE}_{p~c~s} \leftarrow \text{read \EXP value}$\;
        }
      }
    }{
      \For{$s \leftarrow 0$ \emph{\KwTo}$\text{\TERM}_p$}{
        \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
          $\text{\SAMPLE}_{p~c~s} \leftarrow 0$\;
        }
      }
    }
  }
  \ElseIf(\tcc*[f]{1 sample per channel}){$-3 \leq \text{\TERM}_p \leq -1$}{
    \eIf{$\text{sub block bytes remaining} \geq 4$}{
      $\text{\SAMPLE}_{p~0~0} \leftarrow \text{read \EXP value}$\;
      $\text{\SAMPLE}_{p~1~0} \leftarrow \text{read \EXP value}$\;
    }{
      $\text{\SAMPLE}_{p~0~0} \leftarrow 0$\;
      $\text{\SAMPLE}_{p~1~0} \leftarrow 0$\;
    }
  }
}
\Return $\text{\SAMPLE}$ lists per pass, per channel\;
\EALGORITHM
}
\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_samples.pdf}
\end{figure}

\clearpage

\subsubsection{Reading wv\_exp2 Values}
\label{wavpack_wvexp2}
{\relsize{-1}
\ALGORITHM{2 bytes of sub block data}{a signed value}
\SetKwFunction{EXP}{wexp}
$value \leftarrow$ \READ 16 signed bits\;
\BlankLine
\uIf{$-32768 \leq value < -2304$}{
  \Return $-(\EXP(-value \bmod{256}) \times 2 ^ {\lfloor -value \div 2 ^ 8 \rfloor - 9})$\;
}
\uElseIf{$-2304 \leq value < 0$}{
  \Return $-\lfloor \EXP(-value \bmod{256}) \div 2 ^ {9 - \lfloor -value \div 2 ^ 8 \rfloor} \rfloor$\;
}
\uElseIf{$0 \leq value \leq 2304$}{
  \Return $\lfloor \EXP(value \bmod{256}) \div 2 ^ {9 - \lfloor value \div 2 ^ 8 \rfloor} \rfloor$\;
}
\ElseIf{$2304 < value \leq 32767$}{
  \Return $\EXP(value \bmod{256}) \times 2 ^ {\lfloor value \div 2 ^ 8 \rfloor - 9}$\;
}
\EALGORITHM
}
\par
\noindent
where \texttt{wexp}(\textit{x}) is defined from the following table:
\vskip .10in
\par
\noindent
{\relsize{-3}\ttfamily
\begin{tabular}{| c | c | c | c | c | c | c | c | c | c | c | c | c | c | c | c | c |}
\hline
& 0x?0 & 0x?1 & 0x?2 & 0x?3 & 0x?4 & 0x?5 & 0x?6 & 0x?7 & 0x?8 & 0x?9 & 0x?A & 0x?B & 0x?C & 0x?D & 0x?E & 0x?F \\
\hline
0x0? & 256 & 257 & 257 & 258 & 259 & 259 & 260 & 261 & 262 & 262 & 263 & 264 & 264 & 265 & 266 & 267 \\
0x1? & 267 & 268 & 269 & 270 & 270 & 271 & 272 & 272 & 273 & 274 & 275 & 275 & 276 & 277 & 278 & 278 \\
0x2? & 279 & 280 & 281 & 281 & 282 & 283 & 284 & 285 & 285 & 286 & 287 & 288 & 288 & 289 & 290 & 291 \\
0x3? & 292 & 292 & 293 & 294 & 295 & 296 & 296 & 297 & 298 & 299 & 300 & 300 & 301 & 302 & 303 & 304 \\
0x4? & 304 & 305 & 306 & 307 & 308 & 309 & 309 & 310 & 311 & 312 & 313 & 314 & 314 & 315 & 316 & 317 \\
0x5? & 318 & 319 & 320 & 321 & 321 & 322 & 323 & 324 & 325 & 326 & 327 & 328 & 328 & 329 & 330 & 331 \\
0x6? & 332 & 333 & 334 & 335 & 336 & 337 & 337 & 338 & 339 & 340 & 341 & 342 & 343 & 344 & 345 & 346 \\
0x7? & 347 & 348 & 349 & 350 & 350 & 351 & 352 & 353 & 354 & 355 & 356 & 357 & 358 & 359 & 360 & 361 \\
0x8? & 362 & 363 & 364 & 365 & 366 & 367 & 368 & 369 & 370 & 371 & 372 & 373 & 374 & 375 & 376 & 377 \\
0x9? & 378 & 379 & 380 & 381 & 382 & 383 & 384 & 385 & 386 & 387 & 388 & 389 & 391 & 392 & 393 & 394 \\
0xA? & 395 & 396 & 397 & 398 & 399 & 400 & 401 & 402 & 403 & 405 & 406 & 407 & 408 & 409 & 410 & 411 \\
0xB? & 412 & 413 & 415 & 416 & 417 & 418 & 419 & 420 & 421 & 422 & 424 & 425 & 426 & 427 & 428 & 429 \\
0xC? & 431 & 432 & 433 & 434 & 435 & 436 & 438 & 439 & 440 & 441 & 442 & 444 & 445 & 446 & 447 & 448 \\
0xD? & 450 & 451 & 452 & 453 & 454 & 456 & 457 & 458 & 459 & 461 & 462 & 463 & 464 & 466 & 467 & 468 \\
0xE? & 470 & 471 & 472 & 473 & 475 & 476 & 477 & 478 & 480 & 481 & 482 & 484 & 485 & 486 & 488 & 489 \\
0xF? & 490 & 492 & 493 & 494 & 496 & 497 & 498 & 500 & 501 & 502 & 504 & 505 & 506 & 508 & 509 & 511 \\
\hline
\end{tabular}
}

\subsubsection{Reading Decorrelation Samples Example}
Given a stereo block containing the sub-block:
\begin{figure}[h]
\includegraphics{figures/wavpack/decorr_samples_parse.pdf}
\end{figure}
\begin{center}
{\relsize{-2}
\begin{tabular}{r|r|r|>{$}r<{$}|>{$}r<{$}}
$p$ & $\text{term}_p$ & $s$ &
\text{sample}_{p~0~s} &
\text{sample}_{p~1~s} \\
\hline
4 & 18 & 0 &
-\lfloor \texttt{wexp}(1841 \bmod{256}) \div 2 ^ {9 - \lfloor 1841 \div 2 ^ 8 \rfloor} \rfloor = -73 &
\lfloor \EXP(1487 \bmod{256}) \div 2 ^ {9 - \lfloor 1487 \div 2 ^ 8 \rfloor} \rfloor = 28 \\
& & 1 &
-\lfloor \EXP(1865 \bmod{256}) \div 2 ^ {9 - \lfloor 1865 \div 2 ^ 8 \rfloor} \rfloor = -78 &
\lfloor \EXP(1459 \bmod{256}) \div 2 ^ {9 - \lfloor 1459 \div 2 ^ 8 \rfloor} \rfloor = 26 \\
\hline
3 & 18 & 0 & 0 & 0 \\
& & 1 & 0 & 0 \\
\hline
2 & 2 & 0 & 0 & 0 \\
& & 1 & 0 & 0 \\
\hline
1 & 17 & 0 & 0 & 0 \\
& & 1 & 0 & 0 \\
\hline
0 & 3 & 0 & 0 & 0 \\
& & 1 & 0 & 0 \\
& & 2 & 0 & 0 \\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{center}

\clearpage

\subsection{Decoding Entropy Variables}
\label{wavpack:decode_entropy_variables}
{\relsize{-1}
\ALGORITHM{\VAR{mono output} and \VAR{false stereo} from block header, \VAR{sub block size}, \VAR{actual size 1 less}, sub block data}{2 lists of 3 signed entropy value integers\footnote{$\text{entropy}_{c~i}$ indicates the $i$th entropy of channel $c$}}
\SetKwData{ENTROPY}{entropy}
\SetKwFunction{EXP}{wv\_exp2}
\SetKwData{MONO}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{ONELESS}{actual size 1 less}
\SetKwData{SUBBLOCKSIZE}{sub block size}
\SetKw{AND}{and}
\ASSERT $\text{\ONELESS} = 0$\;
\eIf(\tcc*[f]{2 channels}){$\text{\MONO} = 0$ \AND $\text{\FALSESTEREO} = 0$}{
  \ASSERT $\text{\SUBBLOCKSIZE} = 6$\;
  $\text{\ENTROPY}_{0~0} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{0~1} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{0~2} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{1~0} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{1~1} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{1~2} \leftarrow \text{read \EXP value}$\;
}(\tcc*[f]{1 channel}){
  \ASSERT $\text{\SUBBLOCKSIZE} = 3$\;
  $\text{\ENTROPY}_{0~0} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{0~1} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{0~2} \leftarrow \text{read \EXP value}$\;
  $\text{\ENTROPY}_{1} \leftarrow \texttt{[0, 0, 0]}$\;
}
\Return $\text{\ENTROPY}_0$ list and $\text{\ENTROPY}_1$ list\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{figures/wavpack/entropy_vars.pdf}
\end{figure}

\clearpage

\subsubsection{Reading Entropy Variables Example}
Given a 2 channel block containing the subframe:
\begin{figure}[h]
\includegraphics{figures/wavpack/entropy_vars_parse.pdf}
\end{figure}
\begin{center}
{\relsize{-1}
\renewcommand{\arraystretch}{1.25}
\begin{tabular}{r|>{$}r<{$}|>{$}r<{$}}
$i$ & \text{entropy}_{0~i} & \text{entropy}_{1~i} \\
\hline
0 &
\lfloor \EXP(2018 \bmod{256}) \div 2 ^ {9 - \lfloor 2018 \div 2 ^ 8 \rfloor} \rfloor = 118 &
\lfloor \EXP(2018 \bmod{256}) \div 2 ^ {9 - \lfloor 2018 \div 2 ^ 8 \rfloor} \rfloor = 118 \\
1 &
\lfloor \EXP(2203 \bmod{256}) \div 2 ^ {9 - \lfloor 2203 \div 2 ^ 8 \rfloor} \rfloor = 194 &
\lfloor \EXP(2166 \bmod{256}) \div 2 ^ {9 - \lfloor 2166 \div 2 ^ 8 \rfloor} \rfloor = 176 \\
2 &
\EXP(2389 \bmod{256}) \times 2 ^ {\lfloor 2389 \div 2 ^ 8 \rfloor - 9} = 322 &
\lfloor \EXP(2234 \bmod{256}) \div 2 ^ {9 - \lfloor 2234 \div 2 ^ 8 \rfloor} \rfloor = 212 \\
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{center}

\clearpage

\subsection{Reading Bitstream}
\label{wavpack:decode_bitstream}
\ALGORITHM{\VAR{mono output}, \VAR{false stereo} and \VAR{block samples} from block header,
entropy values\footnote{from the entropy variables sub block, which must be read prior to this sub block}, sub block data}{a list of signed residual values per channel\footnote{$\text{residual}_{c~i}$ indicates the $i$th residual of channel $c$}}
\SetKwData{ENTROPY}{entropy}
\SetKwData{MONO}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{BLOCKSAMPLES}{block samples}
\SetKwData{CHANNELS}{channel count}
\SetKwData{UNDEFINED}{undefined}
\SetKwData{RESIDUAL}{residual}
\SetKwData{ZEROES}{zeroes}
\SetKw{AND}{and}
\eIf{$\text{\MONO} = 0$ \AND $\text{\FALSESTEREO} = 0$}{
  \CHANNELS $\leftarrow 2$\;
}{
  \CHANNELS $\leftarrow 1$\;
}
$u_{-1} \leftarrow \UNDEFINED$\;
$i \leftarrow 0$\;
\While{$i < (\BLOCKSAMPLES \times \CHANNELS)$}{
  \eIf{$(u_{i - 1} = \UNDEFINED)$ \AND
    $(\text{\ENTROPY}_{0~0} < 2)$ \AND
    $(\text{\ENTROPY}_{1~0} < 2)$}{
    \tcc{handle long run of 0 residuals}
    $\ZEROES \leftarrow$ read modified Elias gamma code\;
    \If{$\text{\ZEROES} > 0$}{
      \For{$j \leftarrow 0$ \emph{\KwTo}\ZEROES}{
        $\text{\RESIDUAL}_{(i \bmod \CHANNELS)~\lfloor i \div \CHANNELS \rfloor} \leftarrow $ 0\;
        $i \leftarrow i + 1$\;
      }
      \BlankLine
      $\text{\ENTROPY}_{0~0} \leftarrow \text{\ENTROPY}_{0~1} \leftarrow \text{\ENTROPY}_{0~2} \leftarrow 0$\;
      $\text{\ENTROPY}_{1~0} \leftarrow \text{\ENTROPY}_{1~1} \leftarrow \text{\ENTROPY}_{1~2} \leftarrow 0$\;
    }
    \If{$i < (\BLOCKSAMPLES \times \CHANNELS)$}{
      $\text{\RESIDUAL}_{(i \bmod \CHANNELS)~\lfloor i \div \CHANNELS \rfloor} \leftarrow $ read residual value\;
      $i \leftarrow i + 1$\;
    }
  }{
    $\text{\RESIDUAL}_{(i \bmod \CHANNELS)~\lfloor i \div \CHANNELS \rfloor} \leftarrow $ read residual value\;
    $i \leftarrow i + 1$\;
  }
}
\Return a list of signed \RESIDUAL values per channel\;
\EALGORITHM

\subsubsection{Reading Modified Elias Gamma Code}
{\relsize{-1}
  \ALGORITHM{the sub block bitstream}{an unsigned integer}
  $t \leftarrow$ \UNARY with stop bit 0\;
  \eIf{$t > 1$}{
    $p \leftarrow$ \READ $(t - 1)$ unsigned bits\;
    \Return $2 ^ {(t - 1)} + p$\;
  }{
    \Return $t$\;
  }
  \EALGORITHM
}

\subsubsection{Reading Residual Value}
{\relsize{-1}
\ALGORITHM{sub block bitstream, previous residual's unary value $u_{i - 1}$, \VAR{entropy} values for channel $c$}{a signed residual value; new unary value $u_i$, updated \VAR{entropy} values for channel $c$}
\EALGORITHM
}

\clearpage

{\relsize{-1}
\begin{algorithm}[H]
\DontPrintSemicolon
\SetKw{READ}{read}
\SetKw{UNARY}{read unary}
\SetKwData{UNDEFINED}{undefined}
\SetKwData{ENTROPY}{entropy}
\SetKwData{RESIDUAL}{residual}
\uIf(\tcc*[f]{determine new "u" and "m" values}){$u_{i - 1} = \UNDEFINED$}{
  $u_i \leftarrow$ \UNARY with stop bit 0\;
  \If{$u_i = 16$}{
    $c_i \leftarrow$ read modified Elias gamma code\;
    $u_i \leftarrow u_i + c_i$\;
  }
  $m_i \leftarrow \lfloor u_i \div 2\rfloor$\;
}
\uElseIf{$u_{i - 1} \bmod 2 = 0$}{
  $u_i \leftarrow \UNDEFINED$\;
  $m_i \leftarrow 0$\;
}
\ElseIf{$u_{i - 1} \bmod 2 = 1$}{
  $u_i \leftarrow$ \UNARY with stop bit 0\;
  \If{$u_i = 16$}{
    $c_i \leftarrow$ read modified Elias gamma code\;
    $u_i \leftarrow u_i + c_i$\;
  }
  $m_i \leftarrow \lfloor u_i \div 2\rfloor + 1$\;
}
\BlankLine
\Switch(\tcc*[f]{determine "base", "add" and new entropy values}){$m_i$}{
  \uCase{0}{
    $base \leftarrow 0$\;
    $add \leftarrow \lfloor\text{\ENTROPY}_{c~0} \div 2 ^ 4\rfloor$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} - \lfloor(\text{\ENTROPY}_{c~0} + 126) \div 2 ^ 7\rfloor \times 2$\;
  }
  \uCase{1}{
    $base \leftarrow \lfloor\text{\ENTROPY}_{c~0} \div 2 ^ 4\rfloor + 1$\;
    $add \leftarrow \lfloor\text{\ENTROPY}_{c~1} \div 2 ^ 4\rfloor$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 2 ^ 7\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} - \lfloor(\text{\ENTROPY}_{c~1} + 62) \div 2 ^ 6\rfloor \times 2$\;
  }
  \uCase{2}{
    $base \leftarrow (\lfloor\text{\ENTROPY}_{c~0} \div 2 ^ 4\rfloor + 1) + (\lfloor\text{\ENTROPY}_{c~1} \div 2 ^ 4\rfloor + 1)$\;
    $add \leftarrow \lfloor\text{\ENTROPY}_{c~2} \div 2 ^ 4\rfloor$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 2 ^ 7\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} + \lfloor(\text{\ENTROPY}_{c~1} + 64) \div 2 ^ 6\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~2} \leftarrow \text{\ENTROPY}_{c~2} - \lfloor(\text{\ENTROPY}_{c~2} + 30) \div 2 ^ 5\rfloor \times 2$\;
  }
  \Other{
    $base \leftarrow (\lfloor\text{\ENTROPY}_{c~0} \div 2 ^ 4\rfloor + 1) + (\lfloor\text{\ENTROPY}_{c~1} \div 2 ^ 4\rfloor + 1) + ((\lfloor\text{\ENTROPY}_{c~2} \div 2 ^ 4\rfloor + 1) \times (m_i - 2))$\;
    $add \leftarrow \lfloor\text{\ENTROPY}_{c~2} \div 2 ^ 4\rfloor$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 2 ^ 7\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} + \lfloor(\text{\ENTROPY}_{c~1} + 64) \div 2 ^ 6\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~2} \leftarrow \text{\ENTROPY}_{c~2} + \lfloor(\text{\ENTROPY}_{c~2} + 32) \div 2 ^ 5\rfloor \times 5$\;
  }
}
\BlankLine
\eIf(\tcc*[f]{determine final residual value}){$add = 0$}{
  $unsigned \leftarrow base$\;
}{
  $p \leftarrow \lfloor\log_2(add)\rfloor$\;
  $e \leftarrow 2 ^ {p + 1} - add - 1$\;
  $r_i \leftarrow$ \READ $p$ unsigned bits\;
  \eIf{$r \geq e$}{
    $b_i \leftarrow$ \READ 1 unsigned bit\;
    $unsigned \leftarrow base + (r_i \times 2) - e + b_i$\;
  }{
    $unsigned \leftarrow base + r_i$\;
  }
}
\BlankLine
$sign \leftarrow$ \READ 1 unsigned bit\;
\eIf{$sign = 1$}{
  \Return $(-unsigned - 1)$ along with unary value $u_i$ and updated entropy values\;
}{
  \Return $unsigned$ along with unary value $u_i$ and updated entropy values\;
}
\EALGORITHM
}

\clearpage

\begin{figure}[h]
  \includegraphics{figures/wavpack/residuals.pdf}
\end{figure}

\clearpage

\subsubsection{Residual Decoding Example}
\begin{figure}[h]
\includegraphics{figures/wavpack/residuals_parse.pdf}
\end{figure}

\clearpage

\begin{landscape}

Given a 2 channel block with $\text{entropies}_0 = \texttt{[118, 194, 322]}$ and
$\text{entropies}_1 = \texttt{[118, 176, 212]}$:
\vskip .10in

{\relsize{-2}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & u_i & m_i &
\text{base} & \text{add} & \text{entropy}_{c~0} & \text{entropy}_{c~1} & \text{entropy}_{c~2} \\
\hline
0 &
7 &
\lfloor 7 \div 2 \rfloor = 3 &
2 + \left\lfloor\frac{118}{2 ^ 4}\right\rfloor + \left\lfloor\frac{194}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{322}{2 ^ 4}\right\rfloor \times 1\right) = 42 & \left\lfloor\frac{322}{2 ^ 4}\right\rfloor = 20 & 118 + 5 = 123 & 194 + 20 = 214 & 322 + 55 = 377
\\
1 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{118}{2 ^ 4}\right\rfloor + \left\lfloor\frac{176}{2 ^ 4}\right\rfloor = 20 & \left\lfloor\frac{212}{2 ^ 4}\right\rfloor = 13 & 118 + 5 = 123 & 176 + 15 = 191 & 212 - 35 = 198
\\
\hline
2 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{123}{2 ^ 4}\right\rfloor + \left\lfloor\frac{214}{2 ^ 4}\right\rfloor = 22 & \left\lfloor\frac{377}{2 ^ 4}\right\rfloor = 23 & 123 + 5 = 128 & 214 + 20 = 234 & 377 - 60 = 353
\\
3 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{123}{2 ^ 4}\right\rfloor + \left\lfloor\frac{191}{2 ^ 4}\right\rfloor = 20 & \left\lfloor\frac{198}{2 ^ 4}\right\rfloor = 12 & 123 + 5 = 128 & 191 + 15 = 206 & 198 - 35 = 184
\\
\hline
4 &
1 &
\lfloor 1 \div 2 \rfloor + 1 = 1 &
1 + \left\lfloor\frac{128}{2 ^ 4}\right\rfloor = 9 & \left\lfloor\frac{234}{2 ^ 4}\right\rfloor = 14 & 128 + 10 = 138 & 234 - 8 = 226 & 353
\\
5 &
4 &
\lfloor 4 \div 2 \rfloor + 1 = 3 &
2 + \left\lfloor\frac{128}{2 ^ 4}\right\rfloor + \left\lfloor\frac{206}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{184}{2 ^ 4}\right\rfloor \times 1\right) = 34 & \left\lfloor\frac{184}{2 ^ 4}\right\rfloor = 11 & 128 + 10 = 138 & 206 + 20 = 226 & 184 + 30 = 214
\\
\hline
6 &
\textit{undefined} &
0 &
0 & \left\lfloor\frac{138}{2 ^ 4}\right\rfloor = 8 & 138 - 4 = 134 & 226 & 353
\\
7 &
5 &
\lfloor 5 \div 2 \rfloor = 2 &
2 + \left\lfloor\frac{138}{2 ^ 4}\right\rfloor + \left\lfloor\frac{226}{2 ^ 4}\right\rfloor = 24 & \left\lfloor\frac{214}{2 ^ 4}\right\rfloor = 13 & 138 + 10 = 148 & 226 + 20 = 246 & 214 - 35 = 200
\\
\hline
8 &
1 &
\lfloor 1 \div 2 \rfloor + 1 = 1 &
1 + \left\lfloor\frac{134}{2 ^ 4}\right\rfloor = 9 & \left\lfloor\frac{226}{2 ^ 4}\right\rfloor = 14 & 134 + 10 = 144 & 226 - 8 = 218 & 353
\\
9 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{148}{2 ^ 4}\right\rfloor + \left\lfloor\frac{246}{2 ^ 4}\right\rfloor = 26 & \left\lfloor\frac{200}{2 ^ 4}\right\rfloor = 12 & 148 + 10 = 158 & 246 + 20 = 266 & 200 - 35 = 186
\\
\hline
10 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{144}{2 ^ 4}\right\rfloor + \left\lfloor\frac{218}{2 ^ 4}\right\rfloor = 24 & \left\lfloor\frac{353}{2 ^ 4}\right\rfloor = 22 & 144 + 10 = 154 & 218 + 20 = 238 & 353 - 55 = 331
\\
11 &
3 &
\lfloor 3 \div 2 \rfloor + 1 = 2 &
2 + \left\lfloor\frac{158}{2 ^ 4}\right\rfloor + \left\lfloor\frac{266}{2 ^ 4}\right\rfloor = 27 & \left\lfloor\frac{186}{2 ^ 4}\right\rfloor = 11 & 158 + 10 = 168 & 266 + 25 = 291 & 186 - 30 = 174
\\
\hline
12 &
5 &
\lfloor 5 \div 2 \rfloor + 1 = 3 &
2 + \left\lfloor\frac{154}{2 ^ 4}\right\rfloor + \left\lfloor\frac{238}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{331}{2 ^ 4}\right\rfloor \times 1\right) = 46 & \left\lfloor\frac{331}{2 ^ 4}\right\rfloor = 20 & 154 + 10 = 164 & 238 + 20 = 258 & 331 + 55 = 386
\\
13 &
1 &
\lfloor 1 \div 2 \rfloor + 1 = 1 &
1 + \left\lfloor\frac{168}{2 ^ 4}\right\rfloor = 11 & \left\lfloor\frac{291}{2 ^ 4}\right\rfloor = 18 & 168 + 10 = 178 & 291 - 10 = 281 & 174
\\
\hline
14 &
5 &
\lfloor 5 \div 2 \rfloor + 1 = 3 &
2 + \left\lfloor\frac{164}{2 ^ 4}\right\rfloor + \left\lfloor\frac{258}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{386}{2 ^ 4}\right\rfloor \times 1\right) = 53 & \left\lfloor\frac{386}{2 ^ 4}\right\rfloor = 24 & 164 + 10 = 174 & 258 + 25 = 283 & 386 + 65 = 451
\\
15 &
1 &
\lfloor 1 \div 2 \rfloor + 1 = 1 &
1 + \left\lfloor\frac{178}{2 ^ 4}\right\rfloor = 12 & \left\lfloor\frac{281}{2 ^ 4}\right\rfloor = 17 & 178 + 10 = 188 & 281 - 10 = 271 & 174
\\
\hline
16 &
4 &
\lfloor 4 \div 2 \rfloor + 1 = 3 &
2 + \left\lfloor\frac{174}{2 ^ 4}\right\rfloor + \left\lfloor\frac{283}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{451}{2 ^ 4}\right\rfloor \times 1\right) = 58 & \left\lfloor\frac{451}{2 ^ 4}\right\rfloor = 28 & 174 + 10 = 184 & 283 + 25 = 308 & 451 + 75 = 526
\\
17 &
\textit{undefined} &
0 &
0 & \left\lfloor\frac{188}{2 ^ 4}\right\rfloor = 11 & 188 - 4 = 184 & 271 & 174
\\
\hline
18 &
6 &
\lfloor 6 \div 2 \rfloor = 3 &
2 + \left\lfloor\frac{184}{2 ^ 4}\right\rfloor + \left\lfloor\frac{308}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{526}{2 ^ 4}\right\rfloor \times 1\right) = 65 & \left\lfloor\frac{526}{2 ^ 4}\right\rfloor = 32 & 184 + 10 = 194 & 308 + 25 = 333 & 526 + 85 = 611
\\
19 &
\textit{undefined} &
0 &
0 & \left\lfloor\frac{184}{2 ^ 4}\right\rfloor = 11 & 184 - 4 = 180 & 271 & 174
\\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}

\clearpage

\begin{table}[h]
{\relsize{-2}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & \text{base} & \text{add} & p & e & r_i & b_i & unsigned & sign_i & residual_i \\
\hline
0 &
42 & 20 &
\lfloor\log_2(20)\rfloor = 4 &
2 ^ {4 + 1} - 20 - 1 = 11 &
14 &
1 & 42 + (14 \times 2) - 11 + 1 = 60 &
1 & -60 - 1 = -61
\\
1 &
20 & 13 &
\lfloor\log_2(13)\rfloor = 3 &
2 ^ {3 + 1} - 13 - 1 = 2 &
6 &
1 & 20 + (6 \times 2) - 2 + 1 = 31 &
0 & 31
\\
\hline
2 &
22 & 23 &
\lfloor\log_2(23)\rfloor = 4 &
2 ^ {4 + 1} - 23 - 1 = 8 &
9 &
0 & 22 + (9 \times 2) - 8 + 0 = 32 &
1 & -32 - 1 = -33
\\
3 &
20 & 12 &
\lfloor\log_2(12)\rfloor = 3 &
2 ^ {3 + 1} - 12 - 1 = 3 &
7 &
1 & 20 + (7 \times 2) - 3 + 1 = 32 &
0 & 32
\\
\hline
4 &
9 & 14 &
\lfloor\log_2(14)\rfloor = 3 &
2 ^ {3 + 1} - 14 - 1 = 1 &
4 &
1 & 9 + (4 \times 2) - 1 + 1 = 17 &
1 & -17 - 1 = -18
\\
5 &
34 & 11 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {3 + 1} - 11 - 1 = 4 &
2 &
 & 34 + 2 = 36 &
0 & 36
\\
\hline
6 &
0 & 8 &
\lfloor\log_2(8)\rfloor = 3 &
2 ^ {3 + 1} - 8 - 1 = 7 &
1 &
 & 0 + 1 = 1 &
0 & 1
\\
7 &
24 & 13 &
\lfloor\log_2(13)\rfloor = 3 &
2 ^ {3 + 1} - 13 - 1 = 2 &
7 &
1 & 24 + (7 \times 2) - 2 + 1 = 37 &
0 & 37
\\
\hline
8 &
9 & 14 &
\lfloor\log_2(14)\rfloor = 3 &
2 ^ {3 + 1} - 14 - 1 = 1 &
6 &
0 & 9 + (6 \times 2) - 1 + 0 = 20 &
0 & 20
\\
9 &
26 & 12 &
\lfloor\log_2(12)\rfloor = 3 &
2 ^ {3 + 1} - 12 - 1 = 3 &
6 &
0 & 26 + (6 \times 2) - 3 + 0 = 35 &
0 & 35
\\
\hline
10 &
24 & 22 &
\lfloor\log_2(22)\rfloor = 4 &
2 ^ {4 + 1} - 22 - 1 = 9 &
10 &
0 & 24 + (10 \times 2) - 9 + 0 = 35 &
0 & 35
\\
11 &
27 & 11 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {3 + 1} - 11 - 1 = 4 &
4 &
0 & 27 + (4 \times 2) - 4 + 0 = 31 &
0 & 31
\\
\hline
12 &
46 & 20 &
\lfloor\log_2(20)\rfloor = 4 &
2 ^ {4 + 1} - 20 - 1 = 11 &
4 &
 & 46 + 4 = 50 &
0 & 50
\\
13 &
11 & 18 &
\lfloor\log_2(18)\rfloor = 4 &
2 ^ {4 + 1} - 18 - 1 = 13 &
13 &
1 & 11 + (13 \times 2) - 13 + 1 = 25 &
0 & 25
\\
\hline
14 &
53 & 24 &
\lfloor\log_2(24)\rfloor = 4 &
2 ^ {4 + 1} - 24 - 1 = 7 &
8 &
0 & 53 + (8 \times 2) - 7 + 0 = 62 &
0 & 62
\\
15 &
12 & 17 &
\lfloor\log_2(17)\rfloor = 4 &
2 ^ {4 + 1} - 17 - 1 = 14 &
6 &
 & 12 + 6 = 18 &
0 & 18
\\
\hline
16 &
58 & 28 &
\lfloor\log_2(28)\rfloor = 4 &
2 ^ {4 + 1} - 28 - 1 = 3 &
6 &
1 & 58 + (6 \times 2) - 3 + 1 = 68 &
0 & 68
\\
17 &
0 & 11 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {3 + 1} - 11 - 1 = 4 &
7 &
0 & 0 + (7 \times 2) - 4 + 0 = 10 &
0 & 10
\\
\hline
18 &
65 & 32 &
\lfloor\log_2(32)\rfloor = 5 &
2 ^ {5 + 1} - 32 - 1 = 31 &
6 &
 & 65 + 6 = 71 &
0 & 71
\\
19 &
0 & 11 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {3 + 1} - 11 - 1 = 4 &
0 &
 & 0 + 0 = 0 &
0 & 0
\\
\hline
\end{tabular}
}
\end{table}
\par
\noindent
Resulting in:
\newline
\begin{tabular}{rr}
channel 0 residuals : & \texttt{[-61,~-33,~-18,~~1,~20,~35,~50,~62,~68,~71]}\\
channel 1 residuals : & \texttt{[~31,~~32,~~36,~37,~35,~31,~25,~18,~10,~~0]}\\
\end{tabular}

\clearpage

\subsubsection{2nd Residual Decoding Example}
Given a 1 channel block with $\text{entropies}_0 = \texttt{[0, 0, 0]}$:
\vskip .10in
{\relsize{-2}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & u_i & m_i &
\text{base} & \text{add} & \text{entropy}_{0~0} & \text{entropy}_{0~1} & \text{entropy}_{0~2} \\
\hline
& \multicolumn{7}{c|}{read modified Elias gamma code: $t \leftarrow 0~,~\text{zeroes} \leftarrow 0$} \\
0 &
3 & \lfloor 3 \div 2\rfloor = 1 &
1 + \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 1 &
\left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
0 + 5 = 5 & 0 - 0 = 0 & 0
\\
1 &
3 & \lfloor 3 \div 2\rfloor + 1 = 2 &
2 + \left\lfloor\frac{5}{2 ^ 4}\right\rfloor + \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 2 &
\left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
5 + 5 = 10 & 0 + 5 = 5 & 0 - 0 = 0
\\
2 &
5 & \lfloor 5 \div 2\rfloor + 1 = 3 &
2 + \left\lfloor\frac{10}{2 ^ 4}\right\rfloor + \left\lfloor\frac{5}{2 ^ 4}\right\rfloor + \left(\left\lfloor\frac{0}{2 ^ 4}\right\rfloor \times 1\right) = 3 &
\left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
10 + 5 = 15 & 5 + 5 = 10 & 0 + 5 = 5
\\
3 &
2 & \lfloor 2 \div 2\rfloor + 1 = 2 &
2 + \left\lfloor\frac{15}{2 ^ 4}\right\rfloor + \left\lfloor\frac{10}{2 ^ 4}\right\rfloor = 2 &
\left\lfloor\frac{5}{2 ^ 4}\right\rfloor = 0 &
15 + 5 = 20 & 10 + 5 = 15 & 5 - 2 = 3
\\
4 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{20}{2 ^ 4}\right\rfloor = 1 &
20 - 2 = 18 & 15 & 3
\\
5 &
0 & \lfloor 0 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{18}{2 ^ 4}\right\rfloor = 1 &
18 - 2 = 16 & 15 & 3
\\
6 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{16}{2 ^ 4}\right\rfloor = 1 &
16 - 2 = 14 & 15 & 3
\\
7 &
0 & \lfloor 0 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{14}{2 ^ 4}\right\rfloor = 0 &
14 - 2 = 12 & 15 & 3
\\
8 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{12}{2 ^ 4}\right\rfloor = 0 &
12 - 2 = 10 & 15 & 3
\\
9 &
0 & \lfloor 0 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{10}{2 ^ 4}\right\rfloor = 0 &
10 - 2 = 8 & 15 & 3
\\
10 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{8}{2 ^ 4}\right\rfloor = 0 &
8 - 2 = 6 & 15 & 3
\\
11 &
0 & \lfloor 0 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{6}{2 ^ 4}\right\rfloor = 0 &
6 - 2 = 4 & 15 & 3
\\
12 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{4}{2 ^ 4}\right\rfloor = 0 &
4 - 2 = 2 & 15 & 3
\\
13 &
0 & \lfloor 0 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{2}{2 ^ 4}\right\rfloor = 0 &
2 - 2 = 0 & 15 & 3
\\
14 &
\textit{\color{red}undefined} & 0 &
0 & \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
0 - 0 = {\color{red}0} & 15 & 3
\\
15-24 & \multicolumn{7}{c|}{read modified Elias gamma code: $t \leftarrow 4~,~p \leftarrow 2~,~\text{zeroes} \leftarrow 2 ^ {(4 - 1)} + 2 = 10$} \\
25 &
1 & \lfloor 1 \div 2\rfloor = 0 &
0 & \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
0 - 0 = 0 & 0 & 0
\\
26 &
1 & \lfloor 1 \div 2\rfloor + 1 = 1 &
1 + \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 1 &
\left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
0 + 5 = 5 & 0 - 0 = 0 & 0
\\
27 &
3 & \lfloor 3 \div 2\rfloor + 1 = 2 &
2 + \left\lfloor\frac{5}{2 ^ 4}\right\rfloor + \left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 2 &
\left\lfloor\frac{0}{2 ^ 4}\right\rfloor = 0 &
5 + 5 = 10 & 0 + 5 = 5 & 0 - 0 = 0
\\
28 &
0 & \lfloor 0 \div 2\rfloor + 1 = 1 &
1 + \left\lfloor\frac{10}{2 ^ 4}\right\rfloor = 1 &
\left\lfloor\frac{5}{2 ^ 4}\right\rfloor = 0 &
10 + 5 = 15 & 5 - 2 = 3 & 0
\\
29 &
\textit{undefined} & 0 &
0 & \left\lfloor\frac{15}{2 ^ 4}\right\rfloor = 0 &
15 - 2 = 13 & 3 & 0
\\
\hline
\end{tabular}
}

\clearpage

\begin{table}[h]
{\relsize{-2}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & \text{base} & \text{add} & p & e & r_i & b_i & unsigned & sign_i & residual_i \\
\hline
0 &
1 & 0 &
& & & & 1 &
0 & 1
\\
1 &
2 & 0 &
& & & & 2 &
0 & 2
\\
2 &
3 & 0 &
& & & & 3 &
0 & 3
\\
3 &
2 & 0 &
& & & & 2 &
0 & 2
\\
4 &
0 & 1 &
\lfloor\log_2(1)\rfloor = 0 &
2 ^ {0 + 1} - 1 - 1 = 0 &
0 &
1 & 0 + (0 \times 2) - 0 + 1 = 1 &
0 & 1
\\
5 &
0 & 1 &
\lfloor\log_2(1)\rfloor = 0 &
2 ^ {0 + 1} - 1 - 1 = 0 &
0 &
0 & 0 + (0 \times 2) - 0 + 0 = 0 &
0 & 0
\\
6 &
0 & 1 &
\lfloor\log_2(1)\rfloor = 0 &
2 ^ {0 + 1} - 1 - 1 = 0 &
0 &
0 & 0 + (0 \times 2) - 0 + 0 = 0 &
0 & 0
\\
7 &
0 & 0 &
& & & & 0 &
0 & 0
\\
8 &
0 & 0 &
& & & & 0 &
0 & 0
\\
9 &
0 & 0 &
& & & & 0 &
0 & 0
\\
10 &
0 & 0 &
& & & & 0 &
0 & 0
\\
11 &
0 & 0 &
& & & & 0 &
0 & 0
\\
12 &
0 & 0 &
& & & & 0 &
0 & 0
\\
13 &
0 & 0 &
& & & & 0 &
0 & 0
\\
14 &
0 & 0 &
& & & & 0 &
0 & 0
\\
15-24 & \multicolumn{8}{c|}{long run of 10, 0 residual values} & 0 \\
25 &
0 & 0 &
& & & & 0 &
1 & -0 - 1 = -1
\\
26 &
1 & 0 &
& & & & 1 &
1 & -1 - 1 = -2
\\
27 &
2 & 0 &
& & & & 2 &
1 & -2 - 1 = -3
\\
28 &
1 & 0 &
& & & & 1 &
1 & -1 - 1 = -2
\\
29 &
0 & 0 &
& & & & 0 &
1 & -0 - 1 = -1
\\
\hline
\end{tabular}
}
\end{table}
\par
\noindent
{\relsize{-1}
Resulting in channel 0 residuals:
\newline
\texttt{[~~1,~~2,~~3,~~2,~~1,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~~0,~-1,~-2,~-3,~-2,~-1]}
}

\end{landscape}

\begin{figure}[h]
\includegraphics{figures/wavpack/residuals_parse2.pdf}
\caption{2nd residual parsing example}
\end{figure}

\subsection{Channel Decorrelation}
\label{wavpack:decorrelate_channels}
\ALGORITHM{a list of signed residuals per channel, a list of decorrelation terms and deltas, a decorrelation weight per term and channel, a list of decorrelation samples per term and channel}{a list of signed samples per channel}
\SetKwData{TERMCOUNT}{term count}
\SetKwData{PASS}{pass}
\SetKwData{TERM}{term}
\SetKwData{DELTA}{delta}
\SetKwData{WEIGHT}{weight}
\SetKwData{SAMPLES}{sample}
\SetKwData{RESIDUALS}{residual}
\eIf{$\text{channel count} = 1$}{
  $\text{\PASS}_{(-1)~0} \leftarrow \text{\RESIDUALS}_{0}$\;
  \For{$p \leftarrow 0$ \emph{\KwTo}\TERMCOUNT}{
    $\text{\PASS}_{p} \leftarrow$ \hyperref[wavpack:decorr_pass_1ch]{decorrelate 1 channel $\text{\PASS}_{(p - 1)}$} using $\left\lbrace\begin{tabular}{l}
    $\text{\TERM}_{p}$ \\
    $\text{\DELTA}_{p}$ \\
    $\text{\WEIGHT}_{p~0}$ \\
    $\text{\SAMPLES}_{p~0}$ \\
    \end{tabular}\right.$\;
  }
  \Return $\text{\PASS}_{(\text{\TERMCOUNT} - 1)~0}$\;
}{
  $\text{\PASS}_{-1~0} \leftarrow \text{\RESIDUALS}_{0}$\;
  $\text{\PASS}_{-1~1} \leftarrow \text{\RESIDUALS}_{1}$\;
  \For{$p \leftarrow 0$ \emph{\KwTo}\TERMCOUNT}{
    $\text{\PASS}_{p} \leftarrow$ \hyperref[wavpack:decorr_pass_2ch]{decorrelate 2 channel $\text{\PASS}_{(p - 1)}$} using $\left\lbrace\begin{tabular}{l}
    $\text{\TERM}_{p}$ \\
    $\text{\DELTA}_{p}$ \\
    $\text{\WEIGHT}_{p~0}$ \\
    $\text{\WEIGHT}_{p~1}$ \\
    $\text{\SAMPLES}_{p~0}$ \\
    $\text{\SAMPLES}_{p~1}$ \\
    \end{tabular}\right.$\;
  }
  \Return $\text{\PASS}_{(\text{\TERMCOUNT} - 1)~0}$ and $\text{\PASS}_{(\text{\TERMCOUNT} - 1)~1}$\;
}
\EALGORITHM

\clearpage

\subsubsection{Visualizing Decorrelation Passes}

This is an example of a relatively small set of residuals
being transformed back into a set of samples
over the course of 5 decorrelation passes.
What's important to note is that each pass
adjusts the residual values' overall range.
The number of these passes and their decorrelation terms
are what separate high levels of WavPack compression from low levels.

\begin{figure}[h]
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation0.pdf}
  }
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation1.pdf}
  }
  \newline
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation2.pdf}
  }
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation3.pdf}
  }
  \newline
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation4.pdf}
  }
  \subfloat{
    \includegraphics{figures/wavpack/decorrelation5.pdf}
  }
\end{figure}


\clearpage

\subsubsection{1 Channel Decorrelation Pass}
\label{wavpack:decorr_pass_1ch}
{\relsize{-1}
\ALGORITHM{a list of signed correlated samples, decorrelation term and delta, decorrelation weight, list of decorrelation samples}{a list of signed decorrelated samples}
\SetKwData{CORRELATED}{correlated}
\SetKwData{DECORRELATED}{decorrelated}
\SetKwData{DECORRSAMPLE}{decorrelation sample}
\SetKwData{WEIGHT}{weight}
\SetKwData{TEMP}{temp}
\SetKw{OR}{or}
\SetKw{XOR}{xor}
\SetKwFunction{APPLYWEIGHT}{apply\_weight}
\SetKwFunction{UPDATEWEIGHT}{update\_weight}
$\text{\WEIGHT}_0 \leftarrow$ decorrelation weight\;
\BlankLine
\uIf{$term = 18$}{
  $\text{\DECORRELATED}_0 \leftarrow \text{\DECORRSAMPLE}_1$\;
  $\text{\DECORRELATED}_1 \leftarrow \text{\DECORRSAMPLE}_0$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
    $\text{\TEMP}_{i} \leftarrow \lfloor(3 \times \text{\DECORRELATED}_{i + 1} - \text{\DECORRELATED}_{i}) \div 2 \rfloor$\;
    $\text{\DECORRELATED}_{i + 2} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\TEMP}_{i}) + \text{\CORRELATED}_i$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\TEMP}_{i}~,~\text{\CORRELATED}_i~,~delta)$\;
  }
  \Return \DECORRELATED samples starting from 2\;
}
\uElseIf{$term = 17$}{
  $\text{\DECORRELATED}_0 \leftarrow \text{\DECORRSAMPLE}_1$\;
  $\text{\DECORRELATED}_1 \leftarrow \text{\DECORRSAMPLE}_0$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
    $\text{\TEMP}_{i} \leftarrow 2 \times \text{\DECORRELATED}_{i + 1} - \text{\DECORRELATED}_{i}$\;
    $\text{\DECORRELATED}_{i + 2} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\TEMP}_{i}) + \text{\CORRELATED}_i$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\TEMP}_{i}~,~\text{\CORRELATED}_i~,~delta)$\;
  }
  \Return \DECORRELATED samples starting from 2\;
}
\uElseIf{$1 \leq term \leq 8$}{
  \For{$i \leftarrow 0$ \emph{\KwTo}term}{
    $\text{\DECORRELATED}_i \leftarrow \text{\DECORRSAMPLE}_i$\;
  }
  \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
    $\text{\DECORRELATED}_{i + term} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\DECORRELATED}_{i}) + \text{\CORRELATED}_i$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\DECORRELATED}_{i}~,~\text{\CORRELATED}_i~,~delta)$\;
  }
  \BlankLine
  \Return \DECORRELATED samples starting from $term$\;
}
\Else{
  invalid decorrelation term\;
}
\EALGORITHM
\par
\noindent
\begin{align*}
\intertext{where \texttt{apply\_weight} is defined as:}
\texttt{apply\_weight}(weight~,~sample) &= \left\lfloor\frac{weight \times sample + 2 ^ 9}{2 ^ {10}}\right\rfloor \\
\intertext{and \texttt{update\_weight} is defined as:}
\texttt{update\_weight}(source~,~result~,~delta) &=
\begin{cases}
0 & \text{ if } source = 0 \text{ or } result = 0 \\
delta & \text{ if } (source \textbf{ xor } result ) \geq 0 \\
-delta & \text{ if } (source \textbf{ xor } result) < 0
\end{cases}
\end{align*}

}

\clearpage

\subsubsection{2 Channel Decorrelation Pass}
\label{wavpack:decorr_pass_2ch}
{\relsize{-1}
\ALGORITHM{2 lists of signed correlated samples, decorrelation term and delta, 2 decorrelation weights, 2 lists of decorrelation samples}{2 lists of signed decorrelated samples}
\SetKwData{CORRELATED}{correlated}
\SetKwData{DECORRELATED}{decorrelated}
\SetKwData{DECORRSAMPLE}{decorrelation sample}
\SetKwData{WEIGHT}{weight}
\SetKw{OR}{or}
\SetKw{XOR}{xor}
\SetKwFunction{MIN}{min}
\SetKwFunction{MAX}{max}
\SetKwFunction{APPLYWEIGHT}{apply\_weight}
\SetKwFunction{UPDATEWEIGHT}{update\_weight}
\uIf{$17 \leq term \leq 18$ \OR $1 \leq term \leq 8$}{
  $\text{\DECORRELATED}_0 \leftarrow$ 1 channel decorrelation pass of $\text{\CORRELATED}_0$\;
  $\text{\DECORRELATED}_1 \leftarrow$ 1 channel decorrelation pass of $\text{\CORRELATED}_1$\;
  \Return $\text{\DECORRELATED}_0$ and $\text{\DECORRELATED}_1$\;
}
\uElseIf{$-3 \leq term \leq -1$}{
  $\text{\WEIGHT}_{0~0} \leftarrow$ decorrelation weight 0\;
  $\text{\WEIGHT}_{1~0} \leftarrow$ decorrelation weight 1\;
  $\text{\DECORRELATED}_{0~0} \leftarrow \text{\DECORRSAMPLE}_{1~0}$\;
  $\text{\DECORRELATED}_{1~0} \leftarrow \text{\DECORRSAMPLE}_{0~0}$\;
  \uIf{$term = -1$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
      $\text{\DECORRELATED}_{0~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~i}) + \text{\CORRELATED}_{0~i}$\;
      $\text{\DECORRELATED}_{1~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~(i + 1)}) + \text{\CORRELATED}_{1~i}$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~i}~,~\text{\CORRELATED}_{0~i}~,~delta)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~(i + 1)}~,~\text{\CORRELATED}_{1~i}~,~delta)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \uElseIf{$term = -2$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
      $\text{\DECORRELATED}_{1~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~i}) + \text{\CORRELATED}_{1~i}$\;
      $\text{\DECORRELATED}_{0~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~(i + 1)}) + \text{\CORRELATED}_{0~i}$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~i}~,~\text{\CORRELATED}_{1~i}~,~delta)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~(i + 1)},~\text{\CORRELATED}_{0~i}~,~delta)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \ElseIf{$term = -3$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
      $\text{\DECORRELATED}_{0~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~i}) + \text{\CORRELATED}_{0~i}$\;
      $\text{\DECORRELATED}_{1~(i + 1)} \leftarrow \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~i}) + \text{\CORRELATED}_{1~i}$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~i}~,~\text{\CORRELATED}_{0~i}~,~delta)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~i}~,~\text{\CORRELATED}_{1~i}~,~delta)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \Return $\text{\DECORRELATED}_0$ starting from 1 and $\text{\DECORRELATED}_1$ starting from 1\;
}
\Else{
  invalid decorrelation term\;
}
\EALGORITHM
}

\clearpage

\subsubsection{Channel Decorrelation Example}
Given the values from the \VAR{Decorrelation Terms},
\VAR{Decorrelation Weights} and \VAR{Decorrelation Samples}
sub blocks:
\begin{figure}[h]
{\relsize{-1}
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Decorrelation Terms} \\
      \hline
      $p$ & $\textsf{term}_p$ & $\textsf{delta}_p$ \\
      \hline
      4 & 18 & 2 \\
      3 & 18 & 2 \\
      2 & 2 & 2 \\
      1 & 17 & 2 \\
      0 & 3 & 2 \\
      \hline
    \end{tabular}
  }
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Decorrelation Weights} \\
      \hline
      $p$ & $\textsf{weight}_{p~0}$ & $\textsf{weight}_{p~1}$ \\
      \hline
      4 & 48 & 48 \\
      3 & 48 & 48 \\
      2 & 32 & 32 \\
      1 & 48 & 48 \\
      0 & 16 & 24 \\
      \hline
    \end{tabular}
  }
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Decorrelation Samples} \\
      \hline
      $p$ & $\textsf{sample}_{p~0~s}$ & $\textsf{sample}_{p~1~s}$ \\
      \hline
      4 & \texttt{[-73, -78]} & \texttt{[28, 26]} \\
      3 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      2 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      1 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      0 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
      \hline
    \end{tabular}
  }
}
\end{figure}
\par
\noindent
we combine them into a single set of arguments for each decorrelation pass:
\begin{table}[h]
{\relsize{-1}
  \begin{tabular}{|r|r|r|r|r|r|}
    \hline
    & $\textbf{pass}_0$ & $\textbf{pass}_1$ & $\textbf{pass}_2$ &
    $\textbf{pass}_3$ & $\textbf{pass}_4$ \\
    \hline
    $\textsf{term}_p$ & 3 & 17 & 2 & 18 & 18 \\
    $\textsf{delta}_p$ & 2 & 2 & 2 & 2 & 2 \\
    $\textsf{weight}_{p~0}$ & 16 & 48 & 32 & 48 & 48 \\
    $\textsf{sample}_{p~0~s}$ & \texttt{[0, 0, 0]} & \texttt{[0, 0]} &
    \texttt{[0, 0]} & \texttt{[0, 0]} & \texttt{[-73, -78]} \\
    $\textsf{weight}_{p~1}$ & 24 & 48 & 32 & 48 & 48 \\
    $\textsf{sample}_{p~1~s}$ & \texttt{[0, 0, 0]} & \texttt{[0, 0]} &
    \texttt{[0, 0]} & \texttt{[0, 0]} & \texttt{[28, 26]} \\
    \hline
  \end{tabular}
}
\end{table}
\par
\noindent
which we apply to the residuals from the bitstream sub-block:
\par
\noindent
{\relsize{-1}
  \begin{tabular}{|r|r|r|r|r|r|}
    \hline
    $\textsf{residual}_{0~i}$ &
    after $\textbf{pass}_0$ &
    after $\textbf{pass}_1$ &
    after $\textbf{pass}_2$ &
    after $\textbf{pass}_3$ &
    after $\textbf{pass}_4$ \\
    \hline
    -61 & -61 & -61 & -61 & -61 & -64 \\
    -33 & -33 & -39 & -39 & -43 & -46 \\
    -18 & -18 & -19 & -21 & -23 & -25 \\
    1 & 0 & 0 & -1 & -2 & -3 \\
    20 & 20 & 21 & 20 & 20 & 20 \\
    35 & 35 & 37 & 37 & 39 & 41 \\
    50 & 50 & 53 & 54 & 57 & 60 \\
    62 & 62 & 66 & 67 & 71 & 75 \\
    68 & 68 & 73 & 75 & 80 & 85 \\
    71 & 72 & 77 & 79 & 84 & 90 \\
    \hline
    \hline
    $\textsf{residual}_{1~i}$ &
    after $\textbf{pass}_0$ &
    after $\textbf{pass}_1$ &
    after $\textbf{pass}_2$ &
    after $\textbf{pass}_3$ &
    after $\textbf{pass}_4$ \\
    \hline
    31 & 31 & 31 & 31 & 31 & 32 \\
    32 & 32 & 35 & 35 & 37 & 39 \\
    36 & 36 & 38 & 39 & 41 & 43 \\
    37 & 38 & 40 & 41 & 43 & 45 \\
    35 & 36 & 38 & 39 & 41 & 44 \\
    31 & 32 & 34 & 36 & 38 & 40 \\
    25 & 26 & 28 & 30 & 32 & 34 \\
    18 & 19 & 20 & 21 & 23 & 25 \\
    10 & 11 & 12 & 13 & 14 & 15 \\
    0 & 1 & 1 & 2 & 3 & 4 \\
    \hline
  \end{tabular}
}
\par
\noindent
Resulting in final decorrelated samples:
\newline
\begin{tabular}{rr}
$\textsf{channel}_0$ : & \texttt{[-64,~-46,~-25,~-3,~20,~41,~60,~75,~85,~90]} \\
$\textsf{channel}_1$ : & \texttt{[~32,~~39,~~43,~45,~44,~40,~34,~25,~15,~~4]} \\
\end{tabular}

\clearpage

{\relsize{-2}
\begin{tabular}{r||r|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
%% \multicolumn{5}{c}{\textbf{pass 0} - term 3 - delta 2 - weight 16} \\
& $i$ & \textsf{correlated}_i & \textsf{temp}_i & \textsf{decorrelated}_{i + 3} & \textsf{weight}_{i + 1} \\
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_0$ - term 3\end{sideways}}
& 0 & -61 & &
\lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 61 = -61 &
16 + 0 = 16
\\
& 1 & -33 & &
\lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 33 = -33 &
16 + 0 = 16
\\
& 2 & -18 & &
\lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 18 = -18 &
16 + 0 = 16
\\
& 3 & 1 & &
\lfloor(16 \times -61 + 2 ^ 9) \div 2 ^ {10}\rfloor + 1 = 0 &
16 - 2 = 14
\\
& 4 & 20 & &
\lfloor(14 \times -33 + 2 ^ 9) \div 2 ^ {10}\rfloor + 20 = 20 &
14 - 2 = 12
\\
& 5 & 35 & &
\lfloor(12 \times -18 + 2 ^ 9) \div 2 ^ {10}\rfloor + 35 = 35 &
12 - 2 = 10
\\
& 6 & 50 & &
\lfloor(10 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor + 50 = 50 &
10 + 0 = 10
\\
& 7 & 62 & &
\lfloor(10 \times 20 + 2 ^ 9) \div 2 ^ {10}\rfloor + 62 = 62 &
10 + 2 = 12
\\
& 8 & 68 & &
\lfloor(12 \times 35 + 2 ^ 9) \div 2 ^ {10}\rfloor + 68 = 68 &
12 + 2 = 14
\\
& 9 & 71 & &
\lfloor(14 \times 50 + 2 ^ 9) \div 2 ^ {10}\rfloor + 71 = 72 &
14 + 2 = 16
\\
\hline
\hline
%% \multicolumn{5}{c}{\textbf{pass 1 } - term 17 - delta 2 - weight 48} \\
& $i$ & \textsf{correlated}_i & \textsf{temp}_i & \textsf{decorrelated}_{i + 2} & \textsf{weight}_{i + 1} \\
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_1$ - term 17\end{sideways}}
& 0 & -61 &
2 \times 0 - 0 = 0 &
\lfloor(48 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 61 = -61 &
48 + 0 = 48
\\
& 1 & -33 &
2 \times -61 - 0 = -122 &
\lfloor(48 \times -122 + 2 ^ 9) \div 2 ^ {10}\rfloor - 33 = -39 &
48 + 2 = 50
\\
& 2 & -18 &
2 \times -39 + 61 = -17 &
\lfloor(50 \times -17 + 2 ^ 9) \div 2 ^ {10}\rfloor - 18 = -19 &
50 + 2 = 52
\\
& 3 & 0 &
2 \times -19 + 39 = 1 &
\lfloor(52 \times 1 + 2 ^ 9) \div 2 ^ {10}\rfloor + 0 = 0 &
52 + 0 = 52
\\
& 4 & 20 &
2 \times 0 + 19 = 19 &
\lfloor(52 \times 19 + 2 ^ 9) \div 2 ^ {10}\rfloor + 20 = 21 &
52 + 2 = 54
\\
& 5 & 35 &
2 \times 21 - 0 = 42 &
\lfloor(54 \times 42 + 2 ^ 9) \div 2 ^ {10}\rfloor + 35 = 37 &
54 + 2 = 56
\\
& 6 & 50 &
2 \times 37 - 21 = 53 &
\lfloor(56 \times 53 + 2 ^ 9) \div 2 ^ {10}\rfloor + 50 = 53 &
56 + 2 = 58
\\
& 7 & 62 &
2 \times 53 - 37 = 69 &
\lfloor(58 \times 69 + 2 ^ 9) \div 2 ^ {10}\rfloor + 62 = 66 &
58 + 2 = 60
\\
& 8 & 68 &
2 \times 66 - 53 = 79 &
\lfloor(60 \times 79 + 2 ^ 9) \div 2 ^ {10}\rfloor + 68 = 73 &
60 + 2 = 62
\\
& 9 & 72 &
2 \times 73 - 66 = 80 &
\lfloor(62 \times 80 + 2 ^ 9) \div 2 ^ {10}\rfloor + 72 = 77 &
62 + 2 = 64
\\
\hline
\hline
%% \multicolumn{5}{c}{\textbf{pass 2 } - term 2 - delta 2 - weight 32} \\
& $i$ & \textsf{correlated}_i & \textsf{temp}_i & \textsf{decorrelated}_{i + 2} & \textsf{weight}_{i + 1} \\
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_2$ - term 2\end{sideways}}
& 0 & -61 & &
\lfloor(32 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 61 = -61 &
32 + 0 = 32
\\
& 1 & -39 & &
\lfloor(32 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 39 = -39 &
32 + 0 = 32
\\
& 2 & -19 & &
\lfloor(32 \times -61 + 2 ^ 9) \div 2 ^ {10}\rfloor - 19 = -21 &
32 + 2 = 34
\\
& 3 & 0 & &
\lfloor(34 \times -39 + 2 ^ 9) \div 2 ^ {10}\rfloor + 0 = -1 &
34 + 0 = 34
\\
& 4 & 21 & &
\lfloor(34 \times -21 + 2 ^ 9) \div 2 ^ {10}\rfloor + 21 = 20 &
34 - 2 = 32
\\
& 5 & 37 & &
\lfloor(32 \times -1 + 2 ^ 9) \div 2 ^ {10}\rfloor + 37 = 37 &
32 - 2 = 30
\\
& 6 & 53 & &
\lfloor(30 \times 20 + 2 ^ 9) \div 2 ^ {10}\rfloor + 53 = 54 &
30 + 2 = 32
\\
& 7 & 66 & &
\lfloor(32 \times 37 + 2 ^ 9) \div 2 ^ {10}\rfloor + 66 = 67 &
32 + 2 = 34
\\
& 8 & 73 & &
\lfloor(34 \times 54 + 2 ^ 9) \div 2 ^ {10}\rfloor + 73 = 75 &
34 + 2 = 36
\\
& 9 & 77 & &
\lfloor(36 \times 67 + 2 ^ 9) \div 2 ^ {10}\rfloor + 77 = 79 &
36 + 2 = 38
\\
\hline
\hline
%% \multicolumn{5}{c}{\textbf{pass 3 } - term 18 - delta 2 - weight 48} \\
& $i$ & \textsf{correlated}_i & \textsf{temp}_i & \textsf{decorrelated}_{i + 2} & \textsf{weight}_{i + 1} \\
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_3$ - term 18\end{sideways}}
& 0 & -61 &
\lfloor(3 \times 0 - 0) \div 2\rfloor = 0 &
\lfloor(48 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor - 61 = -61 &
48 + 0 = 48
\\
& 1 & -39 &
\lfloor(3 \times -61 - 0) \div 2\rfloor = -92 &
\lfloor(48 \times -92 + 2 ^ 9) \div 2 ^ {10}\rfloor - 39 = -43 &
48 + 2 = 50
\\
& 2 & -21 &
\lfloor(3 \times -43 + 61) \div 2\rfloor = -34 &
\lfloor(50 \times -34 + 2 ^ 9) \div 2 ^ {10}\rfloor - 21 = -23 &
50 + 2 = 52
\\
& 3 & -1 &
\lfloor(3 \times -23 + 43) \div 2\rfloor = -13 &
\lfloor(52 \times -13 + 2 ^ 9) \div 2 ^ {10}\rfloor - 1 = -2 &
52 + 2 = 54
\\
& 4 & 20 &
\lfloor(3 \times -2 + 23) \div 2\rfloor = 8 &
\lfloor(54 \times 8 + 2 ^ 9) \div 2 ^ {10}\rfloor + 20 = 20 &
54 + 2 = 56
\\
& 5 & 37 &
\lfloor(3 \times 20 + 2) \div 2\rfloor = 31 &
\lfloor(56 \times 31 + 2 ^ 9) \div 2 ^ {10}\rfloor + 37 = 39 &
56 + 2 = 58
\\
& 6 & 54 &
\lfloor(3 \times 39 - 20) \div 2\rfloor = 48 &
\lfloor(58 \times 48 + 2 ^ 9) \div 2 ^ {10}\rfloor + 54 = 57 &
58 + 2 = 60
\\
& 7 & 67 &
\lfloor(3 \times 57 - 39) \div 2\rfloor = 66 &
\lfloor(60 \times 66 + 2 ^ 9) \div 2 ^ {10}\rfloor + 67 = 71 &
60 + 2 = 62
\\
& 8 & 75 &
\lfloor(3 \times 71 - 57) \div 2\rfloor = 78 &
\lfloor(62 \times 78 + 2 ^ 9) \div 2 ^ {10}\rfloor + 75 = 80 &
62 + 2 = 64
\\
& 9 & 79 &
\lfloor(3 \times 80 - 71) \div 2\rfloor = 84 &
\lfloor(64 \times 84 + 2 ^ 9) \div 2 ^ {10}\rfloor + 79 = 84 &
64 + 2 = 66
\\
\hline
\hline
%% \multicolumn{5}{c}{\textbf{pass 4 } - term 18 - delta 2 - weight 48} \\
& $i$ & \textsf{correlated}_i & \textsf{temp}_i & \textsf{decorrelated}_{i + 2} & \textsf{weight}_{i + 1} \\
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_4$ - term 18\end{sideways}}
& 0 & -61 &
\lfloor(3 \times -73 + 78) \div 2\rfloor = -71 &
\lfloor(48 \times -71 + 2 ^ 9) \div 2 ^ {10}\rfloor - 61 = -64 &
48 + 2 = 50
\\
& 1 & -43 &
\lfloor(3 \times -64 + 73) \div 2\rfloor = -60 &
\lfloor(50 \times -60 + 2 ^ 9) \div 2 ^ {10}\rfloor - 43 = -46 &
50 + 2 = 52
\\
& 2 & -23 &
\lfloor(3 \times -46 + 64) \div 2\rfloor = -37 &
\lfloor(52 \times -37 + 2 ^ 9) \div 2 ^ {10}\rfloor - 23 = -25 &
52 + 2 = 54
\\
& 3 & -2 &
\lfloor(3 \times -25 + 46) \div 2\rfloor = -15 &
\lfloor(54 \times -15 + 2 ^ 9) \div 2 ^ {10}\rfloor - 2 = -3 &
54 + 2 = 56
\\
& 4 & 20 &
\lfloor(3 \times -3 + 25) \div 2\rfloor = 8 &
\lfloor(56 \times 8 + 2 ^ 9) \div 2 ^ {10}\rfloor + 20 = 20 &
56 + 2 = 58
\\
& 5 & 39 &
\lfloor(3 \times 20 + 3) \div 2\rfloor = 31 &
\lfloor(58 \times 31 + 2 ^ 9) \div 2 ^ {10}\rfloor + 39 = 41 &
58 + 2 = 60
\\
& 6 & 57 &
\lfloor(3 \times 41 - 20) \div 2\rfloor = 51 &
\lfloor(60 \times 51 + 2 ^ 9) \div 2 ^ {10}\rfloor + 57 = 60 &
60 + 2 = 62
\\
& 7 & 71 &
\lfloor(3 \times 60 - 41) \div 2\rfloor = 69 &
\lfloor(62 \times 69 + 2 ^ 9) \div 2 ^ {10}\rfloor + 71 = 75 &
62 + 2 = 64
\\
& 8 & 80 &
\lfloor(3 \times 75 - 60) \div 2\rfloor = 82 &
\lfloor(64 \times 82 + 2 ^ 9) \div 2 ^ {10}\rfloor + 80 = 85 &
64 + 2 = 66
\\
& 9 & 84 &
\lfloor(3 \times 85 - 75) \div 2\rfloor = 90 &
\lfloor(66 \times 90 + 2 ^ 9) \div 2 ^ {10}\rfloor + 84 = 90 &
66 + 2 = 68
\\
\end{tabular}
}
\begin{center}
$\text{channel}_0$ decorrelation passes
\end{center}

\clearpage

\subsection{Undo Joint Stereo}
\label{wavpack:undo_joint_stereo}
\ALGORITHM{mid and side channels of signed sample data, in that order}{left and right channels of signed sample data, in that order}
\SetKwData{MID}{mid}
\SetKwData{SIDE}{side}
\SetKwData{LEFT}{left}
\SetKwData{RIGHT}{right}
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  $\text{\RIGHT}_i \leftarrow \text{\SIDE}_i - \lfloor\text{\MID}_i \div 2\rfloor$\;
  $\text{\LEFT}_i \leftarrow \text{\MID}_i + \text{\RIGHT}_i$\;
}
\Return left and right channels\;
\EALGORITHM

\subsubsection{Joint Stereo Example}
\begin{table}[h]
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{mid}_i$ & $\textsf{side}_i$ & \textsf{right}_i & \textsf{left}_i \\
\hline
0 & -64 & 32 &
32 - \lfloor-64 \div 2\rfloor = 64 &
-64 + 64 = 0 \\
1 & -46 & 39 &
39 - \lfloor-46 \div 2\rfloor = 62 &
-46 + 62 = 16 \\
2 & -25 & 43 &
43 - \lfloor-25 \div 2\rfloor = 56 &
-25 + 56 = 31 \\
3 & -3 & 45 &
45 - \lfloor-3 \div 2\rfloor = 47 &
-3 + 47 = 44 \\
4 & 20 & 44 &
44 - \lfloor20 \div 2\rfloor = 34 &
20 + 34 = 54 \\
5 & 41 & 40 &
40 - \lfloor41 \div 2\rfloor = 20 &
41 + 20 = 61 \\
6 & 60 & 34 &
34 - \lfloor60 \div 2\rfloor = 4 &
60 + 4 = 64 \\
7 & 75 & 25 &
25 - \lfloor75 \div 2\rfloor = -12 &
75 + -12 = 63 \\
8 & 85 & 15 &
15 - \lfloor85 \div 2\rfloor = -27 &
85 + -27 = 58 \\
9 & 90 & 4 &
4 - \lfloor90 \div 2\rfloor = -41 &
90 + -41 = 49 \\
\hline
\end{tabular}
\end{table}

\begin{landscape}
  \label{wavpack:verify_crc}
\subsection{Checksum Calculation}
\ALGORITHM{one or two channels of signed audio samples}{an unsigned 32-bit CRC integer}
\SetKwData{MONO}{mono output}
\SetKwData{CRC}{CRC}
\SetKwData{LCRC}{LCRC}
\SetKwData{SCRC}{SCRC}
\SetKwData{CHANNEL}{channel}
$\text{\CRC}_{-1} \leftarrow \texttt{0xFFFFFFFF}$\;
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  \eIf{$\text{\MONO} = 0$}{
    $\text{\LCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of left channel}
    $\text{\SCRC}_i \leftarrow (3 \times \text{\LCRC}_{i - 1}) + \text{\CHANNEL}_{1~i}$\tcc*[r]{calculate signed CRC of right channel}
  }{
    $\text{\SCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of channel}
  }
  \BlankLine
  \eIf(\tcc*[f]{convert signed CRC to unsigned, 32-bit integer}){$\text{\SCRC}_i \geq 0$}{
    $\text{\CRC}_i \leftarrow \text{\SCRC}_i \bmod \texttt{0x100000000}$\;
  }{
    $\text{\CRC}_i \leftarrow (2 ^ {32} - (-\text{\SCRC}_i)) \bmod \texttt{0x100000000}$\;
  }
}
\Return $\text{\CRC}_{\text{sample count} - 1}$\;
\EALGORITHM

\subsubsection{Checksum Calculation Example}
{\relsize{-1}
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{channel}_{0~i}$ & $\textsf{channel}_{1~i}$ & \textsf{LCRC}_i & \text{SCRC}_i & \textsf{CRC}_i \\
\hline
0 & 0 & 64 &
(3 \times \texttt{0xFFFFFFFF}) + 0 = \texttt{0x2FFFFFFFD} &
(3 \times \texttt{0x2FFFFFFFD}) + 64 = \texttt{0x900000037} &
\texttt{0x00000037} \\
1 & 16 & 62 &
(3 \times \texttt{0x00000037}) + 16 = \texttt{0x000000B5} &
(3 \times \texttt{0x000000B5}) + 62 = \texttt{0x0000025D} &
\texttt{0x0000025D} \\
2 & 31 & 56 &
(3 \times \texttt{0x0000025D}) + 31 = \texttt{0x00000736} &
(3 \times \texttt{0x00000736}) + 56 = \texttt{0x000015DA} &
\texttt{0x000015DA} \\
3 & 44 & 47 &
(3 \times \texttt{0x000015DA}) + 44 = \texttt{0x000041BA} &
(3 \times \texttt{0x000041BA}) + 47 = \texttt{0x0000C55D} &
\texttt{0x0000C55D} \\
4 & 54 & 34 &
(3 \times \texttt{0x0000C55D}) + 54 = \texttt{0x0002504D} &
(3 \times \texttt{0x0002504D}) + 34 = \texttt{0x0006F109} &
\texttt{0x0006F109} \\
5 & 61 & 20 &
(3 \times \texttt{0x0006F109}) + 61 = \texttt{0x0014D358} &
(3 \times \texttt{0x0014D358}) + 20 = \texttt{0x003E7A1C} &
\texttt{0x003E7A1C} \\
6 & 64 & 4 &
(3 \times \texttt{0x003E7A1C}) + 64 = \texttt{0x00BB6E94} &
(3 \times \texttt{0x00BB6E94}) + 4 = \texttt{0x02324BC0} &
\texttt{0x02324BC0} \\
7 & 63 & -12 &
(3 \times \texttt{0x02324BC0}) + 63 = \texttt{0x0696E37F} &
(3 \times \texttt{0x0696E37F}) - 12 = \texttt{0x13C4AA71} &
\texttt{0x13C4AA71} \\
8 & 58 & -27 &
(3 \times \texttt{0x13C4AA71}) + 58 = \texttt{0x3B4DFF8D} &
(3 \times \texttt{0x3B4DFF8D}) - 27 = \texttt{0xB1E9FE8C} &
\texttt{0xB1E9FE8C} \\
9 & 49 & -41 &
(3 \times \texttt{0xB1E9FE8C}) + 49 = \texttt{0x215BDFBD5} &
(3 \times \texttt{0x215BDFBD5}) - 41 = \texttt{0x64139F356} &
\texttt{0x4139F356} \\
\end{tabular}
}
\vskip 1em
\par
\noindent
Resulting in a final CRC of \texttt{0x4139F356}
\end{landscape}

\clearpage

\subsection{Decode Extended Integers}
\label{wavpack:decode_extended_integers}
\ALGORITHM{sub block data}{\VAR{zero bits}, \VAR{one bits}, \VAR{duplicate bits} values as unsigned integers}
\SetKwData{SENTS}{sent bits}
\SetKwData{ZEROES}{zero bits}
\SetKwData{ONES}{one bits}
\SetKwData{DUPLICATES}{duplicate bits}
\SENTS $\leftarrow$ \READ 8 unsigned bits\tcc*[r]{unused}
\ZEROES $\leftarrow$ \READ 8 unsigned bits\;
\ONES $\leftarrow$ \READ 8 unsigned bits\;
\DUPLICATES $\leftarrow$ \READ 8 unsigned bits\;
\Return \ZEROES, \ONES and \DUPLICATES\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{figures/wavpack/extended_integers.pdf}
\end{figure}

\subsection{Undoing Extended Integers}
\label{wavpack:undo_extended_integers}
\ALGORITHM{\VAR{zero bits}, \VAR{one bits}, \VAR{duplicate bits} values; 1 or 2 channels of shifted PCM data}{1 or 2 channels of un-shifted PCM data}
\SetKwData{ZEROES}{zero bits}
\SetKwData{ONES}{one bits}
\SetKwData{DUPLICATES}{duplicate bits}
\SetKwData{SHIFTED}{shifted channel}
\SetKwData{UNSHIFTED}{un-shifted channel}
\For{$c \leftarrow 0$ \emph{\KwTo}channel count}{
  \uIf{$\text{\ZEROES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\ZEROES}}$\;
    }
  }
  \uElseIf{$\text{\ONES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\ONES}} + (2 ^ {\text{\ONES}} - 1)$\;
    }
  }
  \uElseIf{$\text{\DUPLICATES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      \eIf{$\text{\SHIFTED}_{c~i} \bmod 2 = 0$}{
        $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\DUPLICATES}}$\;
      }{
        $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\DUPLICATES}} + (2 ^ {\text{\DUPLICATES}} - 1)$\;
      }
    }
  }
  \Else{
    $\text{\UNSHIFTED}_c \leftarrow \text{\SHIFTED}_c$\;
  }
}
\Return \UNSHIFTED data\;
\EALGORITHM

\clearpage

\subsection{MD5 Sum}
\label{wavpack:md5_sum}
The MD5 is the hash of all the PCM samples, on a PCM frame basis,
in little-endian format and signed if the bits per sample is greater than 0.

\begin{figure}[h]
\includegraphics{figures/wavpack/md5sum.pdf}
\end{figure}

\subsection{RIFF WAVE Header and Footer}

These sub-blocks are typically found in the first and last
WavPack block, respectively.
The header must always be present in the file while
the footer is optional.

\begin{figure}[h]
\includegraphics{figures/wavpack/pcm_sandwich.pdf}
\end{figure}

\clearpage

\section{WavPack Encoding}

\ALGORITHM{PCM frames, Wave header\footnote{Everything between the file's start and the start of the \texttt{data} chunk's contents.  If one is encoding a WavPack from raw PCM input, this header will need to be generated.}, optional Wave footer\footnote{Everything between the end of the \texttt{data} chunk's contents and the file's end, if anything.}, encoding parameters:
\newline
{\relsize{-1}
\begin{tabular}{rll}
parameter & possible values & typical values \\
\hline
block size & a positive number of PCM frames & 22050 \\
correlation passes & 0, 1, 2, 5, 10 or 16 & 5 \\
\end{tabular}
}
}{an encoded WavPack file}
\SetKwData{BLOCKSIZE}{block size}
\SetKwData{BLOCKINDEX}{block index}
\SetKwData{BLOCKSETCOUNT}{block count}
\SetKwData{BLOCKSETCHANNELS}{block channels}
\SetKwData{PASSES}{correlation passes}
\SetKwData{PARAMS}{block params}
\SetKwData{FIRST}{first}
\SetKwData{LAST}{last}
\SetKwData{BLOCK}{block}
\SetKwData{CHANNELS}{channels}
\SetKwData{CHANNEL}{channel}
$(\text{\BLOCKSETCOUNT}~,~\text{\BLOCKSETCHANNELS}) \leftarrow$ \hyperref[wavpack:block_split]{determine block split}\;
\For{$b \leftarrow 0$ \emph{\KwTo}\BLOCKSETCOUNT}{
  $\text{\PARAMS}_{0~b} \leftarrow$ \hyperref[wavpack:initial_correlation_parameters]{determine initial correlation parameters and entropy variables from correlation passes and $\text{\BLOCKSETCHANNELS}_b$}\;
}
\BlankLine
$\text{\BLOCKINDEX} \leftarrow 0$\;
$s \leftarrow 0$\tcc*[r]{the number of block sets written}
\While{PCM frames remain}{
  $\text{\CHANNELS} \leftarrow$ take up to \BLOCKSIZE PCM frames from the input\;
  update the stream's MD5 sum with that PCM data\;
  $c \leftarrow 0$\;
  \For(\tcc*[f]{blocks in each set}){$b \leftarrow 0$ \emph{\KwTo}\BLOCKSETCOUNT}{
    \lIf{$b = 0$}{$\text{\FIRST} = 1$}
    \lElse{$\text{\FIRST} = 0$}\;
    \lIf{$b = \text{\BLOCKSETCOUNT} - 1$}{$\text{\LAST} = 1$}
    \lElse{$\text{\LAST} = 0$}\;
    \uIf{$\text{\BLOCKSETCHANNELS}_b = 1$}{
      $(\text{\BLOCK}_{(s \times \text{\BLOCKSETCHANNELS}) + b}~,~\text{\PARAMS}_{(s + 1)~b}) \leftarrow$ \hyperref[wavpack:write_block]{write block}\newline
      using $\text{\CHANNEL}_c$, \BLOCKINDEX, \FIRST, \LAST and $\text{\PARAMS}_{s~b}$\;
      $c \leftarrow c + 1$\;
    }
    \ElseIf{$\text{\BLOCKSETCHANNELS}_b = 2$}{
      $(\text{\BLOCK}_{(s \times \text{\BLOCKSETCHANNELS}) + b}~,~\text{\PARAMS}_{(s + 1)~b}) \leftarrow$ \hyperref[wavpack:write_block]{write block}\newline
      using $\text{\CHANNEL}_c/\text{\CHANNEL}_{c + 1}$, \BLOCKINDEX, \FIRST, \LAST and $\text{\PARAMS}_{s~b}$\;
      $c \leftarrow c + 2$\;
    }
  }
  $s \leftarrow s + 1$\;
  $\text{\BLOCKINDEX} \leftarrow \text{\BLOCKINDEX} + \text{PCM data's frame count}$\;
}
\BlankLine
write final block containing optional \hyperref[wavpack:write_wave_header]{Wave footer} and \hyperref[wavpack:write_md5]{MD5 sum} sub blocks\;
update Wave header's \texttt{data} chunk size, if generated from scratch\;
update \VAR{total samples} field in all block headers with \BLOCKINDEX\;
\EALGORITHM

\clearpage

\subsection{Determine Block Split}
\label{wavpack:block_split}
\ALGORITHM{input stream's channel assignment}{number of blocks per set, list of channel counts per block}
\SetKwData{BLOCKCOUNT}{block count}
\SetKwData{BLOCKCHANNELS}{block channels}
\Switch(\tcc*[f]{split channels by left/right pairs}){channel assignment}{
  \uCase{mono}{
    $\text{\BLOCKCOUNT} \leftarrow 1$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[1]}$\;
  }
  \uCase{front left, front right}{
    $\text{\BLOCKCOUNT} \leftarrow 1$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2]}$\;
  }
  \uCase{front left, front right, front center}{
    $\text{\BLOCKCOUNT} \leftarrow 2$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2, 1]}$\;
  }
  \uCase{front left, front right, back left, back right}{
    $\text{\BLOCKCOUNT} \leftarrow 2$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2, 2]}$\;
  }
  \uCase{front left, front right, front center, back center}{
    $\text{\BLOCKCOUNT} \leftarrow 3$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2, 1, 1]}$\;
  }
  \uCase{front left, front right, front center, back left, back right}{
    $\text{\BLOCKCOUNT} \leftarrow 3$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2, 1, 2]}$\;
  }
  \uCase{front left, front right, front center, LFE, back left, back right}{
    $\text{\BLOCKCOUNT} \leftarrow 4$\;
    $\text{\BLOCKCHANNELS} \leftarrow \texttt{[2, 1, 1, 2]}$\;
  }
  \Other(\tcc*[f]{save them independently}){
    $\text{\BLOCKCOUNT} \leftarrow$ channel count\;
    $\text{\BLOCKCHANNELS} \leftarrow$ 1 per channel\;
  }
}
\Return \BLOCKCOUNT and \BLOCKCHANNELS
\EALGORITHM
\vskip 1ex
\par
\noindent
One could invent alternate channel splits for other obscure assignments.
WavPack's only requirement is that all channels must be in
Wave order\footnote{see page \pageref{wave_channel_assignment}}
and each block must contain 1 or 2 channels.

\begin{figure}[h]
\includegraphics{figures/wavpack/block_channels.pdf}
\end{figure}

\begin{landscape}

\subsection{Determine Correlation Parameters and Entropy Variables}
\label{wavpack:initial_correlation_parameters}
{\relsize{-1}
\begin{description}
\item[$\text{term}_{b~p}$] correlation term for block $b$, correlation pass $p$
\item[$\text{delta}_{b~p}$] correlation delta for block $b$, correlation pass $p$
\item[$\text{weight}_{b~p~c}$] correlation weight for block $b$, correlation pass $p$, channel $c$
\item[$\text{sample}_{b~p~c~s}$] correlation sample $s$ for block $b$, correlation pass $p$, channel $c$
\item[$\text{entropy}_{b~c~m}$] median $m$ for block $b$, channel $c$
\end{description}
\par
\noindent
We'll omit the block $b$ parameter since it will be the same
throughout the block encode, but one must keep it in mind
when transferring parameters from the block of one set of channels
to the next block of those same channels.
}
\vskip .10in
\par
\noindent
\ALGORITHM{correlation pass count, block's channel count of 1 or 2}{correlation term, delta, weights and samples for each pass; 3 entropy variables for each channel}
{\relsize{-2}
$\text{entropy}_0 \leftarrow \texttt{[0, 0, 0]}$\;
$\text{entropy}_1 \leftarrow \texttt{[0, 0, 0]}$\;
\BlankLine
\If{$\text{channel count} = 1$}{
\Switch{correlation pass count}{
\uCase{1}{
\begin{tabular}{r|rrrl}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{samples}_{p~0}$ \\
\hline
0 & 18 & 2 & 0 & \texttt{[0, 0]} \\
\end{tabular}
}
\uCase{2}{
\begin{tabular}{r|rrrl}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{samples}_{p~0}$ \\
\hline
0 & 17 & 2 & 0 & \texttt{[0, 0]} \\
1 & 18 & 2 & 0 & \texttt{[0, 0]} \\
\end{tabular}
}
\uCase(\tcc*[f]{one channel blocks don't use negative terms}){5, 10, or 16}{
\begin{tabular}{r|rrrl}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{samples}_{p~0}$ \\
\hline
0 & 3 & 2 & 0 & \texttt{[0, 0, 0]} \\
1 & 17 & 2 & 0 & \texttt{[0, 0]} \\
2 & 2 & 2 & 0 & \texttt{[0, 0]} \\
3 & 18 & 2 & 0 & \texttt{[0, 0]} \\
4 & 18 & 2 & 0 & \texttt{[0, 0]} \\
\end{tabular}
}}}}
\EALGORITHM

\clearpage

\begin{algorithm}
{\relsize{-2}
\ElseIf{$\text{channel count} = 2$}{
\Switch{correlation pass count}{
\uCase{1}{
\begin{tabular}{r|rrrrll}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{weight}_{p~1}$ & $\text{samples}_{p~0}$ & $\text{samples}_{p~1}$ \\
\hline
0 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
\end{tabular}
}
\uCase{2}{
\begin{tabular}{r|rrrrll}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{weight}_{p~1}$ & $\text{samples}_{p~0}$ & $\text{samples}_{p~1}$ \\
\hline
0 & 17 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
1 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
\end{tabular}
}
\uCase{5}{
\begin{tabular}{r|rrrrll}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{weight}_{p~1}$ & $\text{samples}_{p~0}$ & $\text{samples}_{p~1}$ \\
\hline
0 & 3 & 2 & 48 & 48 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
1 & 17 & 2 & 48 & 48 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
2 & 2 & 2 & 32 & 32 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
3 & 18 & 2 & 48 & 48 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
4 & 18 & 2 & 16 & 24 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
\end{tabular}
}
\uCase{10}{
\begin{tabular}{r|rrrrll}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{weight}_{p~1}$ & $\text{samples}_{p~0}$ & $\text{samples}_{p~1}$ \\
\hline
0 & 4 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0]} & \texttt{[0, 0, 0, 0]} \\
1 & 17 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
2 & -1 & 2 & 0 & 0 & \texttt{[0]} & \texttt{[0]} \\
3 & 5 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0, 0]} & \texttt{[0, 0, 0, 0, 0]} \\
4 & 3 & 2 & 0 & 0 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
5 & 2 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
6 & -2 & 2 & 0 & 0 & \texttt{[0]} & \texttt{[0]} \\
7 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
8 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
9 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
\end{tabular}
}
\Case{16}{
\begin{tabular}{r|rrrrll}
$\text{pass}~p$ & $\text{term}_p$ & $\text{delta}_p$ & $\text{weight}_{p~0}$ & $\text{weight}_{p~1}$ & $\text{samples}_{p~0}$ & $\text{samples}_{p~1}$ \\
\hline
0 & 2 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
1 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
2 & -1 & 2 & 0 & 0 & \texttt{[0]} & \texttt{[0]} \\
3 & 8 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0, 0, 0, 0, 0]} & \texttt{[0, 0, 0, 0, 0, 0, 0, 0]} \\
4 & 6 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0, 0, 0]} & \texttt{[0, 0, 0, 0, 0, 0]} \\
5 & 3 & 2 & 0 & 0 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
6 & 5 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0, 0]} & \texttt{[0, 0, 0, 0, 0]} \\
7 & 7 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0, 0, 0, 0]} & \texttt{[0, 0, 0, 0, 0, 0, 0]} \\
8 & 4 & 2 & 0 & 0 & \texttt{[0, 0, 0, 0]} & \texttt{[0, 0, 0, 0]} \\
9 & 2 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
10 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
11 & -2 & 2 & 0 & 0 & \texttt{[0]} & \texttt{[0]} \\
12 & 3 & 2 & 0 & 0 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
13 & 2 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
14 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
15 & 18 & 2 & 0 & 0 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
\end{tabular}
}}}}
\end{algorithm}

\end{landscape}

%% \subsection{Writing Block Set}
%% {\relsize{-1}
%% \ALGORITHM{PCM frames and their channel assignment, block index, encoding parameters}{one or more WavPack blocks}
%% \SetKwData{CHANNEL}{channel}
%% \SetKwData{FIRST}{first}
%% \SetKwData{LAST}{last}
%% \Switch(\tcc*[f]{split channels by left/right pairs}){channel assignment}{
%%   \uCase{mono}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right, front center}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_2$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right, back left, back right}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_2/\text{\CHANNEL}_3$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right, front center, back center}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_2$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_3$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right, front center, back left, back right}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_2$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_3/\text{\CHANNEL}_4$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \uCase{front left, front right, front center, LFE, back left, back right}{
%%     \begin{tabular}{lrr}
%%       write $\text{\CHANNEL}_0/\text{\CHANNEL}_1$ & $\text{\FIRST} = 1$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_2$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_3$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 0$ \\
%%       write $\text{\CHANNEL}_4/\text{\CHANNEL}_5$ & $\text{\FIRST} = 0$ & $\text{\LAST} = 1$ \\
%%     \end{tabular}\;
%%   }
%%   \Other(\tcc*[f]{save them independently}){
%%     \For{$i \leftarrow 0$ \emph{\KwTo}channel count}{
%%       \lIf{$i = 0$}{$\text{\FIRST} = 1$}
%%       \lElse{$\text{\FIRST} = 0$}\;
%%       \lIf{$i = \text{channel count} - 1$}{$\text{\LAST} = 1$}
%%       \lElse{$\text{\LAST} = 0$}\;
%%       write $\text{\CHANNEL}_i$ to block\;
%%     }
%%   }
%% }
%% \Return set of encoded WavPack blocks\;
%% \EALGORITHM


%% \clearpage

\subsection{Writing Block}
\label{wavpack:write_block}
{\relsize{-1}
\ALGORITHM{1 or 2 channels of PCM frames, block index, first block, last block, encoding parameters from previous block}{a WavPack block, encoding parameters for next block}
\SetKwData{CHANNEL}{channel}
\SetKwData{MONO}{mono output}
\SetKwData{FALSESTEREO}{false stereo}
\SetKwData{MAGNITUDE}{magnitude}
\SetKwData{WASTEDBPS}{wasted bps}
\SetKwData{SHIFTED}{shifted}
\SetKwData{CRC}{CRC}
\SetKwData{CORRELATED}{correlated}
\SetKwData{MID}{mid}
\SetKwData{SIDE}{side}
\SetKwData{TERMS}{terms}
\SetKwData{DELTAS}{deltas}
\SetKwData{WEIGHTS}{weights}
\SetKwData{SAMPLES}{samples}
\SetKwData{BITSTREAM}{bitstream}
\SetKwData{ENTROPY}{entropy}
\SetKw{OR}{or}
\SetKwFunction{MAX}{max}
\SetKwFunction{MIN}{min}
\eIf(\tcc*[f]{1 channel block}){$\text{channel count} = 1$ \OR $\text{\CHANNEL}_0 = \text{\CHANNEL}_1$}{
  \eIf{$\text{channel count} = 1$}{
    $\text{\MONO} \leftarrow 1$\;
    $\text{\FALSESTEREO} \leftarrow 0$\;
  }{
    $\text{\MONO} \leftarrow 0$\;
    $\text{\FALSESTEREO} \leftarrow 1$\;
  }
  $\text{\MAGNITUDE} \leftarrow$ \hyperref[wavpack:maximum_magnitude]{maximum magnitude of $\text{\CHANNEL}_0$}\;
  $\text{\WASTEDBPS} \leftarrow$ \hyperref[wavpack:wasted_bps]{wasted bps of $\text{\CHANNEL}_0$}\;
  \eIf{$\text{\WASTEDBPS} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}block size}{
      $\text{\SHIFTED}_{0~i} \leftarrow \lfloor\text{\CHANNEL}_{0~i} \div 2 ^ \text{\WASTEDBPS}\rfloor$\;
    }
  }{
    $\text{\SHIFTED}_0 \leftarrow \text{\CHANNEL}_0$\;
  }
  $\text{\CRC} \leftarrow$ \hyperref[wavpack:calc_crc]{calculate CRC of $\text{\SHIFTED}_0$}\;
}(\tcc*[f]{2 channel block}){
  $\text{\MONO} \leftarrow 0$\;
  $\text{\FALSESTEREO} \leftarrow 0$\;
  $\text{\MAGNITUDE} \leftarrow \hyperref[wavpack:maximum_magnitude]{\MAX(\text{maximum magnitude of \CHANNEL}_0~,~\text{maximum magnitude of \CHANNEL}_1)}$\;
  $\text{\WASTEDBPS} \leftarrow \hyperref[wavpack:wasted_bps]{\MIN(\text{wasted bps of \CHANNEL}_0~,~\text{wasted bps of \CHANNEL}_1)}$\;
  \eIf{$\text{\WASTEDBPS} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}block size}{
      $\text{\SHIFTED}_{0~i} \leftarrow \lfloor\text{\CHANNEL}_{0~i} \div 2 ^ \text{\WASTEDBPS}\rfloor$\;
      $\text{\SHIFTED}_{1~i} \leftarrow \lfloor\text{\CHANNEL}_{1~i} \div 2 ^ \text{\WASTEDBPS}\rfloor$\;
    }
  }{
    $\text{\SHIFTED}_0/\text{\SHIFTED}_1 \leftarrow \text{\CHANNEL}_0/\text{\CHANNEL}_1$\;
  }
  $\text{\CRC} \leftarrow$ \hyperref[wavpack:calc_crc]{calculate CRC of $\text{\SHIFTED}_0/\text{\SHIFTED}_1$}\;
  $\text{\MID}/\text{\SIDE} \leftarrow$ \hyperref[wavpack:calc_joint_stereo]{convert $\text{\SHIFTED}_0/\text{\SHIFTED}_1$ to joint stereo}\;
}
\EALGORITHM
}

\begin{figure}[h]
  \includegraphics{figures/wavpack/typical_block.pdf}
\end{figure}

\clearpage
{\relsize{-1}
\begin{algorithm}[H]
\DontPrintSemicolon
\SetKwData{CHANNEL}{channel}
\SetKwData{CORRELATED}{correlated}
\SetKwData{SHIFTED}{shifted}
\SetKwData{MID}{mid}
\SetKwData{SIDE}{side}
\SetKwData{SUBBLOCK}{sub block}
\SetKwData{WASTEDBPS}{wasted bps}
\SetKwData{BITSTREAM}{bitstream}
\SetKwData{TERMS}{terms}
\SetKwData{DELTAS}{deltas}
\SetKwData{WEIGHTS}{weights}
\SetKwData{SAMPLES}{samples}
\SetKwData{ENTROPY}{entropy}
\SetKw{NOT}{not}
\SetKw{IN}{in}
\SetKw{OR}{or}
$i \leftarrow 0$\;
\If{first block in file}{
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_wave_header]{wave header}\;
  $i \leftarrow i + 1$\;
}
\If{$\text{decorrelation passes} > 0$}{
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_decorr_terms]{decorrelation terms sub block from \TERMS and \DELTAS}\;
  $\text{\SUBBLOCK}_{i + 1} \leftarrow$ \hyperref[wavpack:write_decorr_weights]{decorrelation weights sub block from \WEIGHTS}\;
  $\text{\SUBBLOCK}_{i + 2} \leftarrow$ \hyperref[wavpack:write_decorr_samples]{decorrelation samples sub block from \SAMPLES}\;
  $i \leftarrow i + 3$\;
}
\If{$\text{\WASTEDBPS} > 0$}{
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_extended_integers]{extended integers}\;
  $i \leftarrow i + 1$\;
}
\If{$\text{total channel count} > 2$}{
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_channel_info]{channel info}\;
  $i \leftarrow i + 1$\;
}
\If{sample rate not defined in block header}{
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_sample_rate]{sample rate}\;
  $i \leftarrow i + 1$\;
}
\eIf(\tcc*[f]{1 channel block}){$\text{channel count} = 1$ \OR $\text{\CHANNEL}_0 = \text{\CHANNEL}_1$}{
  $(\text{\CORRELATED}_0~,~\text{\WEIGHTS}'~,~\text{\SAMPLES}') \leftarrow$ \hyperref[wavpack:correlate_channels]{correlate $\text{\SHIFTED}_0$\newline
  with \TERMS, \DELTAS, \WEIGHTS and \SAMPLES from encoding parameters}\;
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_entropy]{entropy variables sub block from \ENTROPY}\;
  $(\text{\BITSTREAM}~,~\text{\ENTROPY}') \leftarrow$ \hyperref[wavpack:write_bitstream]{calculate bitstream from $\text{\CORRELATED}_0$\newline
  and $\text{\ENTROPY}$ from encoding parameters}\;
  \BlankLine
  $\text{\SUBBLOCK}_{i + 1} \leftarrow$ bitstream sub block from \BITSTREAM\;
}(\tcc*[f]{2 channel block}){
  $(\text{\CORRELATED}_0/\text{\CORRELATED}_1~,~\text{\WEIGHTS}'~,~\text{\SAMPLES}') \leftarrow$ \hyperref[wavpack:correlate_channels]{correlate $\text{\MID}/\text{\SIDE}$\newline
  with \TERMS, \DELTAS, \WEIGHTS and \SAMPLES from encoding parameters}\;
  \BlankLine
  $\text{\SUBBLOCK}_i \leftarrow$ \hyperref[wavpack:write_entropy]{entropy variables sub block from \ENTROPY}\;
  $(\text{\BITSTREAM}~,~\text{\ENTROPY}') \leftarrow$ \hyperref[wavpack:write_bitstream]{calculate bitstream from $\text{\CORRELATED}_0/\text{\CORRELATED}_0$\newline
  and $\text{\ENTROPY}$ from encoding parameters}\;
  $\text{\SUBBLOCK}_{i + 1} \leftarrow$ bitstream sub block from \BITSTREAM\;
}
$i \leftarrow i + 2$\;
\BlankLine
\hyperref[wavpack:write_block_header]{write block header}\;
\For{$j \leftarrow 0$ \emph{\KwTo}i}{
  write $\text{\SUBBLOCK}_j$\;
}
\Return block data, $\text{\WEIGHTS}'$, $\text{\SAMPLES}'$ and $\text{\ENTROPY}'$
\end{algorithm}
}

\clearpage

\subsection{Calculating Maximum Magnitude}
\label{wavpack:maximum_magnitude}
{\relsize{-1}
\ALGORITHM{a list of signed PCM samples for a single channel}{an unsigned integer}
\SetKwData{MAXMAGNITUDE}{maximum magnitude}
\SetKwData{SAMPLE}{sample}
\SetKwFunction{MAX}{max}
\SetKwFunction{BITS}{bits}
$\text{\MAXMAGNITUDE} \leftarrow 0$\;
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  $\text{\MAXMAGNITUDE} \leftarrow \MAX(\BITS(|\text{\SAMPLE}_i|)~,~\text{\MAXMAGNITUDE})$\;
}
\Return \MAXMAGNITUDE\;
\EALGORITHM
where the \texttt{bits} function is defined as:
\begin{equation*}
\texttt{bits}(x) =
\begin{cases}
0 & \text{if } x = 0 \\
1 + \texttt{bits}(\lfloor x \div 2 \rfloor) & \text{if } x > 0
\end{cases}
\end{equation*}
}
\subsubsection{Maximum Magnitude Example}
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{r|rrrrrrrrrr}
$i$ & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 \\
\hline
$\text{sample}_i$ & 0 & 16 & 31 & 44 & 54 & 61 & 64 & 63 & 58 & 49 \\
$\texttt{bits}(|\text{sample}_i|)$ & 0 & 5 & 5 & 6 & 6 & 6 & 7 & 6 & 6 & 6
\end{tabular}
}
\end{table}
\par
\noindent
for a maximum magnitude of 7.

\subsection{Calculating Wasted Bits Per Sample}
\label{wavpack:wasted_bps}
{\relsize{-1}
\ALGORITHM{a list of signed PCM samples for a single channel}{an unsigned integer}
\SetKwData{WASTEDBPS}{wasted bps}
\SetKwData{SAMPLE}{sample}
\SetKwFunction{MIN}{min}
\SetKwFunction{WASTED}{wasted}
$\text{\WASTEDBPS} \leftarrow \infty$\tcc*[r]{maximum unsigned integer}
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  $\text{\WASTEDBPS} \leftarrow \MIN(\WASTED(\text{\SAMPLE}_i)~,~\text{\WASTEDBPS})$\;
}
\eIf(\tcc*[f]{all samples are 0}){$\WASTEDBPS = \infty$}{
  \Return 0\;
}{
  \Return \WASTEDBPS\;
}
\EALGORITHM
where the \texttt{wasted} function is defined as:
\begin{equation*}
\texttt{wasted}(x) =
\begin{cases}
\infty & \text{if } x = 0 \\
0 & \text{if } x \bmod 2 = 1 \\
1 + \texttt{wasted}(x \div 2) & \text{if } x \bmod 2 = 0 \\
\end{cases}
\end{equation*}
}
\subsubsection{Wasted Bits Example}
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{r|rrrrrrrrrr}
$i$ & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 \\
\hline
$\text{sample}_i$ & 0 & 16 & 31 & 44 & 54 & 61 & 64 & 63 & 58 & 49 \\
$\texttt{wasted}(\text{sample}_i)$ & $\infty$ & 4 & 0 & 2 & 1 & 0 & 6 & 0 & 1 & 0 \\
\end{tabular}
}
\end{table}
\par
\noindent
for a wasted bps of 0 (which is typical).

\begin{landscape}

\subsection{Calculating CRC}
\label{wavpack:calc_crc}
\ALGORITHM{one or two channels of signed audio samples}{an unsigned 32-bit CRC integer}
\SetKwData{MONO}{mono output}
\SetKwData{CRC}{CRC}
\SetKwData{LCRC}{LCRC}
\SetKwData{SCRC}{SCRC}
\SetKwData{CHANNEL}{channel}
$\text{\CRC}_{-1} \leftarrow \texttt{0xFFFFFFFF}$\;
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  \eIf{$\text{\MONO} = 0$}{
    $\text{\LCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of left channel}
    $\text{\SCRC}_i \leftarrow (3 \times \text{\LCRC}_{i - 1}) + \text{\CHANNEL}_{1~i}$\tcc*[r]{calculate signed CRC of right channel}
  }{
    $\text{\SCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of channel}
  }
  \BlankLine
  \eIf(\tcc*[f]{convert signed CRC to unsigned, 32-bit integer}){$\text{\SCRC}_i \geq 0$}{
    $\text{\CRC}_i \leftarrow \text{\SCRC}_i \bmod \texttt{0x100000000}$\;
  }{
    $\text{\CRC}_i \leftarrow (2 ^ {32} - (-\text{\SCRC}_i)) \bmod \texttt{0x100000000}$\;
  }
}
\Return $\text{\CRC}_{\text{sample count} - 1}$\;
\EALGORITHM

\subsubsection{Checksum Calculation Example}
{\relsize{-1}
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{channel}_{0~i}$ & $\textsf{channel}_{1~i}$ & \textsf{LCRC}_i & \textsf{SCRC}_i & \textsf{CRC}_i \\
\hline
0 & 0 & 64 &
(3 \times \texttt{0xFFFFFFFF}) + 0 = \texttt{0x2FFFFFFFD} &
(3 \times \texttt{0x2FFFFFFFD}) + 64 = \texttt{0x900000037} &
\texttt{0x00000037} \\
1 & 16 & 62 &
(3 \times \texttt{0x00000037}) + 16 = \texttt{0x000000B5} &
(3 \times \texttt{0x000000B5}) + 62 = \texttt{0x0000025D} &
\texttt{0x0000025D} \\
2 & 31 & 56 &
(3 \times \texttt{0x0000025D}) + 31 = \texttt{0x00000736} &
(3 \times \texttt{0x00000736}) + 56 = \texttt{0x000015DA} &
\texttt{0x000015DA} \\
3 & 44 & 47 &
(3 \times \texttt{0x000015DA}) + 44 = \texttt{0x000041BA} &
(3 \times \texttt{0x000041BA}) + 47 = \texttt{0x0000C55D} &
\texttt{0x0000C55D} \\
4 & 54 & 34 &
(3 \times \texttt{0x0000C55D}) + 54 = \texttt{0x0002504D} &
(3 \times \texttt{0x0002504D}) + 34 = \texttt{0x0006F109} &
\texttt{0x0006F109} \\
5 & 61 & 20 &
(3 \times \texttt{0x0006F109}) + 61 = \texttt{0x0014D358} &
(3 \times \texttt{0x0014D358}) + 20 = \texttt{0x003E7A1C} &
\texttt{0x003E7A1C} \\
6 & 64 & 4 &
(3 \times \texttt{0x003E7A1C}) + 64 = \texttt{0x00BB6E94} &
(3 \times \texttt{0x00BB6E94}) + 4 = \texttt{0x02324BC0} &
\texttt{0x02324BC0} \\
7 & 63 & -12 &
(3 \times \texttt{0x02324BC0}) + 63 = \texttt{0x0696E37F} &
(3 \times \texttt{0x0696E37F}) - 12 = \texttt{0x13C4AA71} &
\texttt{0x13C4AA71} \\
8 & 58 & -27 &
(3 \times \texttt{0x13C4AA71}) + 58 = \texttt{0x3B4DFF8D} &
(3 \times \texttt{0x3B4DFF8D}) - 27 = \texttt{0xB1E9FE8C} &
\texttt{0xB1E9FE8C} \\
9 & 49 & -41 &
(3 \times \texttt{0xB1E9FE8C}) + 49 = \texttt{0x215BDFBD5} &
(3 \times \texttt{0x215BDFBD5}) - 41 = \texttt{0x64139F356} &
\texttt{0x4139F356} \\
\end{tabular}
}
\vskip 1em
\par
\noindent
Resulting in a final CRC of \texttt{0x4139F356}

\end{landscape}

\subsection{Joint Stereo Conversion}
\label{wavpack:calc_joint_stereo}
\ALGORITHM{left and right channels of signed integers}{mid and side channels of signed integers}
\SetKwData{LEFT}{left}
\SetKwData{RIGHT}{right}
\SetKwData{MID}{mid}
\SetKwData{SIDE}{side}
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  $\text{\MID}_i \leftarrow \text{\LEFT}_i - \text{\RIGHT}_i$\;
  $\text{\SIDE}_i \leftarrow \lfloor(\text{\LEFT}_i + \text{\RIGHT}_i) \div 2\rfloor$\;
}
\Return \MID and \SIDE channels\;
\EALGORITHM

\subsubsection{Joint Stereo Example}
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{left}_i$ & $\textsf{right}_i$ & \textsf{mid}_i & \textsf{side}_i \\
\hline
0 & 0 & 64 & 0 - 64 = -64 & \lfloor(0 + 64) \div 2\rfloor = 32 \\
1 & 16 & 62 & 16 - 62 = -46 & \lfloor(16 + 62) \div 2\rfloor = 39 \\
2 & 31 & 56 & 31 - 56 = -25 & \lfloor(31 + 56) \div 2\rfloor = 43 \\
3 & 44 & 47 & 44 - 47 = -3 & \lfloor(44 + 47) \div 2\rfloor = 45 \\
4 & 54 & 34 & 54 - 34 = 20 & \lfloor(54 + 34) \div 2\rfloor = 44 \\
5 & 61 & 20 & 61 - 20 = 41 & \lfloor(61 + 20) \div 2\rfloor = 40 \\
6 & 64 & 4 & 64 - 4 = 60 & \lfloor(64 + 4) \div 2\rfloor = 34 \\
7 & 63 & -12 & 63 - -12 = 75 & \lfloor(63 + -12) \div 2\rfloor = 25 \\
8 & 58 & -27 & 58 - -27 = 85 & \lfloor(58 + -27) \div 2\rfloor = 15 \\
9 & 49 & -41 & 49 - -41 = 90 & \lfloor(49 + -41) \div 2\rfloor = 4 \\
\end{tabular}
}
\end{table}

\clearpage

\subsection{Correlation Passes}
\label{wavpack:correlate_channels}
\ALGORITHM{a list of signed samples per channel; correlation terms, deltas, weights and samples}{a list of signed residuals per channel; correlation weights and samples for the next block}
\SetKwData{PASS}{pass}
\SetKwData{CHANNEL}{channel}
\SetKwData{TERMCOUNT}{term count}
\SetKwData{TERM}{term}
\SetKwData{DELTA}{delta}
\SetKwData{WEIGHT}{weight}
\SetKwData{SAMPLES}{sample}
\SetKw{KwDownTo}{downto}
\eIf{$\text{channel count} = 1$}{
  $\text{\PASS}_{-1~0} \leftarrow \text{\CHANNEL}_0$\;
  \For(\tcc*[f]{perform passes in reverse order}){$i \leftarrow 0$ \emph{\KwTo}\TERMCOUNT}{
    $p \leftarrow \TERMCOUNT - i - 1$\;
    $\left.\begin{tabular}{r}
      $\text{\PASS}_{i~0}$ \\
      $\text{\WEIGHT}_{p~0}$ \\
      $\text{\SAMPLES}_{p~0}$ \\
    \end{tabular}\right\rbrace \leftarrow$ \hyperref[wavpack:correlate_1ch]{correlate 1 channel $\text{\PASS}_{i - 1}$} using $\left\lbrace\begin{tabular}{l}
    $\text{\TERM}_{i}$ \\
    $\text{\DELTA}_{i}$ \\
    $\text{\WEIGHT}_{p~0}$ \\
    $\text{\SAMPLES}_{p~0}$ \\
    \end{tabular}\right.$\;
  }
  \Return $\text{\PASS}_{(\TERMCOUNT - 1)}$, updated $\text{\WEIGHT}$, updated $\text{\SAMPLES}$\;
}{
  $\text{\PASS}_{-1~0} \leftarrow \text{\CHANNEL}_0$\;
  $\text{\PASS}_{-1~1} \leftarrow \text{\CHANNEL}_1$\;
  \For(\tcc*[f]{perform passes in reverse order}){$i \leftarrow 0$ \emph{\KwTo}\TERMCOUNT}{
    $p \leftarrow \TERMCOUNT - i - 1$\;
    $\left.\begin{tabular}{r}
      $\text{\PASS}_{i~0}$ \\
      $\text{\PASS}_{i~1}$ \\
      $\text{\WEIGHT}_{p~0}$ \\
      $\text{\WEIGHT}_{p~1}$ \\
      $\text{\SAMPLES}_{p~0}$ \\
      $\text{\SAMPLES}_{p~1}$ \\
    \end{tabular}\right\rbrace \leftarrow$ \hyperref[wavpack:correlate_2ch]{correlate 2 channel $\text{\PASS}_{i - 1}$} using $\left\lbrace\begin{tabular}{l}
    $\text{\TERM}_{i}$ \\
    $\text{\DELTA}_{i}$ \\
    $\text{\WEIGHT}_{p~0}$ \\
    $\text{\WEIGHT}_{p~1}$ \\
    $\text{\SAMPLES}_{p~0}$ \\
    $\text{\SAMPLES}_{p~1}$ \\
    \end{tabular}\right.$\;
  }
  \Return $\text{\PASS}_{(\TERMCOUNT - 1)}$, updated $\text{\WEIGHT}$, updated $\text{\SAMPLES}$\;
}
\EALGORITHM

\clearpage

\subsection{1 Channel Correlation Pass}
\label{wavpack:correlate_1ch}
{\relsize{-1}
\ALGORITHM{a list of signed uncorrelated samples; correlation term, delta, weight and samples}{a list of signed correlated samples; updated weight and sample values}
\SetKwData{CORRELATED}{correlated}
\SetKwData{DECORRELATED}{uncorrelated}
\SetKwData{DECORRSAMPLE}{correlation sample}
\SetKwData{WEIGHT}{weight}
\SetKwData{DELTA}{delta}
\SetKwData{TEMP}{temp}
\SetKw{OR}{or}
\SetKw{XOR}{xor}
\SetKwFunction{APPLYWEIGHT}{apply\_weight}
\SetKwFunction{UPDATEWEIGHT}{update\_weight}
$\text{\WEIGHT}_0 \leftarrow$ decorrelation weight\;
\BlankLine
\uIf{$term = 18$}{
  $\text{\DECORRELATED}_{-2} \leftarrow \text{\DECORRSAMPLE}_1$\;
  $\text{\DECORRELATED}_{-1} \leftarrow \text{\DECORRSAMPLE}_0$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}uncorrelated samples length}{
    $\text{\TEMP}_{i} \leftarrow \lfloor(3 \times \text{\DECORRELATED}_{i - 1} - \text{\DECORRELATED}_{i - 2}) \div 2 \rfloor$\;
    $\text{\CORRELATED}_i \leftarrow \text{\DECORRELATED}_i - \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\TEMP}_{i})$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\TEMP}_{i}~,~\text{\CORRELATED}_i~,~\DELTA)$\;
  }
  \Return $\left\lbrace\begin{tabular}{l}
  \CORRELATED \\
  $\text{\WEIGHT}_i$ \\
  $\DECORRSAMPLE \leftarrow$ \texttt{[}$\text{\DECORRELATED}_{(i - 2)}$, $\text{\DECORRELATED}_{(i - 1)}$ \texttt{]} \\
  \end{tabular}\right.$\;
}
\uElseIf{$term = 17$}{
  $\text{\DECORRELATED}_{-2} \leftarrow \text{\DECORRSAMPLE}_1$\;
  $\text{\DECORRELATED}_{-1} \leftarrow \text{\DECORRSAMPLE}_0$\;
  \For{$i \leftarrow 0$ \emph{\KwTo}uncorrelated samples length}{
    $\text{\TEMP}_{i} \leftarrow 2 \times \text{\DECORRELATED}_{i - 1} - \text{\DECORRELATED}_{i - 2}$\;
    $\text{\CORRELATED}_i \leftarrow  \text{\DECORRELATED}_i - \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\TEMP}_{i})$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\TEMP}_{i}~,~\text{\CORRELATED}_i~,~\DELTA)$\;
  }
  \Return $\left\lbrace\begin{tabular}{l}
  \CORRELATED \\
  $\text{\WEIGHT}_i$ \\
  $\DECORRSAMPLE \leftarrow$ \texttt{[}$\text{\DECORRELATED}_{(i - 2)}$, $\text{\DECORRELATED}_{(i - 1)}$ \texttt{]} \\
  \end{tabular}\right.$\;
}
\uElseIf{$1 \leq term \leq 8$}{
  \For{$i \leftarrow 0$ \emph{\KwTo}term}{
    $\text{\DECORRELATED}_{i - \text{term}} \leftarrow \text{\DECORRSAMPLE}_i$\;
  }
  \For{$i \leftarrow 0$ \emph{\KwTo}correlated samples length}{
    $\text{\CORRELATED}_i \leftarrow  \text{\DECORRELATED}_i - \APPLYWEIGHT(\text{\WEIGHT}_i~,~\text{\DECORRELATED}_{i - \text{term}})$\;
    $\text{\WEIGHT}_{i + 1} \leftarrow \text{\WEIGHT}_i + \UPDATEWEIGHT(\text{\DECORRELATED}_{i - \text{term}}~,~\text{\CORRELATED}_i~,~\DELTA)$\;
  }
  \Return $\left\lbrace\begin{tabular}{l}
  \CORRELATED \\
  $\text{\WEIGHT}_i$ \\
  $\DECORRSAMPLE \leftarrow$ last $term$ \DECORRELATED samples \\
  \end{tabular}\right.$\;
}
\Else{
  invalid decorrelation term\;
}
\EALGORITHM
\par
\noindent
\begin{align*}
\intertext{where \texttt{apply\_weight} is defined as:}
\texttt{apply\_weight}(weight~,~sample) &= \left\lfloor\frac{weight \times sample + 2 ^ 9}{2 ^ {10}}\right\rfloor \\
\intertext{and \texttt{update\_weight} is defined as:}
\texttt{update\_weight}(source~,~result~,~delta) &=
\begin{cases}
0 & \text{ if } source = 0 \text{ or } result = 0 \\
delta & \text{ if } (source \textbf{ xor } result ) \geq 0 \\
-delta & \text{ if } (source \textbf{ xor } result) < 0
\end{cases}
\end{align*}
}

\clearpage

\subsection{2 Channel Correlation Pass}
\label{wavpack:correlate_2ch}
{\relsize{-1}
\ALGORITHM{2 lists of signed uncorrelated samples; correlation term and delta, 2 correlation weights, 2 lists of correlation samples}{2 lists of signed correlated samples; updated weight and sample values per channel}
\SetKwData{TERM}{term}
\SetKwData{DELTA}{delta}
\SetKwData{CORRELATED}{correlated}
\SetKwData{DECORRELATED}{uncorrelated}
\SetKwData{DECORRSAMPLE}{correlation sample}
\SetKwData{WEIGHT}{weight}
\SetKw{OR}{or}
\SetKw{XOR}{xor}
\SetKwFunction{MIN}{min}
\SetKwFunction{MAX}{max}
\SetKwFunction{APPLYWEIGHT}{apply\_weight}
\SetKwFunction{UPDATEWEIGHT}{update\_weight}
\uIf{$(17 \leq \TERM \leq 18)$ \OR $(1 \leq \TERM \leq 8)$}{
  $\left.\begin{tabular}{r}
    $\text{\CORRELATED}_{0}$ \\
    $\text{\WEIGHT}_{0}$ \\
    $\text{\DECORRSAMPLE}_{0}$ \\
  \end{tabular}\right\rbrace \leftarrow$ \hyperref[wavpack:correlate_1ch]{correlate 1 channel $\text{\DECORRELATED}_{0}$} using $\left\lbrace\begin{tabular}{l}
  $\text{\TERM}$ \\
  $\text{\DELTA}$ \\
  $\text{\WEIGHT}_{0}$ \\
  $\text{\DECORRSAMPLE}_{0}$ \\
  \end{tabular}\right.$\;
  $\left.\begin{tabular}{r}
    $\text{\CORRELATED}_{1}$ \\
    $\text{\WEIGHT}_{1}$ \\
    $\text{\DECORRSAMPLE}_{1}$ \\
  \end{tabular}\right\rbrace \leftarrow$ \hyperref[wavpack:correlate_1ch]{correlate 1 channel $\text{\DECORRELATED}_{1}$} using $\left\lbrace\begin{tabular}{l}
  $\text{\TERM}$ \\
  $\text{\DELTA}$ \\
  $\text{\WEIGHT}_{1}$ \\
  $\text{\DECORRSAMPLE}_{1}$ \\
  \end{tabular}\right.$\;
  \Return $\left\lbrace\begin{tabular}{l}
  $\text{\CORRELATED}$ \\
  $\text{\WEIGHT}$ \\
  $\text{\DECORRSAMPLE}$ \\
  \end{tabular}\right.$\;
}
\uElseIf{$-3 \leq \TERM \leq -1$}{
  $\text{\WEIGHT}_{0~0} \leftarrow$ correlation weight 0\;
  $\text{\WEIGHT}_{1~0} \leftarrow$ correlation weight 1\;
  $\text{\DECORRELATED}_{0~-1} \leftarrow \text{\DECORRSAMPLE}_{1~0}$\;
  $\text{\DECORRELATED}_{1~-1} \leftarrow \text{\DECORRSAMPLE}_{0~0}$\;
  \uIf{$\TERM = -1$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}uncorrelated samples length}{
      $\text{\CORRELATED}_{0~i} \leftarrow  \text{\DECORRELATED}_{0~i} - \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~(i - 1)})$\;
      $\text{\CORRELATED}_{1~i} \leftarrow \text{\DECORRELATED}_{1~i} - \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~i})$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~(i - 1)}~,~\text{\CORRELATED}_{0~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~i}~,~\text{\CORRELATED}_{1~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \uElseIf{$\TERM = -2$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}uncorrelated samples length}{
      $\text{\CORRELATED}_{0~i} \leftarrow \text{\DECORRELATED}_{0~i} - \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~i})$\;
      $\text{\CORRELATED}_{1~i} \leftarrow \text{\DECORRELATED}_{1~i} - \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~({i - 1})})$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~i}~,~\text{\CORRELATED}_{0~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~(i - 1)}~,~\text{\CORRELATED}_{1~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \ElseIf{$\TERM = -3$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}uncorrelated samples length}{
      $\text{\CORRELATED}_{0~i} \leftarrow \text{\DECORRELATED}_{0~i} - \APPLYWEIGHT(\text{\WEIGHT}_{0~i}~,~\text{\DECORRELATED}_{1~(i - 1)})$\;
      $\text{\CORRELATED}_{1~i} \leftarrow \text{\DECORRELATED}_{1~i} - \APPLYWEIGHT(\text{\WEIGHT}_{1~i}~,~\text{\DECORRELATED}_{0~(i - 1)})$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \text{\WEIGHT}_{0~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{1~(i - 1)}~,~\text{\CORRELATED}_{0~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \text{\WEIGHT}_{1~i} + \UPDATEWEIGHT(\text{\DECORRELATED}_{0~(i - 1)}~,~\text{\CORRELATED}_{1~i}~,~\DELTA)$\;
      $\text{\WEIGHT}_{0~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{0~(i + 1)}~,~1024)~,~-1024)$\;
      $\text{\WEIGHT}_{1~(i + 1)} \leftarrow \MAX(\MIN(\text{\WEIGHT}_{1~(i + 1)}~,~1024)~,~-1024)$\;
    }
  }
  \Return $\left\lbrace\begin{tabular}{l}
  $\text{\CORRELATED}$ \\
  $\text{\WEIGHT}_{0~i}$ \\
  $\text{\WEIGHT}_{1~i}$ \\
  $\text{\DECORRSAMPLE}_{0~0} \leftarrow \text{\DECORRELATED}_{1~i}$ \\
  $\text{\DECORRSAMPLE}_{1~0} \leftarrow \text{\DECORRELATED}_{0~i}$ \\
  \end{tabular}\right.$\;
}
\Else{
  invalid decorrelation term\;
}
\EALGORITHM
}

\clearpage

\subsection{Channel Correlation Example}
\begin{figure}[h]
{\relsize{-1}
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Correlation Terms} \\
      \hline
      $p$ & $\textsf{term}_p$ & $\textsf{delta}_p$ \\
      \hline
      0 & 3 & 2 \\
      1 & 17 & 2 \\
      2 & 2 & 2 \\
      3 & 18 & 2 \\
      4 & 18 & 2 \\
      \hline
    \end{tabular}
  }
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Correlation Weights} \\
      \hline
      $p$ & $\textsf{weight}_{p~0}$ & $\textsf{weight}_{p~1}$ \\
      \hline
      0 & 16 & 24 \\
      1 & 48 & 48 \\
      2 & 32 & 32 \\
      3 & 48 & 48 \\
      4 & 48 & 48 \\
      \hline
    \end{tabular}
  }
  \subfloat{
    \begin{tabular}{|r|r|r|}
      \multicolumn{3}{c}{Correlation Samples} \\
      \hline
      $p$ & $\textsf{sample}_{p~0~s}$ & $\textsf{sample}_{p~1~s}$ \\
      \hline
      0 & \texttt{[0, 0, 0]} & \texttt{[0, 0, 0]} \\
      1 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      2 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      3 & \texttt{[0, 0]} & \texttt{[0, 0]} \\
      4 & \texttt{[-73, -78]} & \texttt{[28, 26]} \\
      \hline
    \end{tabular}
  }
}
\end{figure}
\par
\noindent
we combine them into a single set of arguments for each correlation pass:
\begin{table}[h]
{\relsize{-1}
  \begin{tabular}{|r|r|r|r|r|r|}
    \hline
    & $\textbf{pass}_0$ & $\textbf{pass}_1$ & $\textbf{pass}_2$ &
    $\textbf{pass}_3$ & $\textbf{pass}_3$ \\
    \hline
    $\textsf{term}_p$ & 18 & 18 & 2 & 17 & 3 \\
    $\textsf{delta}_p$ & 2 & 2 & 2 & 2 & 2 \\
    $\textsf{weight}_{p~0}$ & 48 & 48 & 32 & 48 & 16 \\
    $\textsf{sample}_{p~0~s}$ & \texttt{[-73, -78]} & \texttt{[0, 0]} &
    \texttt{[0, 0]} & \texttt{[0, 0]} & \texttt{[0, 0, 0]} \\
    $\textsf{weight}_{p~1}$ & 48 & 48 & 32 & 48 & 24 \\
    $\textsf{sample}_{p~1~s}$ & \texttt{[28, 26]} & \texttt{[0, 0]} &
    \texttt{[0, 0]} & \texttt{[0, 0]} & \texttt{[0, 0, 0]} \\
    \hline
  \end{tabular}
}
\end{table}
\par
\noindent
which we apply to the residuals from the bitstream sub-block:
\par
\noindent
{\relsize{-1}
  \begin{tabular}{|r|r|r|r|r|r|}
    \hline
    $\textsf{channel}_{0~i}$ &
    after $\textbf{pass}_0$ &
    after $\textbf{pass}_1$ &
    after $\textbf{pass}_2$ &
    after $\textbf{pass}_3$ &
    after $\textbf{pass}_4$ \\
    \hline
    -64 & -61 & -61 & -61 & -61 & -61 \\
    -46 & -43 & -39 & -39 & -33 & -33 \\
    -25 & -23 & -21 & -19 & -18 & -18 \\
    -3 & -2 & -1 & 0 & 0 & 1 \\
    20 & 20 & 20 & 21 & 20 & 20 \\
    41 & 39 & 37 & 37 & 35 & 35 \\
    60 & 57 & 54 & 53 & 50 & 50 \\
    75 & 71 & 67 & 66 & 62 & 62 \\
    85 & 80 & 75 & 73 & 68 & 68 \\
    90 & 84 & 79 & 77 & 72 & 71 \\
    \hline
    \hline
    $\textsf{channel}_{1~i}$ &
    after $\textbf{pass}_0$ &
    after $\textbf{pass}_1$ &
    after $\textbf{pass}_2$ &
    after $\textbf{pass}_3$ &
    after $\textbf{pass}_4$ \\
    \hline
    32 & 31 & 31 & 31 & 31 & 31 \\
    39 & 37 & 35 & 35 & 32 & 32 \\
    43 & 41 & 39 & 38 & 36 & 36 \\
    45 & 43 & 41 & 40 & 38 & 37 \\
    44 & 41 & 39 & 38 & 36 & 35 \\
    40 & 38 & 36 & 34 & 32 & 31 \\
    34 & 32 & 30 & 28 & 26 & 25 \\
    25 & 23 & 21 & 20 & 19 & 18 \\
    15 & 14 & 13 & 12 & 11 & 10 \\
    4 & 3 & 2 & 1 & 1 & 0 \\
    \hline
  \end{tabular}
}
\par
\noindent
Resulting in final correlated samples:
\newline
\begin{tabular}{rr}
$\textsf{residual}_0$ : & \texttt{[-61,~-33,~-18,~~1,~20,~35,~50,~62,~68,~71]} \\
$\textsf{residual}_1$ : & \texttt{[~31,~~32,~~36,~37,~35,~31,~25,~18,~10,~~0]} \\
\end{tabular}

\clearpage

{\relsize{-2}
\begin{tabular}{r||r|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
& $i$ & \textsf{uncorrelated}_i & \textsf{temp}_i & \textsf{correlated}_i & \textsf{weight}_{i + 1} \\
\hline
%%START
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_0$ - term 18\end{sideways}}
& 0 & -64 &
\lfloor(3 \times -73 + 78) \div 2\rfloor = -71 &
-64 - \lfloor(48 \times -71 + 2 ^ 9) \div 2 ^ {10}\rfloor = -61 &
48 + 2 = 50
\\
& 1 & -46 &
\lfloor(3 \times -64 + 73) \div 2\rfloor = -60 &
-46 - \lfloor(50 \times -60 + 2 ^ 9) \div 2 ^ {10}\rfloor = -43 &
50 + 2 = 52
\\
& 2 & -25 &
\lfloor(3 \times -46 + 64) \div 2\rfloor = -37 &
-25 - \lfloor(52 \times -37 + 2 ^ 9) \div 2 ^ {10}\rfloor = -23 &
52 + 2 = 54
\\
& 3 & -3 &
\lfloor(3 \times -25 + 46) \div 2\rfloor = -15 &
-3 - \lfloor(54 \times -15 + 2 ^ 9) \div 2 ^ {10}\rfloor = -2 &
54 + 2 = 56
\\
& 4 & 20 &
\lfloor(3 \times -3 + 25) \div 2\rfloor = 8 &
20 - \lfloor(56 \times 8 + 2 ^ 9) \div 2 ^ {10}\rfloor = 20 &
56 + 2 = 58
\\
& 5 & 41 &
\lfloor(3 \times 20 + 3) \div 2\rfloor = 31 &
41 - \lfloor(58 \times 31 + 2 ^ 9) \div 2 ^ {10}\rfloor = 39 &
58 + 2 = 60
\\
& 6 & 60 &
\lfloor(3 \times 41 - 20) \div 2\rfloor = 51 &
60 - \lfloor(60 \times 51 + 2 ^ 9) \div 2 ^ {10}\rfloor = 57 &
60 + 2 = 62
\\
& 7 & 75 &
\lfloor(3 \times 60 - 41) \div 2\rfloor = 69 &
75 - \lfloor(62 \times 69 + 2 ^ 9) \div 2 ^ {10}\rfloor = 71 &
62 + 2 = 64
\\
& 8 & 85 &
\lfloor(3 \times 75 - 60) \div 2\rfloor = 82 &
85 - \lfloor(64 \times 82 + 2 ^ 9) \div 2 ^ {10}\rfloor = 80 &
64 + 2 = 66
\\
& 9 & 90 &
\lfloor(3 \times 85 - 75) \div 2\rfloor = 90 &
90 - \lfloor(66 \times 90 + 2 ^ 9) \div 2 ^ {10}\rfloor = 84 &
66 + 2 = 68
\\
\hline
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_1$ - term 18\end{sideways}}
& 0 & -61 &
\lfloor(3 \times 0 - 0) \div 2\rfloor = 0 &
-61 - \lfloor(48 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -61 &
48 + 0 = 48
\\
& 1 & -43 &
\lfloor(3 \times -61 - 0) \div 2\rfloor = -92 &
-43 - \lfloor(48 \times -92 + 2 ^ 9) \div 2 ^ {10}\rfloor = -39 &
48 + 2 = 50
\\
& 2 & -23 &
\lfloor(3 \times -43 + 61) \div 2\rfloor = -34 &
-23 - \lfloor(50 \times -34 + 2 ^ 9) \div 2 ^ {10}\rfloor = -21 &
50 + 2 = 52
\\
& 3 & -2 &
\lfloor(3 \times -23 + 43) \div 2\rfloor = -13 &
-2 - \lfloor(52 \times -13 + 2 ^ 9) \div 2 ^ {10}\rfloor = -1 &
52 + 2 = 54
\\
& 4 & 20 &
\lfloor(3 \times -2 + 23) \div 2\rfloor = 8 &
20 - \lfloor(54 \times 8 + 2 ^ 9) \div 2 ^ {10}\rfloor = 20 &
54 + 2 = 56
\\
& 5 & 39 &
\lfloor(3 \times 20 + 2) \div 2\rfloor = 31 &
39 - \lfloor(56 \times 31 + 2 ^ 9) \div 2 ^ {10}\rfloor = 37 &
56 + 2 = 58
\\
& 6 & 57 &
\lfloor(3 \times 39 - 20) \div 2\rfloor = 48 &
57 - \lfloor(58 \times 48 + 2 ^ 9) \div 2 ^ {10}\rfloor = 54 &
58 + 2 = 60
\\
& 7 & 71 &
\lfloor(3 \times 57 - 39) \div 2\rfloor = 66 &
71 - \lfloor(60 \times 66 + 2 ^ 9) \div 2 ^ {10}\rfloor = 67 &
60 + 2 = 62
\\
& 8 & 80 &
\lfloor(3 \times 71 - 57) \div 2\rfloor = 78 &
80 - \lfloor(62 \times 78 + 2 ^ 9) \div 2 ^ {10}\rfloor = 75 &
62 + 2 = 64
\\
& 9 & 84 &
\lfloor(3 \times 80 - 71) \div 2\rfloor = 84 &
84 - \lfloor(64 \times 84 + 2 ^ 9) \div 2 ^ {10}\rfloor = 79 &
64 + 2 = 66
\\
\hline
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_2$ - term 2\end{sideways}}
& 0 & -61 & &
-61 - \lfloor(32 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -61 &
32 + 0 = 32
\\
& 1 & -39 & &
-39 - \lfloor(32 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -39 &
32 + 0 = 32
\\
& 2 & -21 & &
-21 - \lfloor(32 \times -61 + 2 ^ 9) \div 2 ^ {10}\rfloor = -19 &
32 + 2 = 34
\\
& 3 & -1 & &
-1 - \lfloor(34 \times -39 + 2 ^ 9) \div 2 ^ {10}\rfloor = 0 &
34 + 0 = 34
\\
& 4 & 20 & &
20 - \lfloor(34 \times -21 + 2 ^ 9) \div 2 ^ {10}\rfloor = 21 &
34 - 2 = 32
\\
& 5 & 37 & &
37 - \lfloor(32 \times -1 + 2 ^ 9) \div 2 ^ {10}\rfloor = 37 &
32 - 2 = 30
\\
& 6 & 54 & &
54 - \lfloor(30 \times 20 + 2 ^ 9) \div 2 ^ {10}\rfloor = 53 &
30 + 2 = 32
\\
& 7 & 67 & &
67 - \lfloor(32 \times 37 + 2 ^ 9) \div 2 ^ {10}\rfloor = 66 &
32 + 2 = 34
\\
& 8 & 75 & &
75 - \lfloor(34 \times 54 + 2 ^ 9) \div 2 ^ {10}\rfloor = 73 &
34 + 2 = 36
\\
& 9 & 79 & &
79 - \lfloor(36 \times 67 + 2 ^ 9) \div 2 ^ {10}\rfloor = 77 &
36 + 2 = 38
\\
\hline
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_3$ - term 17\end{sideways}}
& 0 & -61 &
2 \times 0 - 0 = 0 &
-61 - \lfloor(48 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -61 &
48 + 0 = 48
\\
& 1 & -39 &
2 \times -61 - 0 = -122 &
-39 - \lfloor(48 \times -122 + 2 ^ 9) \div 2 ^ {10}\rfloor = -33 &
48 + 2 = 50
\\
& 2 & -19 &
2 \times -39 + 61 = -17 &
-19 - \lfloor(50 \times -17 + 2 ^ 9) \div 2 ^ {10}\rfloor = -18 &
50 + 2 = 52
\\
& 3 & 0 &
2 \times -19 + 39 = 1 &
0 - \lfloor(52 \times 1 + 2 ^ 9) \div 2 ^ {10}\rfloor = 0 &
52 + 0 = 52
\\
& 4 & 21 &
2 \times 0 + 19 = 19 &
21 - \lfloor(52 \times 19 + 2 ^ 9) \div 2 ^ {10}\rfloor = 20 &
52 + 2 = 54
\\
& 5 & 37 &
2 \times 21 - 0 = 42 &
37 - \lfloor(54 \times 42 + 2 ^ 9) \div 2 ^ {10}\rfloor = 35 &
54 + 2 = 56
\\
& 6 & 53 &
2 \times 37 - 21 = 53 &
53 - \lfloor(56 \times 53 + 2 ^ 9) \div 2 ^ {10}\rfloor = 50 &
56 + 2 = 58
\\
& 7 & 66 &
2 \times 53 - 37 = 69 &
66 - \lfloor(58 \times 69 + 2 ^ 9) \div 2 ^ {10}\rfloor = 62 &
58 + 2 = 60
\\
& 8 & 73 &
2 \times 66 - 53 = 79 &
73 - \lfloor(60 \times 79 + 2 ^ 9) \div 2 ^ {10}\rfloor = 68 &
60 + 2 = 62
\\
& 9 & 77 &
2 \times 73 - 66 = 80 &
77 - \lfloor(62 \times 80 + 2 ^ 9) \div 2 ^ {10}\rfloor = 72 &
62 + 2 = 64
\\
\hline
\hline
\multirow{10}{1em}{\begin{sideways}$\textbf{pass}_4$ - term 3\end{sideways}}
& 0 & -61 & &
-61 - \lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -61 &
16 + 0 = 16
\\
& 1 & -33 & &
-33 - \lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -33 &
16 + 0 = 16
\\
& 2 & -18 & &
-18 - \lfloor(16 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = -18 &
16 + 0 = 16
\\
& 3 & 0 & &
0 - \lfloor(16 \times -61 + 2 ^ 9) \div 2 ^ {10}\rfloor = 1 &
16 - 2 = 14
\\
& 4 & 20 & &
20 - \lfloor(14 \times -33 + 2 ^ 9) \div 2 ^ {10}\rfloor = 20 &
14 - 2 = 12
\\
& 5 & 35 & &
35 - \lfloor(12 \times -18 + 2 ^ 9) \div 2 ^ {10}\rfloor = 35 &
12 - 2 = 10
\\
& 6 & 50 & &
50 - \lfloor(10 \times 0 + 2 ^ 9) \div 2 ^ {10}\rfloor = 50 &
10 + 0 = 10
\\
& 7 & 62 & &
62 - \lfloor(10 \times 20 + 2 ^ 9) \div 2 ^ {10}\rfloor = 62 &
10 + 2 = 12
\\
& 8 & 68 & &
68 - \lfloor(12 \times 35 + 2 ^ 9) \div 2 ^ {10}\rfloor = 68 &
12 + 2 = 14
\\
& 9 & 72 & &
72 - \lfloor(14 \times 50 + 2 ^ 9) \div 2 ^ {10}\rfloor = 71 &
14 + 2 = 16
\\
%%END
\end{tabular}
}
\begin{center}
$\text{channel}_0$ correlation passes
\end{center}

\clearpage

\subsection{Writing Decorrelation Terms}
\label{wavpack:write_decorr_terms}
\ALGORITHM{a list of decorrelation terms, a list of decorrelation deltas}{decorrelation terms sub block data}
\SetKwData{TERM}{term}
\SetKwData{DELTA}{delta}
\SetKwData{KwDownTo}{downto}
\For(\tcc*[f]{populate in reverse order}){$p \leftarrow \text{decorrelation pass count}$ \emph{\KwDownTo}0}{
  $\text{\TERM}_p + 5 \rightarrow$ \WRITE 5 unsigned bits\;
  $\text{\DELTA}_p \rightarrow$ \WRITE 3 unsigned bits\;
}
\Return decorrelation terms sub block data\;
\EALGORITHM
\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_terms.pdf}
\end{figure}

\clearpage
For example, given decorrelation terms and deltas:
\begin{table}[h]
\begin{tabular}{rrr}
$p$ & $\textsf{term}_p$ & $\textsf{delta}_p$ \\
\hline
0 & 3 & 2 \\
1 & 17 & 2 \\
2 & 2 & 2 \\
3 & 18 & 2 \\
4 & 18 & 2 \\
\end{tabular}
\end{table}
\par
\noindent
the decorrelation terms sub block is written as:
\begin{figure}[h]
\includegraphics{figures/wavpack/terms_parse.pdf}
\end{figure}

\clearpage

\subsection{Writing Decorrelation Weights}
\label{wavpack:write_decorr_weights}
\ALGORITHM{a list of decorrelation weights per channel}{decorrelation weights sub block data}
\SetKwData{WEIGHT}{weight}
\SetKwFunction{STOREWEIGHT}{store\_weight}
\SetKwData{KwDownTo}{downto}
\For(\tcc*[f]{populate in reverse order}){$p \leftarrow \text{decorrelation pass count}$ \emph{\KwDownTo}0}{
  $\texttt{\STOREWEIGHT}(\text{\WEIGHT}_{p~0}) \rightarrow$ \WRITE 8 signed bits\;
  \If{$\text{channel count} = 2$}{
    $\texttt{\STOREWEIGHT}(\text{\WEIGHT}_{p~1}) \rightarrow$ \WRITE 8 signed bits\;
  }
}
\Return decorrelation weights sub block data\;
\EALGORITHM
\par
\noindent
where \texttt{store\_weight} is defined as:
\begin{equation*}
\texttt{store\_weight}(w) =
\begin{cases}
\left\lfloor\frac{\texttt{min}(w, 1024) - \lfloor(\texttt{min}(w,1024) + 2 ^ 6) \div 2 ^ 7\rfloor + 4}{2 ^ 3}\right\rfloor & \text{ if } w > 0 \\
0 & \text{ if } w = 0 \\
\left\lfloor \frac{\texttt{max}(w, -1024) + 4}{2 ^ 3} \right\rfloor & \text{ if } w < 0 \\
\end{cases}
\end{equation*}
\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_weights.pdf}
\end{figure}
\clearpage
For example, given the decorrelation weight values:
\begin{table}[h]
\begin{tabular}{rrrrr}
$p$ & $\textsf{weight}_{p~0}$ & $\textsf{weight}_{p~1}$ &
$\texttt{store\_weight}(\textsf{weight}_{p~0})$ &
$\texttt{store\_weight}(\textsf{weight}_{p~1})$ \\
\hline
0 & 16 & 24 & 2 & 3 \\
1 & 48 & 48 & 6 & 6 \\
2 & 32 & 32 & 4 & 4 \\
3 & 48 & 48 & 6 & 6 \\
4 & 48 & 48 & 6 & 6 \\
\end{tabular}
\end{table}
\par
\noindent
the decorrelation weights subframe is written as:
\begin{figure}[h]
\includegraphics{figures/wavpack/decorr_weights_parse.pdf}
\end{figure}

\clearpage

\subsection{Writing Decorrelation Samples}
\label{wavpack:write_decorr_samples}
\ALGORITHM{a list of decorrelation sample values per pass, per channel}{decorrelation samples sub block data}
\SetKwData{TERM}{term}
\SetKwData{SAMPLE}{sample}
\SetKwFunction{WVLOG}{wv\_log2}
\SetKw{KwDownTo}{downto}
\For{$p \leftarrow \text{decorrelation pass count}$ \emph{\KwDownTo}0}{
  \uIf{$17 \leq \text{\TERM}_p \leq 18$}{
    \For{$c \leftarrow 0$ \emph{\KwTo}channel count}{
      $\WVLOG(\text{\SAMPLE}_{p~c~0}) \rightarrow$ \WRITE 16 signed bits\;
      $\WVLOG(\text{\SAMPLE}_{p~c~1}) \rightarrow$ \WRITE 16 signed bits\;
    }
  }
  \uElseIf{$1 \leq \text{\TERM}_p \leq 8$}{
    \For{$s \leftarrow 0$ \emph{\KwTo}$\text{\TERM}_p$}{
      \For{$c \leftarrow 0$ \emph{\KwTo}channel count}{
        $\WVLOG(\text{\SAMPLE}_{p~c~s}) \rightarrow$ \WRITE 16 signed bits\;
      }
    }
  }
  \ElseIf{$-3 \leq \text{\TERM}_p \leq -1$}{
    $\WVLOG(\text{\SAMPLE}_{p~0~0}) \rightarrow$ \WRITE 16 signed bits\;
    $\WVLOG(\text{\SAMPLE}_{p~1~0}) \rightarrow$ \WRITE 16 signed bits\;
  }
}
\Return decorrelation samples data\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{figures/wavpack/decorr_samples.pdf}
\end{figure}

\subsubsection{The wv\_log2 Function}
\ALGORITHM{a signed value}{a signed 16 bit value}
\SetKwFunction{LOG}{wlog}
$a \leftarrow |value| + \lfloor |value| \div 2 ^ 9\rfloor$\;
$c \leftarrow $\lIf{$a \neq 0$}{$\lfloor\log_2(a)\rfloor + 1$}
\lElse{$0$}\;
\eIf{$value \geq 0$}{
  \eIf{$0 \leq a < 256$}{
    \Return $c \times 2 ^ 8 + \LOG((a \times 2 ^ {9 - c}) \bmod 256)$\;
  }{
    \Return $c \times 2 ^ 8 + \LOG(\lfloor a \div 2 ^ {c - 9}\rfloor \bmod 256)$\;
  }
}{
    \eIf{$0 \leq a < 256$}{
    \Return $-(c \times 2 ^ 8 + \LOG((a \times 2 ^ {9 - c}) \bmod 256))$\;
  }{
    \Return $-(c \times 2 ^ 8 + \LOG(\lfloor a \div 2 ^ {c - 9}\rfloor \bmod 256))$\;
  }
}
\EALGORITHM

\clearpage

where \texttt{wlog} is defined from the following table:
\par
\noindent
{\relsize{-3}\ttfamily
\begin{tabular}{|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|}
\hline
& \texttt{0x?0} & \texttt{0x?1} & \texttt{0x?2} & \texttt{0x?3} & \texttt{0x?4} & \texttt{0x?5} & \texttt{0x?6} & \texttt{0x?7} & \texttt{0x?8} & \texttt{0x?9} & \texttt{0x?A} & \texttt{0x?B} & \texttt{0x?C} & \texttt{0x?D} & \texttt{0x?E} & \texttt{0x?F} \\
\hline
\texttt{0x0?} & 0 & 1 & 3 & 4 & 6 & 7 & 9 & 10 & 11 & 13 & 14 & 16 & 17 & 18 & 20 & 21 \\
\texttt{0x1?} & 22 & 24 & 25 & 26 & 28 & 29 & 30 & 32 & 33 & 34 & 36 & 37 & 38 & 40 & 41 & 42 \\
\texttt{0x2?} & 44 & 45 & 46 & 47 & 49 & 50 & 51 & 52 & 54 & 55 & 56 & 57 & 59 & 60 & 61 & 62 \\
\texttt{0x3?} & 63 & 65 & 66 & 67 & 68 & 69 & 71 & 72 & 73 & 74 & 75 & 77 & 78 & 79 & 80 & 81 \\
\texttt{0x4?} & 82 & 84 & 85 & 86 & 87 & 88 & 89 & 90 & 92 & 93 & 94 & 95 & 96 & 97 & 98 & 99 \\
\texttt{0x5?} & 100 & 102 & 103 & 104 & 105 & 106 & 107 & 108 & 109 & 110 & 111 & 112 & 113 & 114 & 116 & 117 \\
\texttt{0x6?} & 118 & 119 & 120 & 121 & 122 & 123 & 124 & 125 & 126 & 127 & 128 & 129 & 130 & 131 & 132 & 133 \\
\texttt{0x7?} & 134 & 135 & 136 & 137 & 138 & 139 & 140 & 141 & 142 & 143 & 144 & 145 & 146 & 147 & 148 & 149 \\
\texttt{0x8?} & 150 & 151 & 152 & 153 & 154 & 155 & 155 & 156 & 157 & 158 & 159 & 160 & 161 & 162 & 163 & 164 \\
\texttt{0x9?} & 165 & 166 & 167 & 168 & 169 & 169 & 170 & 171 & 172 & 173 & 174 & 175 & 176 & 177 & 178 & 178 \\
\texttt{0xA?} & 179 & 180 & 181 & 182 & 183 & 184 & 185 & 185 & 186 & 187 & 188 & 189 & 190 & 191 & 192 & 192 \\
\texttt{0xB?} & 193 & 194 & 195 & 196 & 197 & 198 & 198 & 199 & 200 & 201 & 202 & 203 & 203 & 204 & 205 & 206 \\
\texttt{0xC?} & 207 & 208 & 208 & 209 & 210 & 211 & 212 & 212 & 213 & 214 & 215 & 216 & 216 & 217 & 218 & 219 \\
\texttt{0xD?} & 220 & 220 & 221 & 222 & 223 & 224 & 224 & 225 & 226 & 227 & 228 & 228 & 229 & 230 & 231 & 231 \\
\texttt{0xE?} & 232 & 233 & 234 & 234 & 235 & 236 & 237 & 238 & 238 & 239 & 240 & 241 & 241 & 242 & 243 & 244 \\
\texttt{0xF?} & 244 & 245 & 246 & 247 & 247 & 248 & 249 & 249 & 250 & 251 & 252 & 252 & 253 & 254 & 255 & 255 \\
\hline
\end{tabular}
}

\subsubsection{Writing Decorrelation Samples Example}
Given a 2 channel subframe with 5 correlation passes containing
the following correlation samples:
\begin{table}[h]
\begin{tabular}{rrrr}
pass $p$ & $\text{term}_p$ & $\text{sample}_{p~0~s}$ & $\text{sample}_{p~1~s}$ \\
\hline
0 & 3 & \texttt{[62, 68, 71]} & \texttt{[0, 10, 18]} \\
1 & 17 & \texttt{[72, 68]} & \texttt{[11, 1]} \\
2 & 2 & \texttt{[73, 77]} & \texttt{[1, 12]} \\
3 & 18 & \texttt{[79, 75]} & \texttt{[13, 2]} \\
4 & 18 & \texttt{[84, 80]} & \texttt{[14, 3]} \\
\end{tabular}
\end{table}
\par
\noindent
$\text{sample}_{4~0~0}$ (pass 4, channel 0, sample 0) is encoded as:
\begin{align*}
a &\leftarrow |84| + \lfloor|84| \div 2 ^ 9\rfloor = 84 \\
c &\leftarrow \lfloor\log_2(84)\rfloor + 1 = 7 \\
value &\leftarrow 7 \times 2 ^ 8 + \texttt{wlog}((84 \times 2 ^ 2) \bmod 256) \\
&\leftarrow 1792 + \texttt{wlog}(\texttt{0x50}) = 1892 = \texttt{0x764}
\end{align*}
\par
\noindent
and the entire sub block is written as:
\begin{figure}[h]
\includegraphics{figures/wavpack/decorr_samples_encode.pdf}
\end{figure}

\clearpage

\subsection{Writing Entropy Variables}
\label{wavpack:write_entropy}
\ALGORITHM{3 entropy variables per channel, channel count}{entropy variables sub block data}
\SetKwData{ENTROPY}{entropy}
\SetKwFunction{WVLOG}{wv\_log2}
$\WVLOG(\text{\ENTROPY}_{0~0}) \rightarrow$ \WRITE 16 signed bits\;
$\WVLOG(\text{\ENTROPY}_{0~1}) \rightarrow$ \WRITE 16 signed bits\;
$\WVLOG(\text{\ENTROPY}_{0~2}) \rightarrow$ \WRITE 16 signed bits\;
\If{$\text{channel count} = 2$}{
  $\WVLOG(\text{\ENTROPY}_{1~0}) \rightarrow$ \WRITE 16 signed bits\;
  $\WVLOG(\text{\ENTROPY}_{1~1}) \rightarrow$ \WRITE 16 signed bits\;
  $\WVLOG(\text{\ENTROPY}_{1~2}) \rightarrow$ \WRITE 16 signed bits\;
}
\Return entropy variables sub block data\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{figures/wavpack/entropy_vars.pdf}
\end{figure}

\clearpage

\subsection{Encoding Bitstream}
\label{wavpack:write_bitstream}
{\relsize{-1}
\ALGORITHM{channel count, entropy values, a list of signed residual values per channel}{bitstream sub block data}
\SetKwData{UNDEFINED}{undefined}
\SetKwData{RESIDUAL}{residual}
\SetKwData{ENTROPY}{entropy}
\SetKwData{BLOCKSAMPLES}{block samples}
\SetKwData{CHANNELCOUNT}{channel count}
\SetKwData{ZEROES}{zeroes}
\SetKwData{OFFSET}{offset}
\SetKwData{ADD}{add}
\SetKwData{SIGN}{sign}
\SetKw{AND}{and}
\SetKw{OR}{or}
\SetKw{IS}{is}
\SetKwFunction{FLUSH}{flush}
\SetKwFunction{UNARYUNDEFINED}{unary\_undefined}
\SetKwFunction{ENCODERESIDUAL}{encode\_residual}
\SetKwFunction{UNARY}{unary}
\SetKwFunction{WRITERESIDUAL}{write\_residual}
$u_{(-2)} \leftarrow \text{\UNDEFINED}$\;
$\text{\ZEROES}_{(-1)} \leftarrow m_{(-1)} \leftarrow \text{\OFFSET}_{(-1)} \leftarrow \text{\ADD}_{(-1)} \leftarrow \text{\SIGN}_{(-1)} \leftarrow \text{\UNDEFINED}$\tcc*[r]{buffered $\text{residual}_{i - 1}$}
$i \leftarrow 0$\;
\BlankLine
\While{$i < (\text{\BLOCKSAMPLES} \times \text{\CHANNELCOUNT})$}{
  $r_i \leftarrow \text{\RESIDUAL}_{(i \bmod \text{\CHANNELCOUNT})~\lfloor i \div \text{\CHANNELCOUNT}\rfloor}$\;
  \eIf{$(\text{\ENTROPY}_{0~0} < 2)$ \AND $(\text{\ENTROPY}_{1~0} < 2)$ \AND $\UNARYUNDEFINED(u_{i - 2}~,~m_{i - 1})$}{
    \eIf(\tcc*[f]{in a block of zeroes}){$(\text{\ZEROES}_{i - 1} \neq \text{\UNDEFINED})$ \AND $(m_{i - 1} = \text{\UNDEFINED})$}{
      \eIf(\tcc*[f]{continue block of zeroes}){$r_i = 0$}{
        $\text{\ZEROES}_i \leftarrow \text{\ZEROES}_{i - 1} + 1$\;
        $(u_{i - 1}~,~m_i~,~\text{\OFFSET}_i~,~\text{\ADD}_i~,~\text{\SIGN}_i) \leftarrow (u_{i - 2}~,~m_{i - 1}~,~\text{\OFFSET}_{i - 1}~,~\text{\ADD}_{i - 1}~,~\text{\SIGN}_{i - 1})$\;
      }(\tcc*[f]{end block of zeroes}){
        $\text{\ZEROES}_i \leftarrow \text{\ZEROES}_{i - 1}$\;
        $(m_i~,~\text{\OFFSET}_i~,~\text{\ADD}_i~,~\text{\SIGN}_i) \leftarrow \hyperref[wavpack:encode_residual]{\ENCODERESIDUAL(r_i~,~\text{\ENTROPY}_{(i \bmod \text{\CHANNELCOUNT})})}$\;
      }
    }(\tcc*[f]{start a new block of zeroes}){
      \eIf{$r_i = 0$}{
        $\text{\ZEROES}_i \leftarrow 1$\;
        $m_i \leftarrow \text{\OFFSET}_i \leftarrow \text{\ADD}_i \leftarrow \text{\SIGN}_i \leftarrow \text{\UNDEFINED}$\;
        $u_{i - 1} \leftarrow \hyperref[wavpack:flush_residual]{\FLUSH(u_{i - 2}~,~\text{\ZEROES}_{i - 1}~,~m_{i - 1}~,~\text{\OFFSET}_{i - 1}~,~\text{\ADD}_{i - 1}~,~\text{\SIGN}_{i - 1}~,~0)}$\;
        $\text{\ENTROPY}_{0~0} \leftarrow \text{\ENTROPY}_{0~1} \leftarrow \text{\ENTROPY}_{0~2} \leftarrow \text{\ENTROPY}_{1~0} \leftarrow \text{\ENTROPY}_{1~1} \leftarrow \text{\ENTROPY}_{1~2} \leftarrow 0$\;
      }(\tcc*[f]{false-alarm block of zeroes}){
        $\text{\ZEROES}_i \leftarrow 0$\;
        $(m_i~,~\text{\OFFSET}_i~,~\text{\ADD}_i~,~\text{\SIGN}_i) \leftarrow \hyperref[wavpack:encode_residual]{\ENCODERESIDUAL(r_i~,~\text{\ENTROPY}_{(i \bmod \text{\CHANNELCOUNT})})}$\;
        $u_{i - 1} \leftarrow \hyperref[wavpack:flush_residual]{\FLUSH(u_{i - 2}~,~\text{\ZEROES}_{i - 1}~,~m_{i - 1}~,~\text{\OFFSET}_{i - 1}~,~\text{\ADD}_{i - 1}~,~\text{\SIGN}_{i - 1}~,~m_i)}$\;
      }
    }
  }(\tcc*[f]{encode regular residual}){
    $\text{\ZEROES}_i \leftarrow \text{\UNDEFINED}$\;
    $(m_i~,~\text{\OFFSET}_i~,~\text{\ADD}_i~,~\text{\SIGN}_i) \leftarrow \hyperref[wavpack:encode_residual]{\ENCODERESIDUAL(r_i~,~\text{\ENTROPY}_{(i \bmod \text{\CHANNELCOUNT})})}$\;
    $u_{i - 1} \leftarrow \hyperref[wavpack:flush_residual]{\FLUSH(u_{i - 2}~,~\text{\ZEROES}_{i - 1}~,~m_{i - 1}~,~\text{\OFFSET}_{i - 1}~,~\text{\ADD}_{i - 1}~,~\text{\SIGN}_{i - 1}~,~m_i)}$\;
  }
  $i \leftarrow i + 1$\;
}
\BlankLine
\tcc{flush final residual}
$u_{i - 1} \leftarrow \hyperref[wavpack:flush_residual]{\FLUSH(u_{i - 2}~,~\text{\ZEROES}_{i - 1}~,~m_{i - 1}~,~\text{\OFFSET}_{i - 1}~,~\text{\ADD}_{i - 1}~,~\text{\SIGN}_{i - 1}~,~0)}$\;
\BlankLine
\Return encoded bitstream sub block\;
\EALGORITHM

\subsubsection{\texttt{unary\_undefined} Function}
\ALGORITHM{$u_{i - 2}$, $m_{i - 1}$}{whether $u_{i - 1}$ is defined}
\SetKw{AND}{and}
\SetKw{IS}{is}
\SetKw{NOT}{not}
\SetKwData{TRUE}{true}
\SetKwData{FALSE}{false}
\SetKwData{UNDEFINED}{undefined}
\uIf{$m_{i - 1} = \text{\UNDEFINED}$}{
  \Return \TRUE\tcc*[r]{$u_{i - 1}$ \IS \UNDEFINED}
}
\uElseIf{$(m_{i - 1} = 0)$ \AND $(u_{i - 2} \neq \UNDEFINED)$ \AND $(u_{i - 2} \bmod 2 = 0)$}{
  \Return \TRUE\tcc*[r]{$u_{i - 1}$ \IS \UNDEFINED}
}
\Else{
  \Return \FALSE\tcc*[r]{$u_{i - 1}$ \IS \NOT \UNDEFINED}
}
\EALGORITHM
}

\clearpage

\subsubsection{\texttt{encode\_residual} Function}
\label{wavpack:encode_residual}
{\relsize{-1}
  \ALGORITHM{signed residual value, entropy variables for channel}{$\text{m}_i$, $\text{offset}_i$, $\text{add}_i$, $\text{sign}_i$; updated entropy values}
  \SetKwData{RESIDUAL}{residual}
  \SetKwData{UNSIGNED}{unsigned}
  \SetKwData{SIGN}{sign}
  \SetKwData{ENTROPY}{entropy}
  \SetKwData{MEDIAN}{median}
  \SetKwData{MED}{m}
  \SetKwData{ADD}{add}
  \SetKwData{OFFSET}{offset}
  \eIf{$\RESIDUAL \geq 0$}{
    $\UNSIGNED \leftarrow \RESIDUAL$\;
    $\text{\SIGN}_i \leftarrow 0$\;
  }{
    $\UNSIGNED \leftarrow -\RESIDUAL - 1$\;
    $\text{\SIGN}_i \leftarrow 1$\;
  }
  $\text{\MEDIAN}_{c~0} \leftarrow \lfloor\text{\ENTROPY}_{c~0} \div 2 ^ 4\rfloor + 1$\;
  $\text{\MEDIAN}_{c~1} \leftarrow \lfloor\text{\ENTROPY}_{c~1} \div 2 ^ 4\rfloor + 1$\;
  $\text{\MEDIAN}_{c~2} \leftarrow \lfloor\text{\ENTROPY}_{c~2} \div 2 ^ 4\rfloor + 1$\;
  \uIf{$\UNSIGNED < \text{\MEDIAN}_{c~0}$}{
    $\text{\MED}_i \leftarrow 0$\;
    $\text{\OFFSET}_i \leftarrow \text{\UNSIGNED}$\tcc*[r]{offset is unsigned - base}
    $\text{\ADD}_i \leftarrow \text{\MEDIAN}_{c~0} - 1$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} - \lfloor(\text{\ENTROPY}_{c~0} + 126) \div 128\rfloor \times 2$\;
  }
  \uElseIf{$(\UNSIGNED - \text{\MEDIAN}_{c~0}) < \text{\MEDIAN}_{c~1}$}{
    $\text{\MED}_i \leftarrow 1$\;
    $\text{\OFFSET}_i \leftarrow \text{\UNSIGNED} - \text{\MEDIAN}_{c~0}$\;
    $\text{\ADD}_i \leftarrow \text{\MEDIAN}_{c~1} - 1$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 128\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} - \lfloor(\text{\ENTROPY}_{c~1} + 62) \div 64\rfloor \times 2$\;
  }
  \uElseIf{$(\UNSIGNED - (\text{\MEDIAN}_{c~0} + \text{\MEDIAN}_{c~1})) < \text{\MEDIAN}_{c~2}$}{
    $\text{\MED}_i \leftarrow 2$\;
    $\text{\OFFSET}_i \leftarrow \text{\UNSIGNED} - (\text{\MEDIAN}_{c~0} + \text{\ENTROPY}_{c~1})$\;
    $\text{\ADD}_i \leftarrow \text{\MEDIAN}_{c~2} - 1$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 128\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} + \lfloor(\text{\ENTROPY}_{c~1} + 64) \div 64\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~2} \leftarrow \text{\ENTROPY}_{c~2} - \lfloor(\text{\ENTROPY}_{c~2} + 30) \div 32\rfloor \times 2$\;
  }
  \Else{
    $\text{\MED}_i \leftarrow \lfloor(\UNSIGNED - (\text{\MEDIAN}_{c~0} + \text{\MEDIAN}_{c~1})) \div \text{\MEDIAN}_{c~2}\rfloor + 2$\;
    $\text{\OFFSET}_i \leftarrow \text{\UNSIGNED} - (\text{\MEDIAN}_{c~0} + \text{\MEDIAN}_{c~1} + ((\text{\MED}_i - 2) \times \text{\MEDIAN}_{c~2}))$\;
    $\text{\ADD}_i \leftarrow \text{\MEDIAN}_{c~2} - 1$\;
    $\text{\ENTROPY}_{c~0} \leftarrow \text{\ENTROPY}_{c~0} + \lfloor(\text{\ENTROPY}_{c~0} + 128) \div 128\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~1} \leftarrow \text{\ENTROPY}_{c~1} + \lfloor(\text{\ENTROPY}_{c~1} + 64) \div 64\rfloor \times 5$\;
    $\text{\ENTROPY}_{c~2} \leftarrow \text{\ENTROPY}_{c~2} + \lfloor(\text{\ENTROPY}_{c~2} + 32) \div 32\rfloor \times 5$\;
  }
  \Return $\left\lbrace\begin{tabular}{l}
  $\text{\MED}_i$ \\
  $\text{\OFFSET}_i$ \\
  $\text{\ADD}_i$ \\
  $\text{\SIGN}_i$ \\
  $\text{\ENTROPY}_c$ \\
  \end{tabular}\right.$\;
  \EALGORITHM
}

\subsubsection{Writing Modified Elias Gamma Code}
\label{wavpack:write_egc}
\ALGORITHM{a non-negative integer value}{an encoded value}
\eIf{$v \leq 1$}{
  $v \rightarrow$ \WUNARY with stop bit 0\;
}{
  $t \leftarrow \lfloor\log_2(v)\rfloor + 1$\;
  $t \rightarrow$ \WUNARY with stop bit 0\;
  $v \bmod 2 ^ {t - 1} \rightarrow$ \WRITE $(t - 1)$ unsigned bits\;
}
\Return encoded value\;
\EALGORITHM

\clearpage

\subsubsection{\texttt{flush} Function}
\label{wavpack:flush_residual}
{\relsize{-1}
  \ALGORITHM{$u_{i - 2}$, $\text{zeroes}_{i - 1}$, $m_{i - 1}$, $\text{offset}_{i - 1}$, $\text{add}_{i - 1}$, $\text{sign}_{i - 1}$, $m_i$}{$u_{i - 1}$}
  \SetKwData{UNDEFINED}{undefined}
  \SetKwData{ZEROES}{zeroes}
  \SetKwData{OFFSET}{offset}
  \SetKwData{ADD}{add}
  \SetKwData{SIGN}{sign}
  \SetKwFunction{UNARY}{unary}
  \SetKwFunction{WRITERESIDUAL}{write\_residual}
  \SetKw{AND}{and}
  \SetKw{OR}{or}
  \If{$\text{\ZEROES}_{i - 1} \neq \text{\UNDEFINED}$}{
    write $\text{\ZEROES}_{i - 1}$ \hyperref[wavpack:write_egc]{in modified Elias gamma code}\;
  }
  \eIf{$m_{i - 1} \neq \text{\UNDEFINED}$}{
    \tcc{calculate $\text{unary}_{i - 1}$ value for $m_{i - 1}$ based on $m_i$}
    \uIf{$(m_{i - 1} > 0)$ \AND $(m_i > 0)$}{
      \eIf{$(u_{i - 2} = \UNDEFINED)$ \OR $(u_{i - 2} \bmod 2 = 0)$}{
        $u_{i - 1} \leftarrow (m_{i - 1} \times 2) + 1$\;
      }{
        $u_{i - 1} \leftarrow (m_{i - 1} \times 2) - 1$\;
      }
    }
    \uElseIf{$(m_{i - 1} = 0)$ \AND $(m_i > 0)$}{
      \eIf{$(u_{i - 2} = \UNDEFINED)$ \OR $(u_{i - 2} \bmod 2 = 1)$}{
        $u_{i - 1} \leftarrow 1$\;
      }{
        $u_{i - 1} \leftarrow \UNDEFINED$\;
      }
    }
    \uElseIf{$(m_{i - 1} > 0)$ \AND $(m_i = 0)$}{
      \eIf{$(u_{i - 2} = \UNDEFINED)$ \OR $(u_{i - 2} \bmod 2 = 0)$}{
        $u_{i - 1} \leftarrow m_{i - 1} \times 2$\;
      }{
        $u_{i - 1} \leftarrow (m_{i - 1} - 1) \times 2$\;
      }
    }
    \ElseIf{$(m_{i - 1} = 0)$ \AND $(m_i = 0)$}{
      \eIf{$(u_{i - 2} = \UNDEFINED)$ \OR $(u_{i - 2} \bmod 2 = 1)$}{
        $u_{i - 1} \leftarrow 0$\;
      }{
        $u_{i - 1} \leftarrow \UNDEFINED$\;
      }
    }
    \BlankLine
    \tcc{write $\text{residual}_{i - 1}$ to disk using $\text{unary}_{i - 1}$}
    \If{$u_{i - 1} \neq \UNDEFINED$}{
      \eIf{$u_{i - 1} < 16$}{
        $u_{i - 1} \rightarrow$ \WUNARY with stop bit 0\;
      }{
        $16 \rightarrow$ \WUNARY with stop bit 0\;
        $u_{i - 1} - 16 \rightarrow$ \hyperref[wavpack:write_egc]{write in modified Elias gamma code}\;
      }
    }
    \If{$\text{\ADD}_{i - 1} > 0$}{
      $p \leftarrow \lfloor\log_2(\text{\ADD}_{i - 1})\rfloor$\;
      $e \leftarrow 2 ^ {p + 1} - \text{\ADD}_{i - 1} - 1$\;
      \eIf{$\text{\OFFSET}_{i - 1} < e$}{
        $r \leftarrow \text{\OFFSET}_{i - 1}$\;
        $r \rightarrow$ \WRITE $p$ unsigned bits\;
      }{
        $r \leftarrow \lfloor(\text{\OFFSET}_{i - 1} + e) \div 2\rfloor$\;
        $b \leftarrow (\text{\OFFSET}_{i - 1} + e) \bmod 2$\;
        $r \rightarrow$ \WRITE $p$ unsigned bits\;
        $b \rightarrow$ \WRITE 1 unsigned bit\;
      }
    }
    $\text{\SIGN}_{i - 1} \rightarrow$ \WRITE 1 unsigned bit\;
  }{
    $u_{i - 1} \leftarrow \text{\UNDEFINED}$\;
  }
  \Return $u_{i - 1}$\;
  \EALGORITHM
}

\clearpage


\begin{landscape}

\subsubsection{Residual Encoding Example}
{\relsize{-2}
\renewcommand{\arraystretch}{1.75}
\begin{tabular}{|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & r_i & \text{unsigned}_i &\text{sign}_i & \text{median}_{c~0} & \text{median}_{c~1} & \text{median}_{c~2} & m_i & \text{offset}_i & \text{add}_i \\
\hline
0 & -61 &
60 & 1 &
\left\lfloor\frac{118}{2 ^ 4}\right\rfloor + 1 = 8 & \left\lfloor\frac{194}{2 ^ 4}\right\rfloor + 1 = 13 & \left\lfloor\frac{322}{2 ^ 4}\right\rfloor + 1 = 21 &
3 & 60 - (8 + 13 + ((3 - 2) \times 21)) = 18 & 21 - 1 = 20
\\
1 & 31 &
31 & 0 &
\left\lfloor\frac{118}{2 ^ 4}\right\rfloor + 1 = 8 & \left\lfloor\frac{176}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{212}{2 ^ 4}\right\rfloor + 1 = 14 &
2 & 31 - (8 + 12) = 11 & 14 - 1 = 13
\\
\hline
2 & -33 &
32 & 1 &
\left\lfloor\frac{123}{2 ^ 4}\right\rfloor + 1 = 8 & \left\lfloor\frac{214}{2 ^ 4}\right\rfloor + 1 = 14 & \left\lfloor\frac{377}{2 ^ 4}\right\rfloor + 1 = 24 &
2 & 32 - (8 + 14) = 10 & 24 - 1 = 23
\\
3 & 32 &
32 & 0 &
\left\lfloor\frac{123}{2 ^ 4}\right\rfloor + 1 = 8 & \left\lfloor\frac{191}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{198}{2 ^ 4}\right\rfloor + 1 = 13 &
2 & 32 - (8 + 12) = 12 & 13 - 1 = 12
\\
\hline
4 & -18 &
17 & 1 &
\left\lfloor\frac{128}{2 ^ 4}\right\rfloor + 1 = 9 & \left\lfloor\frac{234}{2 ^ 4}\right\rfloor + 1 = 15 & \left\lfloor\frac{353}{2 ^ 4}\right\rfloor + 1 = 23 &
1 & 17 - 9 = 8 & 15 - 1 = 14
\\
5 & 36 &
36 & 0 &
\left\lfloor\frac{128}{2 ^ 4}\right\rfloor + 1 = 9 & \left\lfloor\frac{206}{2 ^ 4}\right\rfloor + 1 = 13 & \left\lfloor\frac{184}{2 ^ 4}\right\rfloor + 1 = 12 &
3 & 36 - (9 + 13 + ((3 - 2) \times 12)) = 2 & 12 - 1 = 11
\\
\hline
6 & 1 &
1 & 0 &
\left\lfloor\frac{138}{2 ^ 4}\right\rfloor + 1 = 9 & \left\lfloor\frac{226}{2 ^ 4}\right\rfloor + 1 = 15 & \left\lfloor\frac{353}{2 ^ 4}\right\rfloor + 1 = 23 &
0 & 1 & 9 - 1 = 8
\\
7 & 37 &
37 & 0 &
\left\lfloor\frac{138}{2 ^ 4}\right\rfloor + 1 = 9 & \left\lfloor\frac{226}{2 ^ 4}\right\rfloor + 1 = 15 & \left\lfloor\frac{214}{2 ^ 4}\right\rfloor + 1 = 14 &
2 & 37 - (9 + 15) = 13 & 14 - 1 = 13
\\
\hline
8 & 20 &
20 & 0 &
\left\lfloor\frac{134}{2 ^ 4}\right\rfloor + 1 = 9 & \left\lfloor\frac{226}{2 ^ 4}\right\rfloor + 1 = 15 & \left\lfloor\frac{353}{2 ^ 4}\right\rfloor + 1 = 23 &
1 & 20 - 9 = 11 & 15 - 1 = 14
\\
9 & 35 &
35 & 0 &
\left\lfloor\frac{148}{2 ^ 4}\right\rfloor + 1 = 10 & \left\lfloor\frac{246}{2 ^ 4}\right\rfloor + 1 = 16 & \left\lfloor\frac{200}{2 ^ 4}\right\rfloor + 1 = 13 &
2 & 35 - (10 + 16) = 9 & 13 - 1 = 12
\\
\hline
10 & 35 &
35 & 0 &
\left\lfloor\frac{144}{2 ^ 4}\right\rfloor + 1 = 10 & \left\lfloor\frac{218}{2 ^ 4}\right\rfloor + 1 = 14 & \left\lfloor\frac{353}{2 ^ 4}\right\rfloor + 1 = 23 &
2 & 35 - (10 + 14) = 11 & 23 - 1 = 22
\\
11 & 31 &
31 & 0 &
\left\lfloor\frac{158}{2 ^ 4}\right\rfloor + 1 = 10 & \left\lfloor\frac{266}{2 ^ 4}\right\rfloor + 1 = 17 & \left\lfloor\frac{186}{2 ^ 4}\right\rfloor + 1 = 12 &
2 & 31 - (10 + 17) = 4 & 12 - 1 = 11
\\
\hline
12 & 50 &
50 & 0 &
\left\lfloor\frac{154}{2 ^ 4}\right\rfloor + 1 = 10 & \left\lfloor\frac{238}{2 ^ 4}\right\rfloor + 1 = 15 & \left\lfloor\frac{331}{2 ^ 4}\right\rfloor + 1 = 21 &
3 & 50 - (10 + 15 + ((3 - 2) \times 21)) = 4 & 21 - 1 = 20
\\
13 & 25 &
25 & 0 &
\left\lfloor\frac{168}{2 ^ 4}\right\rfloor + 1 = 11 & \left\lfloor\frac{291}{2 ^ 4}\right\rfloor + 1 = 19 & \left\lfloor\frac{174}{2 ^ 4}\right\rfloor + 1 = 11 &
1 & 25 - 11 = 14 & 19 - 1 = 18
\\
\hline
14 & 62 &
62 & 0 &
\left\lfloor\frac{164}{2 ^ 4}\right\rfloor + 1 = 11 & \left\lfloor\frac{258}{2 ^ 4}\right\rfloor + 1 = 17 & \left\lfloor\frac{386}{2 ^ 4}\right\rfloor + 1 = 25 &
3 & 62 - (11 + 17 + ((3 - 2) \times 25)) = 9 & 25 - 1 = 24
\\
15 & 18 &
18 & 0 &
\left\lfloor\frac{178}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{281}{2 ^ 4}\right\rfloor + 1 = 18 & \left\lfloor\frac{174}{2 ^ 4}\right\rfloor + 1 = 11 &
1 & 18 - 12 = 6 & 18 - 1 = 17
\\
\hline
16 & 68 &
68 & 0 &
\left\lfloor\frac{174}{2 ^ 4}\right\rfloor + 1 = 11 & \left\lfloor\frac{283}{2 ^ 4}\right\rfloor + 1 = 18 & \left\lfloor\frac{451}{2 ^ 4}\right\rfloor + 1 = 29 &
3 & 68 - (11 + 18 + ((3 - 2) \times 29)) = 10 & 29 - 1 = 28
\\
17 & 10 &
10 & 0 &
\left\lfloor\frac{188}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{271}{2 ^ 4}\right\rfloor + 1 = 17 & \left\lfloor\frac{174}{2 ^ 4}\right\rfloor + 1 = 11 &
0 & 10 & 12 - 1 = 11
\\
\hline
18 & 71 &
71 & 0 &
\left\lfloor\frac{184}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{308}{2 ^ 4}\right\rfloor + 1 = 20 & \left\lfloor\frac{526}{2 ^ 4}\right\rfloor + 1 = 33 &
3 & 71 - (12 + 20 + ((3 - 2) \times 33)) = 6 & 33 - 1 = 32
\\
19 & 0 &
0 & 0 &
\left\lfloor\frac{184}{2 ^ 4}\right\rfloor + 1 = 12 & \left\lfloor\frac{271}{2 ^ 4}\right\rfloor + 1 = 17 & \left\lfloor\frac{174}{2 ^ 4}\right\rfloor + 1 = 11 &
0 & 0 & 12 - 1 = 11
\\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}

\clearpage

{\relsize{-2}
\renewcommand{\arraystretch}{1.75}
\begin{tabular}{|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
i & m_i & \text{offset}_i & \text{add}_i & u_i & p_i & e_i & r_i & b_i \\
\hline
0 & 3 &
18 & 20 &
(3 \times 2) + 1 = 7 &
\lfloor\log_2(20)\rfloor = 4 &
2 ^ {(4 + 1)} - 20 - 1 = 11 &
\lfloor(18 + 11) \div 2 \rfloor = 14 &
(18 + 11) \bmod 2  = 1 \\
1 & 2 &
11 & 13 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(13)\rfloor = 3 &
2 ^ {(3 + 1)} - 13 - 1 = 2 &
\lfloor(11 + 2) \div 2 \rfloor = 6 &
(11 + 2) \bmod 2  = 1 \\
\hline
2 & 2 &
10 & 23 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(23)\rfloor = 4 &
2 ^ {(4 + 1)} - 23 - 1 = 8 &
\lfloor(10 + 8) \div 2 \rfloor = 9 &
(10 + 8) \bmod 2  = 0 \\
3 & 2 &
12 & 12 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(12)\rfloor = 3 &
2 ^ {(3 + 1)} - 12 - 1 = 3 &
\lfloor(12 + 3) \div 2 \rfloor = 7 &
(12 + 3) \bmod 2  = 1 \\
\hline
4 & 1 &
8 & 14 &
(1 \times 2) - 1 = 1 &
\lfloor\log_2(14)\rfloor = 3 &
2 ^ {(3 + 1)} - 14 - 1 = 1 &
\lfloor(8 + 1) \div 2 \rfloor = 4 &
(8 + 1) \bmod 2  = 1 \\
5 & 3 &
2 & 11 &
(3 - 1) \times 2 = 4 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {(3 + 1)} - 11 - 1 = 4 &
2 & \\
\hline
6 & 0 &
1 & 8 &
\textit{undefined} &
\lfloor\log_2(8)\rfloor = 3 &
2 ^ {(3 + 1)} - 8 - 1 = 7 &
1 & \\
7 & 2 &
13 & 13 &
(2 \times 2) + 1 = 5 &
\lfloor\log_2(13)\rfloor = 3 &
2 ^ {(3 + 1)} - 13 - 1 = 2 &
\lfloor(13 + 2) \div 2 \rfloor = 7 &
(13 + 2) \bmod 2  = 1 \\
\hline
8 & 1 &
11 & 14 &
(1 \times 2) - 1 = 1 &
\lfloor\log_2(14)\rfloor = 3 &
2 ^ {(3 + 1)} - 14 - 1 = 1 &
\lfloor(11 + 1) \div 2 \rfloor = 6 &
(11 + 1) \bmod 2  = 0 \\
9 & 2 &
9 & 12 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(12)\rfloor = 3 &
2 ^ {(3 + 1)} - 12 - 1 = 3 &
\lfloor(9 + 3) \div 2 \rfloor = 6 &
(9 + 3) \bmod 2  = 0 \\
\hline
10 & 2 &
11 & 22 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(22)\rfloor = 4 &
2 ^ {(4 + 1)} - 22 - 1 = 9 &
\lfloor(11 + 9) \div 2 \rfloor = 10 &
(11 + 9) \bmod 2  = 0 \\
11 & 2 &
4 & 11 &
(2 \times 2) - 1 = 3 &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {(3 + 1)} - 11 - 1 = 4 &
\lfloor(4 + 4) \div 2 \rfloor = 4 &
(4 + 4) \bmod 2  = 0 \\
\hline
12 & 3 &
4 & 20 &
(3 \times 2) - 1 = 5 &
\lfloor\log_2(20)\rfloor = 4 &
2 ^ {(4 + 1)} - 20 - 1 = 11 &
4 & \\
13 & 1 &
14 & 18 &
(1 \times 2) - 1 = 1 &
\lfloor\log_2(18)\rfloor = 4 &
2 ^ {(4 + 1)} - 18 - 1 = 13 &
\lfloor(14 + 13) \div 2 \rfloor = 13 &
(14 + 13) \bmod 2  = 1 \\
\hline
14 & 3 &
9 & 24 &
(3 \times 2) - 1 = 5 &
\lfloor\log_2(24)\rfloor = 4 &
2 ^ {(4 + 1)} - 24 - 1 = 7 &
\lfloor(9 + 7) \div 2 \rfloor = 8 &
(9 + 7) \bmod 2  = 0 \\
15 & 1 &
6 & 17 &
(1 \times 2) - 1 = 1 &
\lfloor\log_2(17)\rfloor = 4 &
2 ^ {(4 + 1)} - 17 - 1 = 14 &
6 & \\
\hline
16 & 3 &
10 & 28 &
(3 - 1) \times 2 = 4 &
\lfloor\log_2(28)\rfloor = 4 &
2 ^ {(4 + 1)} - 28 - 1 = 3 &
\lfloor(9 + 3) \div 2 \rfloor = 6 &
(9 + 3) \bmod 2  = 0 \\
17 & 0 &
10 & 11 &
\textit{undefined} &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {(3 + 1)} - 11 - 1 = 4 &
\lfloor(10 + 4) \div 2 \rfloor = 7 &
(10 + 4) \bmod 2  = 0 \\
\hline
18 & 3 &
6 & 32 &
3 \times 2 = 6 &
\lfloor\log_2(32)\rfloor = 5 &
2 ^ {(5 + 1)} - 32 - 1 = 31 &
6 & \\
19 & 0 &
0 & 11 &
\textit{undefined} &
\lfloor\log_2(11)\rfloor = 3 &
2 ^ {(3 + 1)} - 11 - 1 = 4 &
0 & \\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}

\end{landscape}

\subsubsection{2nd Residual Encoding Example}
{\relsize{-2}
\renewcommand{\arraystretch}{1.75}
\begin{tabular}{|r|r|>{$}r<{$}>{$}r<{$}>{$}r<{$}||>{$}r<{$}|>{$}r<{$}>{$}r<{$}>{$}r<{$}>{$}r<{$}>{$}r<{$}|l}
  $i$ & $r_i$ & \text{entropy}_{0~0} & \text{entropy}_{0~1} & \text{entropy}_{0~2}  & u_i & \text{zeroes}_i & m_i & \text{offset}_i & \text{add}_i & \text{sign}_i \\
\cline{0-10}
-2 & & & & & \textit{und.} & & & & & \\
-1 & & {\color{red}0} & 0 & 0 & {\color{red}\textit{und.}} & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
0 & 1 & 0 & 0 & 0 & 3 & {\color{blue}0} & 1 & 0 & 0 & 0 \\
1 & 2 & 5 & 0 & 0 & 3 & \textit{und.} & 2 & 0 & 0 & 0 \\
2 & 3 & 10 & 5 & 0 & 5 & \textit{und.} & 3 & 0 & 0 & 0 \\
3 & 2 & 15 & 10 & 5 & 2 & \textit{und.} & 2 & 0 & 0 & 0 \\
4 & 1 & 20 & 15 & 3 & \textit{und.} & \textit{und.} & 0 & 1 & 1 & 0 \\
5 & 0 & 18 & 15 & 3 & 0 & \textit{und.} & 0 & 0 & 1 & 0 \\
6 & 0 & 16 & 15 & 3 & \textit{und.} & \textit{und.} & 0 & 0 & 1 & 0 \\
7 & 0 & 14 & 15 & 3 & 0 & \textit{und.} & 0 & 0 & 0 & 0 \\
8 & 0 & 12 & 15 & 3 & \textit{und.} & \textit{und.} & 0 & 0 & 0 & 0 \\
9 & 0 & 10 & 15 & 3 & 0 & \textit{und.} & 0 & 0 & 0 & 0 \\
10 & 0 & 8 & 15 & 3 & \textit{und.} & \textit{und.} & 0 & 0 & 0 & 0 \\
11 & 0 & 6 & 15 & 3 & 0 & \textit{und.} & 0 & 0 & 0 & 0 \\
12 & 0 & 4 & 15 & 3 & \textit{und.} & \textit{und.} & 0 & 0 & 0 & 0 \\
13 & 0 & 2 & 15 & 3 & 0 & \textit{und.} & 0 & 0 & 0 & 0 \\
14 & 0 & {\color{red}0} & 15 & 3 & {\color{red}\textit{und.}} & \textit{und.} & 0 & 0 & 0 & 0 \\
\cline{0-10}
15 & 0 & 0 & 15 & 3 & \textit{und.} & 1 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} & \multirow{10}{1em}{\begin{sideways}block of 10 zero residuals\end{sideways}} \\
16 & 0 & 0 & 0 & 0 & \textit{und.} & 2 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
17 & 0 & 0 & 0 & 0 & \textit{und.} & 3 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
18 & 0 & 0 & 0 & 0 & \textit{und.} & 4 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
19 & 0 & 0 & 0 & 0 & \textit{und.} & 5 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
20 & 0 & 0 & 0 & 0 & \textit{und.} & 6 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
21 & 0 & 0 & 0 & 0 & \textit{und.} & 7 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
22 & 0 & 0 & 0 & 0 & \textit{und.} & 8 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
23 & 0 & 0 & 0 & 0 & \textit{und.} & 9 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
24 & 0 & 0 & 0 & 0 & \textit{und.} & 10 & \textit{und.} & \textit{und.} & \textit{und.} & \textit{und.} \\
\cline{0-10}
25 & -1 & 0 & 0 & 0 & 1 & {\color{blue}10} & 0 & 0 & 0 & 1 \\
26 & -2 & 0 & 0 & 0 & 1 & \textit{und.} & 1 & 0 & 0 & 1 \\
27 & -3 & 5 & 0 & 0 & 3 & \textit{und.} & 2 & 0 & 0 & 1 \\
28 & -2 & 10 & 5 & 0 & 0 & \textit{und.} & 1 & 0 & 0 & 1 \\
29 & -1 & 15 & 3 & 0 & \textit{und.} & \textit{und.} & 0 & 0 & 0 & 1 \\
\cline{0-10}
\end{tabular}
}

\clearpage

This example is more simplified to demonstrate how the \VAR{zeroes}
value propagates in two instances.

For $r_0$, because $\text{entropy}_{0~0} = 0$ and
$u_{(-1)} = \textit{undefined}$\footnote{as determined by the \texttt{unary\_undefined} function},
we must handle a block of zeroes in some way.
But because $r_0 \neq 0$, we prepend a ``false alarm'' block of zeroes
and encode the residual normally.

For $r_{15}$, because $\text{entropy}_{0~0} = 0$,
$u_{14} = \textit{undefined}$ and $r_{15} = 0$,
we flush $\text{residual}_{14}$'s values and begin a block of zeroes
which continues until $r_{25} \neq 0$.
This block of zeroes is prepended to $\text{residual}_{25}$'s
values, which are flushed once $\text{residual}_{26}$ is encoded
and $u_{25}$ can be calculated from $u_{24}$ and $m_{26}$.

\begin{figure}[h]
  \includegraphics{figures/wavpack/residuals_parse2.pdf}
  \caption{2nd residual encoding example}
\end{figure}

\begin{figure}[h]
  \includegraphics{figures/wavpack/residuals.pdf}
\end{figure}

\clearpage

\subsection{Writing RIFF WAVE Header and Footer}
\label{wavpack:write_wave_header}
\begin{figure}[h]
  \includegraphics{figures/wavpack/pcm_sandwich.pdf}
\end{figure}


\subsection{Writing MD5 Sum}
\label{wavpack:write_md5}
MD5 sum is calculated as if the PCM data had been read from
a wave file's \texttt{data} chunk.
That is, the samples are converted to little-endian format
and are signed if the stream's bits-per-sample is greater than 8.
\begin{figure}[h]
  \includegraphics{figures/wavpack/md5sum.pdf}
\end{figure}

\subsection{Writing Extended Integers}
\label{wavpack:write_extended_integers}
\begin{figure}[h]
  \includegraphics{figures/wavpack/extended_integers.pdf}
\end{figure}

\clearpage

\subsection{Writing Channel Info}
\label{wavpack:write_channel_info}
\begin{figure}[h]
  \includegraphics{figures/wavpack/channel_info.pdf}
\end{figure}


\subsection{Writing Sample Rate}
\label{wavpack:write_sample_rate}
\begin{figure}[h]
  \includegraphics{figures/wavpack/sample_rate.pdf}
\end{figure}

\clearpage

\subsection{Writing Sub Block}
{\relsize{-1}
\ALGORITHM{metadata function, nondecoder data flag, sub block data}{sub block header data}
\SetKwData{DATA}{sub block data}
\SetKwFunction{LEN}{len}
$\text{metadata function} \rightarrow$ \WRITE 5 unsigned bits\;
$\text{nondecoder data} \rightarrow$ \WRITE 1 unsigned bit\;
$\LEN(\text{\DATA}) \bmod 2 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{actual size 1 less}
\eIf(\tcc*[f]{large block}){$\LEN(\text{\DATA}) > 255 \times 2$}{
  $1 \rightarrow$ \WRITE 1 unsigned bit\;
  $\lceil\LEN(\text{\DATA}) \div 2\rceil \rightarrow$ \WRITE 24 unsigned bits\;
}{
  $0 \rightarrow$ \WRITE 1 unsigned bit\;
  $\lceil\LEN(\text{\DATA}) \div 2\rceil \rightarrow$ \WRITE 8 unsigned bits\;
}
write \DATA\;
\If{$\LEN(\text{\DATA}) \bmod 2 = 1$}{
  $0 \rightarrow$ \WRITE 8 unsigned bits\;
}
\EALGORITHM
}

\begin{figure}[h]
\includegraphics{figures/wavpack/block_header2.pdf}
\end{figure}

\clearpage

\subsection{Writing Block Header}
\label{wavpack:write_block_header}
{\relsize{-1}
\ALGORITHM{total sub blocks size, block index, block samples, bits per sample, channel count, joint stereo, correlation pass count, wasted BPS, initial block, final block, maximum magnitude, sample rate, false stereo, CRC}{block header data}
\SetKwData{SUBBLOCKSSIZE}{sub blocks size}
\SetKwData{BLOCKINDEX}{block index}
\SetKwData{BLOCKSAMPLES}{block samples}
\SetKwData{BITSPERSAMPLE}{bits per sample}
\SetKwData{CHANNELCOUNT}{channel count}
\SetKwData{PASSES}{correlation passes}
\SetKwData{WASTEDBPS}{wasted BPS}
\SetKwData{JOINTSTEREO}{joint stereo}
\SetKwData{INITIALBLOCK}{initial block}
\SetKwData{FINALBLOCK}{final block}
\SetKwData{MAXMAGNITUDE}{maximum magnitude}
\SetKwData{FALSESTEREO}{false stereo}
$\texttt{"wvpk"} \rightarrow$ \WRITE 4 bytes\;
$\SUBBLOCKSSIZE + 24 \rightarrow$ \WRITE 32 unsigned bits\;
$\texttt{0x0410} \rightarrow$ \WRITE 16 unsigned bits\tcc*[r]{version}
$0 \rightarrow$ \WRITE 8 unsigned bits\tcc*[r]{track number}
$0 \rightarrow$ \WRITE 8 unsigned bits\tcc*[r]{index number}
$\texttt{0xFFFFFFFF} \rightarrow$ \WRITE 32 unsigned bits\tcc*[r]{total samples placeholder}
$\BLOCKINDEX \rightarrow$ \WRITE 32 unsigned bits\;
$\BLOCKSAMPLES \rightarrow$ \WRITE 32 unsigned bits\;
$\text{\BITSPERSAMPLE} \div 8 - 1 \rightarrow$ \WRITE 2 unsigned bits\;
$2 - \text{\CHANNELCOUNT} \rightarrow$ \WRITE 1 unsigned bit\;
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{hybrid mode}
\eIf(\tcc*[f]{joint stereo}){$\text{\CHANNELCOUNT} = 2$}{
  $1 \rightarrow$ \WRITE 1 unsigned bit
}{
  $0 \rightarrow$ \WRITE 1 unsigned bit
}
\eIf(\tcc*[f]{cross channel decorrelation}){$\text{\PASSES} > 5$}{
  $1 \rightarrow$ \WRITE 1 unsigned bit\;
}{
  $0 \rightarrow$ \WRITE 1 unsigned bit\;
}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{hybrid noise shaping}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{floating point data}
\eIf(\tcc*[f]{extended size integers}){$\WASTEDBPS > 0$}{
  $1 \rightarrow$ \WRITE 1 unsigned bit\;
}{
  $0 \rightarrow$ \WRITE 1 unsigned bit\;
}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{hybrid controls bitrate}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{hybrid noise balanced}
$\INITIALBLOCK \rightarrow$ \WRITE 1 unsigned bit\;
$\FINALBLOCK \rightarrow$ \WRITE 1 unsigned bit\;
$0 \rightarrow$ \WRITE 5 unsigned bits\tcc*[r]{left shift data}
$\MAXMAGNITUDE \rightarrow$ \WRITE 5 unsigned bits\;
$\textit{encoded sample rate} \rightarrow$ \WRITE 4 unsigned bits\;
\begin{tabular}{rr|rr|rr}
  sample rate & \textit{encoded} &
  sample rate & \textit{encoded} &
  sample rate & \textit{encoded} \\
  \hline
  6000 Hz & \texttt{0} &
  22050 Hz & \texttt{6} &
  64000 Hz & \texttt{11} \\
  8000 Hz & \texttt{1} &
  24000 Hz & \texttt{7} &
  88200 Hz & \texttt{12} \\
  9600 Hz & \texttt{2} &
  32000 Hz & \texttt{8} &
  96000 Hz & \texttt{13} \\
  11025 Hz & \texttt{3} &
  44100 Hz & \texttt{9} &
  192000 Hz & \texttt{14} \\
  12000 Hz & \texttt{4} &
  48000 Hz & \texttt{10} &
  otherwise & \texttt{15} \\
  16000 Hz & \texttt{5} \\
\end{tabular} \\
$0 \rightarrow$ \WRITE 2 unsigned bits\tcc*[r]{reserved}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{use IIR}
$\FALSESTEREO \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{if $\text{channel}_0 = \text{channel}_1$}
$0 \rightarrow$ \WRITE 1 unsigned bit\tcc*[r]{reserved}
$CRC \rightarrow$ \WRITE 32 unsigned bits\;
\EALGORITHM
}
