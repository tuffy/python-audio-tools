%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{DVD-Audio}
DVD-Audio is a format for delivering hi-fidelity, multichannel
audio on DVD media.
A DVD-Audio's \texttt{AUDIO\_TS} directory contains the
relevent data needed for decoding, spread into a lot of files
whose names are more than a little cryptic at first glance.

Unlike CD audio, which is simply a set of 1 to 99 identically-formatted
audio tracks (in terms of channel count, sample rate and bits per sample),
a DVD-Audio disc contains one or more titlesets.
Each titleset contains one or more titles, and each
title contains one or more tracks.
\begin{figure}[h]
  \includegraphics{figures/dvda/layout.pdf}
\end{figure}
\par
\noindent
Typically, a DVD-Audio disc will contain two titlesets,
one for audio and the other for video - which we can ignore.
The first titleset will often contain two titles,
one for 2 channel audio and the other for 5.1 channel audio.
Each title will usually contain a consistent number of tracks
as MLP or PCM encoded audio.
\par
With this in mind, we can now make some sense of
the \texttt{AUDIO\_TS} directory's contents:
\vskip .25in
$\texttt{\huge{AUDIO\_TS.IFO}}$
\hfill
information about the disc, including the number of titlesets
\vskip .25in
$\texttt{\huge{ATS\_}}\underbrace{\texttt{\huge{01}}}_{Titleset}\texttt{\huge{\_0.IFO}}$
\hfill
information about all the titles in a given titleset
\vskip .25in
$\texttt{\huge{ATS\_}}\underbrace{\texttt{\huge{01}}}_{Titleset}\texttt{\huge{\_}}\underbrace{\texttt{\huge{1}}}_{AOB~\#}\texttt{\huge{.AOB}}$
\hfill
audio data for one or more tracks in a given titleset
\vskip .25in
\par
All are binary files containing one or more, 2048 byte sectors.

\section{AUDIO\_TS.IFO}
Known as the ``Audio Manager'' or ``AMG'',
this is primarily a container of pointers to
other files on disc.
However, for our purposes, we're only interested
in the \VAR{Audio Titleset Count} value.
\begin{figure}[h]
  \includegraphics{figures/dvda/audio_ts_ifo.pdf}
\end{figure}

\clearpage

\section{ATS\_XX\_0.IFO}

\ALGORITHM{an \texttt{ATS\_XX\_0.IFO} file, a titleset number}{timestamps for each track in each title in the titleset, a list of sector pointers}
\SetKw{SEEK}{seek}
\SetKwData{IDENTIFIER}{identifier}
\SetKwData{TITLECOUNT}{title count}
\SetKwData{LASTADDRESS}{last byte address}
\SetKwData{TITLENUMBER}{title number}
\SetKwData{TITLEOFFSET}{title table offset}
\SetKwData{TRACKCOUNT}{track count}
\SetKwData{INDEXCOUNT}{index count}
\SetKwData{TITLELENGTH}{title PTS length}
\SetKwData{POINTERSOFFSET}{sector pointers offset}
\SetKwData{TRACKINDEX}{track index number}
\SetKwData{TRACKPTSINDEX}{track PTS index}
\SetKwData{TRACKPTSLENGTH}{track PTS length}
\SetKwData{INDEXID}{index ID}
\SetKwData{FIRSTSECTOR}{first sector}
\SetKwData{LASTSECTOR}{last sector}
$\IDENTIFIER \leftarrow$ \READ 12 bytes\;
\ASSERT $\IDENTIFIER = \texttt{"DVDAUDIO-ATS"}$\;
\SEEK to file position \texttt{0x800}\tcc*[r]{seek to the second sector in the file}
$\TITLECOUNT \leftarrow$ \READ 16 unsigned bits\;
\SKIP 16 bits\;
$\LASTADDRESS \leftarrow$ \READ 32 unsigned bits\;
\For{i = 0 \emph{\KwTo}\TITLECOUNT}{
  $\text{\TITLENUMBER}_i \leftarrow$ \READ 8 unsigned bits\;
  \SKIP 24 bits\;
  $\text{\TITLEOFFSET}_i \leftarrow$ \READ 32 unsigned bits\;
}
\For(\tcc*[f]{read title information}){i = 0 \emph{\KwTo}\TITLECOUNT}{
  \SEEK to file position $(\texttt{0x800} + \text{\TITLEOFFSET}_i)$\;
  \SKIP 16 bits\;
  $\text{\TRACKCOUNT}_i \leftarrow$ \READ 8 unsigned bits\;
  $\text{\INDEXCOUNT}_i \leftarrow$ \READ 8 unsigned bits\;
  $\text{\TITLELENGTH}_i \leftarrow$ \READ 32 unsigned bits\;
  \SKIP 32 bits\;
  $\text{\POINTERSOFFSET}_i \leftarrow$ \READ 16 unsigned bits\;
  \SKIP 16 bits\;
  \For(\tcc*[f]{read track information}){j = 0 \emph{\KwTo}$\text{\TRACKCOUNT}_i$}{
    \SKIP 32 bits\;
    $\text{\TRACKINDEX}_{i~j} \leftarrow$ \READ 8 unsigned bits\;
    \SKIP 8 bits\;
    $\text{\TRACKPTSINDEX}_{i~j} \leftarrow$ \READ 32 unsigned bits\;
    $\text{\TRACKPTSLENGTH}_{i~j} \leftarrow$ \READ 32 unsigned bits\;
    \SKIP 48 bits\;
  }
  \SEEK to file position $(\texttt{0x800} + \text{\TITLEOFFSET}_i + \text{\POINTERSOFFSET}_i)$\;
  \For(\tcc*[f]{read index information}){j = 0 \emph{\KwTo}$\text{\INDEXCOUNT}_i$}{
    $\text{\INDEXID}_{i~j} \leftarrow$ \READ 32 unsigned bits\;
    \ASSERT $\text{\INDEXID}_{i~j} = \texttt{0x01000000}$\;
    $\text{\FIRSTSECTOR}_{i~j} \leftarrow$ \READ 32 unsigned bits\;
    $\text{\LASTSECTOR}_{i~j} \leftarrow$ \READ 32 unsigned bits\;
  }
}
\Return \TITLECOUNT, \TRACKCOUNT, \INDEXCOUNT, \TITLELENGTH, \TRACKINDEX,
\TRACKPTSINDEX, \TRACKPTSLENGTH, \FIRSTSECTOR, \LASTSECTOR\;
\EALGORITHM

\clearpage

\subsubsection{ATS\_XX\_0.IFO Second Sector}
\begin{figure}[h]
\includegraphics{figures/dvda/ats_xx_0.pdf}
\end{figure}

\subsubsection{Title Table}
\begin{figure}[h]
  \includegraphics{figures/dvda/ats_title.pdf}
\end{figure}

\subsubsection{Sector Pointers Table}
\begin{figure}[h]
  \includegraphics{figures/dvda/ats_sectors.pdf}
\end{figure}

\clearpage

\section{ATS\_XX\_X.AOB}

All of a titleset's AOB files can be considered part of a
single, contiguous collection of sectors, each 2048 bytes long.
Thus, it's possible for the start and end sectors for a given track
(as indicated in the sector pointers table) to span two or more
AOB files.
Each sector contains one or more packets as part of a
``Packetized Elementary Stream''.

\begin{figure}[h]
  \includegraphics{figures/dvda/ats_xx_x.pdf}
\end{figure}
\par
\noindent
Packets with a \VAR{stream ID} of \texttt{0xBD} contain encoded audio data.
\VAR{Packet data length} is the length of all data after
the \VAR{packet data length} field to the end of the packet.
\par
\noindent
Each sector within an AOB file is prefixed by a \VAR{Pack Header},
as follows:
\begin{figure}[h]
  \includegraphics{figures/dvda/aob_pack_header.pdf}
\end{figure}
\par
\noindent
The three \VAR{Current PTS} values (3 bits, 15 bits and 15 bits, respectively)
combine to indicate the current position within the stream, in PTS ticks.
There are 90,000 PTS ticks per second.

\clearpage

\subsection{Packet Payload Extraction}

\begin{figure}[h]
  \includegraphics{figures/dvda/audio_packet.pdf}
\end{figure}

\clearpage

\section{MLP Decoding}
{\relsize{-1}
\ALGORITHM{packet data containing 1 or more MLP frames}{1 or more PCM frames}
\SetKwData{TOTALSIZE}{total frame size}
\While{MLP frames remain}{
  \SKIP 4 bits\;
  $\TOTALSIZE \leftarrow (\text{\READ 12 unsigned bits}) \times 2$\;
  \SKIP 16 bits\;
  decode next $(\TOTALSIZE - 4)$ bytes as MLP frame\;
}
\Return PCM frames\;
\EALGORITHM
}

\begin{figure}[h]
  \includegraphics{figures/dvda/mlp_stream.pdf}
\end{figure}

\clearpage

\subsection{MLP Frame Decoding}
{\relsize{-1}
\ALGORITHM{MLP frame}{1 or more PCM frames}
\SetKw{AND}{and}
\SetKw{OR}{or}
\SetKw{REWIND}{rewind stream}
\SetKwData{SYNCWORDS}{sync words}
\SetKwData{STREAMTYPE}{stream type}
\SetKwData{BPS}{bits per sample}
\SetKwFunction{BPSFUNC}{bps}
\SetKwData{RATE}{sample rate}
\SetKwFunction{RATEFUNC}{rate}
\SetKwData{CHANNELCOUNT}{channel count}
\SetKwData{CHANNELASSIGNMENT}{channel assignment}
\SetKwFunction{CHANNELFUNC}{channels}
\SetKwData{SUBSTREAMCOUNT}{substream count}
\SetKwData{EXTRAWORD}{extra word present}
\SetKwData{NONRESTART}{nonrestart substream}
\SetKwData{CHECKDATA}{checkdata present}
\SetKwData{SUBSTREAMEND}{substream end}
\SetKwData{SUBSTREAM}{substream}
\SetKwData{PARITY}{parity}
\SetKwData{CRC}{CRC-8}
$\SYNCWORDS \leftarrow$ \READ 24 unsigned bits\;
$\STREAMTYPE \leftarrow$ \READ 8 unsigned bits\;
\eIf(\tcc*[f]{major sync found}){$(\SYNCWORDS = 16282223)$ \AND $(\STREAMTYPE = 187)$}{
  $\text{\BPS}_0 \leftarrow \BPSFUNC(\text{\READ 4 unsigned bits})$\;
  $\text{\BPS}_1 \leftarrow \BPSFUNC(\text{\READ 4 unsigned bits})$\;
  $\text{\RATE}_0 \leftarrow \RATEFUNC(\text{\READ 4 unsigned bits})$\;
  $\text{\RATE}_1 \leftarrow \RATEFUNC(\text{\READ 4 unsigned bits})$\;
  \SKIP 11 bits\;
  $(\text{\CHANNELCOUNT}~,~\text{\CHANNELASSIGNMENT}) \leftarrow \CHANNELFUNC(\text{\READ 5 unsigned bits})$\;
  \SKIP 64 bits\;
  $\text{\SUBSTREAMCOUNT} \leftarrow$ \READ 4 unsigned bits\;
  \ASSERT $(\text{\SUBSTREAMCOUNT} = 1)$ \OR $(\text{\SUBSTREAMCOUNT} = 2)$\;
  \SKIP 92 bits\;
}(\tcc*[f]{major sync not found}){
  \REWIND 32 bits\;
}
\For{i = 0 \emph{\KwTo}\SUBSTREAMCOUNT}{
  $\text{\EXTRAWORD}_i \leftarrow$ \READ 1 unsigned bit\;
  \ASSERT $\text{\EXTRAWORD}_i = 0$\;
  $\text{\NONRESTART}_i \leftarrow$ \READ 1 unsigned bit\;
  $\text{\CHECKDATA}_i \leftarrow$ \READ 1 unsigned bit\;
  \SKIP 1 bit\;
  $\text{\SUBSTREAMEND}_i \leftarrow (\text{\READ 12 unsigned bits}) \times 2$\;
}
\For{i = 0 \emph{\KwTo}\SUBSTREAMCOUNT}{
  \eIf{$\text{\CHECKDATA}_i = 1$}{
    \eIf{$i = 0$}{
      decode next $(\text{\SUBSTREAMEND}_0 - 2)$ bytes as $\text{\SUBSTREAM}_0$\;
    }{
      decode next $(\text{\SUBSTREAMEND}_i - \text{\SUBSTREAMEND}_{i - 1} - 2)$ bytes as $\text{\SUBSTREAM}_i$\;
    }
    $\PARITY \leftarrow$ \READ 8 unsigned bits\;
    $\CRC \leftarrow$ \READ 8 unsigned bits\;
    verify \PARITY, \CRC of $\text{\SUBSTREAM}_i$\;
  }{
    \eIf{$i = 0$}{
      decode next $(\text{\SUBSTREAMEND}_0)$ bytes as $\text{\SUBSTREAM}_0$\;
    }{
      decode next $(\text{\SUBSTREAMEND}_i - \text{\SUBSTREAMEND}_{i - 1})$ bytes as $\text{\SUBSTREAM}_i$\;
    }

  }
}
\Return substream channels as PCM frames\;
\EALGORITHM
}

\clearpage

\begin{tiny}
  \begin{tabular}{|c|r|r|r|l|}
    \hline
    value & \texttt{bps} & \texttt{rate} & channels & channel assignment \\
    \hline
    \texttt{00000} & 16 & 48000 & 1 & front center \\
    \texttt{00001} & 20 & 96000 & 2 & front left, front right\\
    \texttt{00010} & 24 & 192000 & 3 & front left, front right, back center \\
    \texttt{00011} & & & 4 & front left, front right, back left, back right\\
    \texttt{00100} & & & 3 & front left, front right, LFE \\
    \texttt{00101} & & & 4 & front left, front right, LFE, back center \\
    \texttt{00110} & & & 5 & front left, front right, LFE, back left, back right \\
    \texttt{00111} & & & 3 & front left, front right, front center \\
    \texttt{01000} & & 44100 & 4 & front left, front right, front center, back center \\
    \texttt{01001} & & 88200 & 5 & front left, front right, front center, back left, back right \\
    \texttt{01010} & & 176400 & 4 & front left, front right, front center, LFE\\
    \texttt{01011} & & & 5 & front left, front right, front center, LFE, back center \\
    \texttt{01100} & & & 6 & front left, front right, front center, LFE back left, back right \\
    \texttt{01101} & & & 4 & front left, front right, front center, back center \\
    \texttt{01110} & & & 5 & front left, front right, front center, back left, back right \\
    \texttt{01111} & & & 4 & front left, front right, front center, LFE \\
    \texttt{10000} & & & 5 & front left, front right, front center, LFE, back center \\
    \texttt{10001} & & & 6 & front left, front right, front center, LFE, back left, back right \\
    \texttt{10010} & & & 5 & front left, front right, back left, back right, LFE \\
    \texttt{10011} & & & 5 & front left, front right, back left, back right, front center \\
    \texttt{10100} & & & 6 & front left, front right, back left, back right, front center, LFE \\
    \hline
  \end{tabular}
\end{tiny}
